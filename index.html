<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHEMZ Shop - Dashboard</title>

    <style>
        /* ===========================================
           RESET & BASE STYLES
        =========================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            color: #f1f5f9;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* ===========================================
           HEADER STYLES
        =========================================== */
        .header {
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(33, 38, 45, 0.8);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.4rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .page-title svg {
            width: 24px;
            height: 24px;
            fill: #3b82f6;
        }

        .notification-btn {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 0.5rem;
            color: #3b82f6;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-btn:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        /* ===========================================
           SIDEBAR STYLES (DESKTOP)
        =========================================== */
       .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: 280px;
    height: 100vh;
    background: rgba(13, 17, 23, 0.95);
    backdrop-filter: blur(10px);
    border-right: 1px solid rgba(33, 38, 45, 0.8);
    padding: 0;
    z-index: 100;
    display: none;
    flex-direction: column;
    overflow: hidden; /* ← TAMBAH INI */
}

        .sidebar-header {
    padding: 0.75rem 1.5rem; /* ← KURANGIN PADDING TOP/BOTTOM */
    border-bottom: 1px solid rgba(59, 130, 246, 0.2);
}

        .sidebar-logo {
    display: flex;
    align-items: center;
    gap: 0.5rem; /* ← KURANGIN GAP */
    font-size: 1.1rem; /* ← FONT LEBIH KECIL */
    font-weight: bold;
    color: #3b82f6;
}

        .sidebar-nav {
    flex: 1;
    padding: 0.5rem 0; /* ← KURANGIN PADDING */
    overflow: hidden; /* ← HILANGKAN SCROLL */
    display: flex;
    flex-direction: column;
    justify-content: space-between; /* ← DISTRIBUTE SPACE */
}

       .sidebar-item {
    display: flex;
    align-items: center;
    gap: 0.75rem; /* ← KURANGIN GAP */
    padding: 0.5rem 1.5rem; /* ← KURANGIN PADDING */
    color: #94a3b8;
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 0.9rem; /* ← FONT LEBIH KECIL */
}

        .sidebar-item:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #e2e8f0;
        }

        .sidebar-item.active {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border-right: 3px solid #3b82f6;
        }

        .sidebar-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

       .sidebar-footer {
    padding: 0.5rem 1.5rem; /* ← KURANGIN PADDING */
    border-top: 1px solid rgba(59, 130, 246, 0.2);
    color: #64748b;
    font-size: 0.8rem; /* ← FONT LEBIH KECIL */
}

        /* ===========================================
           MAIN CONTENT STYLES
        =========================================== */
        .main-content {
            padding: 1rem;
            min-height: calc(100vh - 140px);
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        /* ===========================================
           DASHBOARD CARDS
        =========================================== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.08);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        /* ===========================================
           CARD COMPONENTS
        =========================================== */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        /* ===========================================
           BUTTON STYLES
        =========================================== */
        .btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .btn-icon {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 0.5rem;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #3b82f6;
        }

        .btn-action {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }

        .btn-action.edit {
            color: #3b82f6;
            border-color: #3b82f6;
        }

        .btn-action.delete {
    color: #ef4444;
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
    font-weight: 600;
}

.btn-action.delete:hover {
    background: rgba(239, 68, 68, 0.2);
    color: #ffffff;
    border-color: #ef4444;
}

        /* ===========================================
           FORM STYLES
        =========================================== */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #e2e8f0;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            color: #f1f5f9;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(255, 255, 255, 0.08);
        }

        .form-select {
            width: 100%;
            background: #334155;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            color: #ffffff !important;
            font-size: 1rem;
        }

        /* ===========================================
           LIST COMPONENTS
        =========================================== */
        .list-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .list-item-title {
            font-weight: 600;
            color: #f1f5f9;
        }

        .list-item-meta {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        /* ===========================================
           STATUS BADGES
        =========================================== */
        .status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status.pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .status.shipped {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .status.delivered {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status.return {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* ===========================================
           COURIER BADGES (NEW)
        =========================================== */
        .courier-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Default untuk courier yang tidak dikenal */
        .courier-badge.unknown {
            background: #64748b;
        }

        /* ===========================================
           BOTTOM NAVIGATION (MOBILE)
        =========================================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(59, 130, 246, 0.2);
            padding: 0.75rem 0;
            z-index: 100;
        }

        .nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            text-decoration: none;
            color: #64748b;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 12px;
            cursor: pointer;
        }

        .nav-item.active {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .nav-icon {
            font-size: 1.5rem;
        }

        .nav-label {
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* ===========================================
           LOADING & EMPTY STATES
        =========================================== */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #94a3b8;
        }

        .empty-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            opacity: 0.5;
            fill: currentColor;
        }

        /* ===========================================
           TAB COMPONENTS
        =========================================== */
        .tabs-header {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 1rem;
        }

        .tab-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-weight: 500;
            text-align: center;
            min-height: 60px;
            font-size: 0.9rem;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: #ffffff;
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .tab-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
            flex-shrink: 0;
        }

        .tabs-content {
            min-height: 400px;
        }

        .tab-content {
            display: none !important;
        }

        .tab-content.active {
            display: block !important;
            animation: fadeIn 0.3s ease;
        }
        
        
        /* ===========================================
           RESI TAB CONTENT (NEW)
        =========================================== */
        .resi-tab-content {
            display: none !important;
        }

        .resi-tab-content.active {
            display: block !important;
            animation: fadeIn 0.3s ease;
        }

        /* ===========================================
           TABLE STYLES
        =========================================== */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.02);
        }

        .products-table th {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            text-align: left;
            color: #e2e8f0;
            font-weight: 600;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .products-table td {
            padding: 1rem;
            color: #f1f5f9;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* ===========================================
           RESPONSIVE CARDS FOR MOBILE TABLES
        =========================================== */
        .mobile-cards-container {
            display: none;
        }

        .mobile-order-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-card-left {
            flex: 1;
        }

        .mobile-card-order-id {
            font-weight: 700;
            color: #3b82f6;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .mobile-card-date {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .mobile-card-status {
            margin-left: 1rem;
        }

        .mobile-card-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }

        .mobile-card-info-row:last-child {
            margin-bottom: 0;
        }

        .mobile-card-label {
            font-size: 0.8rem;
            color: #94a3b8;
            font-weight: 500;
            min-width: 70px;
        }

        .mobile-card-value {
            font-size: 0.9rem;
            color: #f1f5f9;
            text-align: right;
            flex: 1;
            margin-left: 1rem;
        }

        .mobile-card-customer-section {
            background: rgba(255, 255, 255, 0.03);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .mobile-card-customer-name {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 0.25rem;
        }

        .mobile-card-customer-phone {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .mobile-card-product-section {
            margin-bottom: 0.75rem;
        }

        .mobile-card-product-name {
            font-weight: 500;
            color: #f1f5f9;
            margin-bottom: 0.25rem;
        }

        .mobile-card-product-sku {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .mobile-card-alamat {
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.2);
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.75rem 0;
            font-size: 0.85rem;
            color: #e2e8f0;
            line-height: 1.4;
        }

        .mobile-card-alamat-label {
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 0.25rem;
            display: block;
        }

        .mobile-card-actions {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
        }

        .mobile-card-complete {
            text-align: center;
            padding: 0.5rem;
            color: #22c55e;
            font-weight: 600;
        }

        /* ===========================================
           MOBILE STOCK CARDS
        =========================================== */
        .mobile-stock-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-stock-sku {
            font-weight: 700;
            color: #3b82f6;
            font-size: 0.9rem;
        }

        .mobile-stock-status {
            font-size: 0.8rem;
        }

        .mobile-stock-name {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 0.25rem;
        }

        .mobile-stock-unit {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 0.75rem;
        }

        .mobile-stock-numbers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .mobile-stock-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 0.5rem;
            border-radius: 6px;
            text-align: center;
        }

        .mobile-stock-item-label {
            font-size: 0.7rem;
            color: #94a3b8;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .mobile-stock-item-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .mobile-stock-current {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
        }

        .mobile-stock-current-label {
            font-size: 0.8rem;
            color: #3b82f6;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .mobile-stock-current-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #f1f5f9;
        }

        /* ===========================================
           SEARCH COMPONENTS
        =========================================== */
        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            color: #f1f5f9;
            font-size: 0.9rem;
        }

        .search-input::placeholder {
            color: #94a3b8;
        }

        /* ===========================================
           MODAL STYLES
        =========================================== */
        .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    z-index: 1000;
    /* HAPUS: animation: modalFadeIn 0.3s ease; */
}

       .modal-content {
    background: #2d3748;
    border-radius: 12px;
    margin: 2% auto;
    max-width: 1200px;       /* ← GANTI: 450px jadi 1200px */
    width: 95%;              /* ← GANTI: 90% jadi 95% */
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    /* HAPUS: animation: modalSlideIn 0.3s ease; */
}

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h3 {
            margin: 0;
            color: #ffffff;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .modal form {
            padding: 1.25rem;
        }

        .modal-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.25rem;
        }

        .modal-buttons .btn {
            flex: 1;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

       
        
        

        /* ===========================================
           TOAST NOTIFICATIONS
        =========================================== */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 400px;
            width: 100%;
        }

        .toast {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            border-left: 4px solid;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #f1f5f9;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success { border-left-color: #22c55e; }
        .toast.error { border-left-color: #ef4444; }
        .toast.warning { border-left-color: #f59e0b; }
        .toast.info { border-left-color: #3b82f6; }

        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            opacity: 0.9;
            font-size: 0.85rem;
        }

        .toast-close {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 1.2rem;
            line-height: 1;
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #f1f5f9;
        }

        /* ===========================================
           TIPS SECTION
        =========================================== */
        .tips-section {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #fbbf24;
            font-size: 0.9rem;
        }

        /* ===========================================
           INFO CONTAINER
        =========================================== */
        .info-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .last-update-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* ===========================================
           MOBILE/DESKTOP VISIBILITY
        =========================================== */
        .mobile-only {
            display: flex;
        }

        .desktop-only {
            display: none;
        }

        /* ===========================================
           RESPONSIVE DESIGN
        =========================================== */
        @media (min-width: 768px) {
            /* Desktop Layout */
            .sidebar {
                display: flex;
            }

            .header {
                margin-left: 280px;
                padding: 1.5rem 2rem;
            }

            .main-content {
                margin-left: 280px;
                max-width: calc(100% - 280px);
                padding: 2rem;
                min-height: calc(100vh - 140px);
            }

            .dashboard-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 1.5rem;
                margin-bottom: 2rem;
            }

            .stat-card {
                padding: 2rem 1.5rem;
            }

            .stat-value {
                font-size: 2.5rem;
            }

            .bottom-nav {
                display: none;
            }

            body {
                padding-bottom: 0;
            }

            .card {
                padding: 2rem;
                margin-bottom: 1.5rem;
            }

            .form-input, .form-select {
                padding: 1rem;
            }

            .btn {
                padding: 1rem 2rem;
            }

            .list-item {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }

            .form-group {
                margin-bottom: 1.5rem;
            }

            .card-header {
                margin-bottom: 1.5rem;
            }

            .card-title {
                font-size: 1.25rem;
            }

            .mobile-only {
                display: none;
            }
            
            .desktop-only {
                display: flex;
            }
        }

        @media (max-width: 767px) {
            .sidebar {
                display: none !important;
            }

            .tabs-header {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            
            .tab-btn {
                padding: 0.75rem;
                min-height: 50px;
                font-size: 0.8rem;
                gap: 0.5rem;
            }
            
            .tab-btn svg {
                width: 16px;
                height: 16px;
            }
        }

        @media (max-width: 640px) {
            .toast-container {
                top: 0.5rem;
                right: 0.5rem;
                left: 0.5rem;
                max-width: none;
            }
            
            .toast {
                padding: 0.8rem 1rem;
                font-size: 0.85rem;
            }

            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
                max-height: calc(100vh - 2rem);
            }
            
            .modal-header,
            .modal form {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .tabs-header {
                grid-template-columns: 1fr;
            }
            
            .tab-btn {
                justify-content: flex-start;
                padding-left: 1.5rem;
            }
        }

        /* ===========================================
           ORDER TABS SPECIFIC
        =========================================== */
        .order-tabs {
            grid-template-columns: repeat(3, 1fr) !important;
        }

        .message-tabs {
            grid-template-columns: repeat(3, 1fr) !important;
        }

        /* ===========================================
           MESSAGE STATUS STYLES
        =========================================== */
        .message-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .message-status.sent {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .message-status.pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .message-status.failed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* ===========================================
           CONNECTION STATUS STYLES
        =========================================== */
        .connection-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .connection-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .connection-testing {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }
        
/* MOBILE RESPONSIVE - Stack Vertikal */
@media (max-width: 767px) {
    /* Filter container jadi vertikal stack */
    .filter-controls,
    div[style*="grid-template-columns: 1fr auto auto auto"] {
        display: flex !important;
        flex-direction: column !important;
        gap: 0.75rem !important;
        align-items: stretch !important;
    }
    
    /* Semua child elements full width */
    .filter-controls > *,
    div[style*="grid-template-columns: 1fr auto auto auto"] > * {
        width: 100% !important;
        margin-bottom: 0 !important;
    }
    
    /* Buttons styling */
    .filter-controls .btn,
    .filter-controls .btn-icon {
        padding: 0.75rem 1rem !important;
        border-radius: 8px !important;
        font-size: 0.9rem !important;
    }
}

@media (max-width: 767px) {
    /* Hide last update info */
    .last-update-info {
        display: none !important;
    }
    
    /* Hide info container yang ada last update */
    .info-container {
        display: none !important;
    }
}

@media (max-width: 767px) {
    /* Title section alignment */
    #laporan-stock h3,
    .page h3 {
        margin-bottom: 1rem !important;
        text-align: left !important;
    }
    
    /* Remove justify-between di mobile */
    #laporan-stock > div:first-child {
        display: block !important;
    }
}

/* ===========================================
   MONITOR TAB STYLES (NEW) - COMPACT VERSION
=========================================== */
.monitor-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.monitor-stat-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 1rem;
    border-left: 4px solid;
    transition: all 0.3s ease;
    text-align: center;
}

.monitor-stat-card:hover {
    transform: translateY(-2px);
    background: rgba(255, 255, 255, 0.08);
}

.monitor-stat-card.pending {
    border-left-color: #f59e0b;
}

.monitor-stat-card.shipped {
    border-left-color: #3b82f6;
}

.monitor-stat-card.delivered {
    border-left-color: #22c55e;
}

.monitor-stat-card.return {
    border-left-color: #ef4444;
}

.monitor-stat-value {
    font-size: 1.8rem;
    font-weight: 800;
    color: #f1f5f9;
    margin-bottom: 0.25rem;
}

.monitor-stat-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: #f1f5f9;
    margin-bottom: 0.125rem;
}

.monitor-stat-sublabel {
    font-size: 0.7rem;
    color: #94a3b8;
}

/* Control Panel */
.monitor-control-panel {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.monitor-control-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.monitor-control-title {
    font-size: 1rem;
    font-weight: 600;
    color: #f1f5f9;
}

.monitor-control-actions {
    display: flex;
    gap: 0.75rem;
}

.monitor-control-actions .btn {
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
    border-radius: 8px;
}

.monitor-status-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
}

.monitor-info-item {
    background: rgba(255, 255, 255, 0.03);
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.monitor-info-label {
    font-size: 0.75rem;
    color: #94a3b8;
    margin-bottom: 0.25rem;
    font-weight: 500;
}

.monitor-info-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: #f1f5f9;
}

/* Activity Section */
.monitor-activity-section {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 1.25rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.monitor-activity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.monitor-activity-title {
    font-size: 1rem;
    font-weight: 600;
    color: #f1f5f9;
}

.monitor-activity-table {
    width: 100%;
    border-collapse: collapse;
}

.monitor-activity-table th {
    background: rgba(255, 255, 255, 0.05);
    padding: 0.6rem 0.8rem;
    text-align: left;
    color: #94a3b8;
    font-weight: 600;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.monitor-activity-table td {
    padding: 0.6rem 0.8rem;
    color: #f1f5f9;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    font-size: 0.85rem;
}

/* Top Expeditions */
.monitor-top-expeditions {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 1.25rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.monitor-expedition-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.6rem;
    margin-bottom: 0.5rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.monitor-expedition-item:last-child {
    margin-bottom: 0;
}

.monitor-expedition-name {
    font-weight: 600;
    color: #f1f5f9;
    font-size: 0.85rem;
}

.monitor-expedition-count {
    font-weight: 700;
    color: #3b82f6;
    font-size: 0.8rem;
}




    </style>
</head>

<body>
    <!-- ===========================================
         DESKTOP SIDEBAR
    =========================================== -->
    <aside class="sidebar">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <div class="sidebar-logo">
                🚀 <span>CHEMZ SHOP</span>
            </div>
        </div>
        
        <!-- Sidebar Navigation -->
        <nav class="sidebar-nav">
    <!-- Main Menu Items -->
    <button class="sidebar-item active" onclick="showPage('dashboard-page', this)">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
        </svg>
        <span>Dashboard</span>
    </button>
    
    <button class="sidebar-item" onclick="showPage('orders-page', this)">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 5H7c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2h-2v1c0 .6-.4 1-1 1H10c-.6 0-1-.4-1-1V5zm1-2h4c.6 0 1 .4 1 1v1H9V4c0-.6.4-1 1-1zM7 10h2v2H7v-2zm4 0h6v2h-6v-2zm-4 4h2v2H7v-2zm4 0h6v2h-6v-2z"/>
        </svg>
        <span>Order Management</span>
    </button>
    
    <button class="sidebar-item" onclick="showPage('customers-page', this)">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
        <span>Customer Management</span>
    </button>
    
    <button class="sidebar-item" onclick="showPage('products-page', this)">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 7h-3V6a4 4 0 0 0-4-4h-2a4 4 0 0 0-4 4v1H4a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM9 6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1H9V6zm6 4a1 1 0 0 1-2 0v-1a1 1 0 0 1 2 0v1zm-4 0a1 1 0 0 1-2 0v-1a1 1 0 0 1 2 0v1z"/>
        </svg>
        <span>Inventory</span>
    </button>
    
    <!-- Messages Menu -->
    <button class="sidebar-item" onclick="showPage('messages-page', this)">
        <span class="sidebar-icon">💬</span>
        <span>Message Queue</span>
    </button>
    
    <!-- Additional Tools Section -->
    <div style="margin: 1rem 0; border-top: 1px solid rgba(59, 130, 246, 0.2); padding-top: 1rem;">
        <button class="sidebar-item" onclick="showTrackingIntegration()">
            <span class="sidebar-icon">📱</span>
            <span>Tracking Integration</span>
        </button>
    </div>
    
    <button class="sidebar-item" onclick="showPage('resi-management-page', this)">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 11H7v3h2v-3zm4 0h-2v3h2v-3zm4 0h-2v3h2v-3zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
        </svg>
        <span>Resi Management</span>
    </button>
    
    <!-- Settings di bawah -->
    <div style="margin-top: 1rem; border-top: 1px solid rgba(59, 130, 246, 0.2); padding-top: 1rem;">
        <button class="sidebar-item" onclick="showSettings()">
            <span class="sidebar-icon">⚙️</span>
            <span>Settings</span>
        </button>
    </div>
</nav>
        
        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <div>CHEMZ Shop v1.0</div>
            <div>API Status: <span style="color: #22c55e;">●</span> Connected</div>
        </div>
    </aside>

    <!-- ===========================================
         MAIN HEADER
    =========================================== -->
    <header class="header">
        <div class="header-content">
            <!-- Mobile header -->
            <div class="logo mobile-only">
                🚀 <span>CHEMZ SHOP</span>
            </div>
            
            <!-- Desktop header - dynamic -->
            <div class="page-title desktop-only" id="page-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                </svg>
                <span>Dashboard</span>
            </div>
            
            <button class="notification-btn" onclick="showNotifications()">
                🔔
            </button>
        </div>
    </header>

    <!-- ===========================================
         MAIN CONTENT
    =========================================== -->
    <main class="main-content">
        <!-- ===========================================
             DASHBOARD PAGE
        =========================================== -->
        <div id="dashboard-page" class="page active">
            <!-- Stats Grid -->
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-value" id="orders-today">0</div>
                    <div class="stat-label">Orders Hari Ini</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="profit-today">Rp 0</div>
                    <div class="stat-label">Profit Hari Ini</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-customers">0</div>
                    <div class="stat-label">Total Customer</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-products">0</div>
                    <div class="stat-label">Total Produk</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Quick Actions</h3>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button class="btn" onclick="showPage('orders-page')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 4V2c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v2h4c1.1 0 2 .9 2 2v14c0 1.1-.9 2-2 2H3c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h4zM9 4h6V2H9v2zm8 4H7v2h10V8z"/>
                        </svg>
                        Buat Order
                    </button>
                    <button class="btn btn-secondary" onclick="showPage('customers-page')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A3.98 3.98 0 0 0 16.06 6H15c-.8 0-1.54.37-2.01.99L10.99 9H6c-1.1 0-2 .9-2 2v3h2v8h8v-8h2v8h4z"/>
                        </svg>
                        Customer
                    </button>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Recent Orders</h3>
                    <button class="btn btn-small" onclick="loadRecentOrders()">Refresh</button>
                </div>
                <div id="recent-orders">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading recent orders...
                    </div>
                </div>
            </div>
        </div>

        <!-- ===========================================
     ORDERS PAGE - FIXED & COMPACT
=========================================== -->
<div id="orders-page" class="page">
    <!-- Tabs Header - COMPACT VERSION -->
    <div class="tabs-header order-tabs" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 0.75rem;">
        <button class="tab-btn active" onclick="switchOrderTab('input-order', this)" style="padding: 0.75rem 1.25rem; min-height: 50px; font-size: 0.9rem; gap: 0.5rem; border-radius: 10px;">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            <span>Input Order</span>
        </button>
        
        <button class="tab-btn" onclick="switchOrderTab('history-orders', this)" style="padding: 0.75rem 1.25rem; min-height: 50px; font-size: 0.9rem; gap: 0.5rem; border-radius: 10px;">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
            </svg>
            <span>History Orders</span>
        </button>
        
        <button class="tab-btn" onclick="switchOrderTab('sales-report', this)" style="padding: 0.75rem 1.25rem; min-height: 50px; font-size: 0.9rem; gap: 0.5rem; border-radius: 10px;">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
            </svg>
            <span>Sales Report</span>
        </button>
    </div>

    <!-- Tabs Content Container -->
    <div class="tabs-content">
        <!-- Input Order Tab -->
        <div id="input-order" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        Buat Order Baru
                    </h3>
                </div>
                
                <form id="order-form" name="order-form">
                    <!-- Customer Section -->
                    <div class="form-group">
                        <label class="form-label">Customer</label>
                        <select class="form-select" id="customer-select" required>
                            <option value="">Pilih Customer...</option>
                        </select>
                        <button type="button" class="btn btn-small" style="margin-top: 0.5rem;" onclick="showAddCustomerModal()">
                            + Tambah Customer Baru
                        </button>
                    </div>

                    <!-- Product Section -->
                    <div class="form-group">
                        <label class="form-label">Produk</label>
                        <select class="form-select" id="product-select" required>
                            <option value="">Pilih Produk...</option>
                        </select>
                    </div>

                    <!-- Responsive Grid: Qty & Price -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-input" id="order-qty" min="1" placeholder="Jumlah" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Harga Jual</label>
                            <input type="number" class="form-input" id="order-price" placeholder="Harga jual" required>
                        </div>
                    </div>

                    <!-- Responsive Grid: Resi & Kurir -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Nomor Resi</label>
                            <input type="text" class="form-input" id="order-resi" placeholder="Masukkan nomor resi...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ekspedisi</label>
                            <select class="form-select" id="order-kurir">
                                <option value="">Pilih Ekspedisi...</option>
                                <option value="jne">JNE</option>
                                <option value="jnt">JnT Express</option>
                                <option value="sicepat">SiCepat</option>
                                <option value="pos">Pos Indonesia</option>
                                <option value="ninja">Ninja Express</option>
                                <option value="anteraja">AnterAja</option>
                                <option value="grab">Grab</option>
                                <option value="gojek">GoSend</option>
                            </select>
                        </div>
                    </div>

                    <!-- Platform -->
                    <div class="form-group">
                        <label class="form-label">Platform</label>
                        <select class="form-select" id="order-platform">
                            <option value="tiktok">TikTok</option>
                            <option value="shopee">Shopee</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>

                    <!-- Profit Preview -->
                    <div id="profit-preview" style="margin: 1rem 0; padding: 1rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; display: none;">
                        <strong style="color: #22c55e;">
                            Profit: <span id="profit-amount">Rp 0</span>
                        </strong>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn" style="width: 100%;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 11H7v3h2v-3zm4 0h-2v3h2v-3zm4 0h-2v3h2v-3zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                        </svg>
                        Buat Order
                    </button>
                </form>
            </div>
        </div>

        <!-- History Orders Tab -->
        <div id="history-orders" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                            <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/>
                        </svg>
                        History Orders
                    </h3>
                    <button class="btn btn-small" onclick="loadOrdersHistory()">Refresh</button>
                </div>

                <!-- Filter Section - COMPACT STYLE -->
                <div class="orders-filter-section" style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 0.75rem; margin-bottom: 1rem; align-items: center;">
                    <!-- Search Input -->
                    <div class="search-container">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8;">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <input type="text" placeholder="🔍 Cari order..." class="search-input" id="orders-search">
                    </div>
                    
                    <!-- Refresh Button (Hijau) -->
                    <button class="btn" onclick="loadOrdersHistory()" style="background: #10b981; color: white; border: none; border-radius: 8px; padding: 0.6rem 1rem; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Refresh
                    </button>
                    
                    <!-- Export Button (Biru) -->
                    <button class="btn" style="background: #3b82f6; color: white; border: none; border-radius: 8px; padding: 0.6rem 1rem; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                        </svg>
                        Export
                    </button>
                    
                    <!-- Status Filter Dropdown -->
                    <select class="form-select" id="status-filter" style="background: #334155; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 0.6rem 0.8rem; color: #ffffff; font-size: 0.9rem; min-width: 140px; font-weight: 500;">
                        <option value="">Semua Status</option>
                        <option value="pending">Pending</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="return">Return</option>
                    </select>
                </div>

                <!-- Desktop Table Container - COMPACT -->
                <div class="table-container">
                    <table class="products-table" style="font-size: 0.85rem;">
                        <thead>
                            <tr style="background: rgba(255, 255, 255, 0.05);">
                                <th style="padding: 0.6rem 0.8rem; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.03em;">TANGGAL</th>
                                <th style="padding: 0.6rem 0.8rem; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.03em;">ORDER ID</th>
                                <th style="padding: 0.6rem 0.8rem; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.03em;">CUSTOMER</th>
                                <th style="padding: 0.6rem 0.8rem; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.03em;">PRODUK</th>
                                <th style="padding: 0.6rem 0.8rem; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.03em;">QTY</th>
                                <th style="padding: 0.6rem 0.8rem; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.03em;">TOTAL</th>
                                <th style="padding: 0.6rem 0.8rem; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.03em;">STATUS</th>
                                <th style="padding: 0.6rem 0.8rem; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.03em;">ALAMAT</th>
                                <th style="padding: 0.6rem 0.8rem; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.03em;">KURIR</th>
                                <th style="padding: 0.6rem 0.8rem; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.03em;">RESI</th>
                                <th style="padding: 0.6rem 0.8rem; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.03em;">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="orders-history-table-body" style="font-size: 0.85rem;">
                            <tr>
                                <td colspan="11" style="text-align: center; color: #94a3b8; padding: 2rem;">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        Loading orders history...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Cards Container -->
                <div class="mobile-cards-container" id="mobile-orders-cards">
                    <!-- Mobile cards will be rendered here -->
                    <div style="text-align: center; color: #94a3b8; padding: 3rem 1rem;">
                        <div class="loading">
                            <div class="spinner"></div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem;">Loading orders...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales Report Tab -->
        <div id="sales-report" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                        </svg>
                        Sales Report
                    </h3>
                    <button class="btn btn-small">Export</button>
                </div>

                <!-- Revenue Cards -->
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="revenue-today" style="color: #22c55e;">Rp 0</div>
                        <div class="stat-label">Revenue Hari Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="revenue-month" style="color: #3b82f6;">Rp 0</div>
                        <div class="stat-label">Revenue Bulan Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-profit" style="color: #f59e0b;">Rp 0</div>
                        <div class="stat-label">Total Profit</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-order" style="color: #8b5cf6;">Rp 0</div>
                        <div class="stat-label">Rata-rata Order</div>
                    </div>
                </div>

                <!-- Placeholder untuk Charts -->
                <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="margin-bottom: 1rem; opacity: 0.5;">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                    </svg>
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Sales Analytics</div>
                    <div>Charts & detailed reports akan segera hadir</div>
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- ===========================================
             CUSTOMERS PAGE
        =========================================== -->
        <div id="customers-page" class="page">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Customer Management</h3>
                    <button class="btn btn-small" onclick="loadCustomers()">Refresh</button>
                </div>
                <div id="customers-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading customers...
                    </div>
                </div>
            </div>
        </div>

        <!-- ===========================================
             PRODUCTS PAGE
        =========================================== -->
        <div id="products-page" class="page">
            <!-- Tab Header -->
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('master-produk', this)">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 7h-3V6a4 4 0 0 0-4-4h-2a4 4 0 0 0-4 4v1H4a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM9 6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1H9V6zm10 13a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V9h2v1a1 1 0 0 0 2 0V9h6v1a1 1 0 0 0 2 0V9h2v10z"/>
                    </svg>
                    <span>Master Produk</span>
                </button>
                
                <button class="tab-btn" onclick="switchTab('stock-movement', this)">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l-7 7h4v6h6V9h4l-7-7zM6 20v2h12v-2H6z"/>
                    </svg>
                    <span>Stock Movement</span>
                </button>
                
                <button class="tab-btn" onclick="switchTab('laporan-stock', this)">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                    </svg>
                    <span>Laporan Stock</span>
                </button>
                
                <button class="tab-btn" onclick="switchTab('report', this)">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                    </svg>
                    <span>Report</span>
                </button>
            </div>

            <!-- Tab Content -->
            <div class="tabs-content">
                <!-- Master Produk Tab -->
                <div id="master-produk" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                                    <path d="M20 7h-3V6a4 4 0 0 0-4-4h-2a4 4 0 0 0-4 4v1H4a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM9 6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1H9V6z"/>
                                </svg>
                                Master Produk
                            </h3>
                            <button class="btn" style="background: #10b981;" onclick="showAddProductModal()">
                                + Tambah Produk
                            </button>
                        </div>

                        <!-- Search & Action Row -->
                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                            <div class="search-container">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8;">
                                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                                <input type="text" placeholder="Cari produk..." class="search-input" style="padding: 0.6rem 1rem 0.6rem 2.5rem;">
                            </div>
                            
                            <button class="btn-icon" onclick="loadProducts()" title="Refresh" style="padding: 0.6rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                </svg>
                            </button>
                            
                            <button class="btn-icon" title="Export" style="padding: 0.6rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Tips Section -->
                        <div class="tips-section">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="color: #fbbf24;">
                                <path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"/>
                            </svg>
                            <span><strong>Tips:</strong> Tekan Tombol Refresh Jika Data Tidak Muncul</span>
                        </div>

                        <!-- Products Table -->
                        <div class="table-container">
                            <table class="products-table">
                                <thead>
                                    <tr>
                                        <th>TANGGAL</th>
                                        <th>SKU</th>
                                        <th>NAMA BARANG</th>
                                        <th>TYPE</th>
                                        <th>QTY</th>
                                        <th>NOTES</th>
                                        <th>CREATED BY</th>
                                        <th>ACTION</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table-body">
                                    <tr>
                                        <td>2025-07-18</td>
                                        <td>7CHA1NTP</td>
                                        <td>Gelas 420ml</td>
                                        <td>pcs</td>
                                        <td>34</td>
                                        <td>-</td>
                                        <td>Surya</td>
                                        <td>
                                            <button class="btn-action edit">Edit</button>
                                            <button class="btn-action delete">🗑️</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Stock Movement Tab -->
                <div id="stock-movement" class="tab-content">
                    <h3 style="display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem; font-weight: 600; color: #f1f5f9; margin: 0 0 1rem 0;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: #f97316;">
                            <path d="M12 2l-7 7h4v6h6V9h4l-7-7zM6 20v2h12v-2H6z"/>
                        </svg>
                        Stock Movement
                    </h3>
                    
                    <button class="btn" style="background: #10b981; margin-bottom: 1.5rem; padding: 0.6rem 1.2rem; font-size: 0.9rem;" onclick="showAddMovementModal()">
                        + Tambah Movement Baru
                    </button>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 0.5rem;">
                            <h4 style="color: #3b82f6; font-size: 1.1rem; font-weight: 600; margin: 0;">History Movement</h4>
                        </div>

                        <div class="table-container">
                            <table class="products-table">
                                <thead>
                                    <tr>
                                        <th>TANGGAL</th>
                                        <th>SKU</th>
                                        <th>NAMA BARANG</th>
                                        <th>TYPE</th>
                                        <th>QTY</th>
                                        <th>NOTES</th>
                                        <th>CREATED BY</th>
                                        <th>ACTION</th>
                                    </tr>
                                </thead>
                                <tbody id="stock-movements-table-body">
                                    <tr>
                                        <td colspan="8" style="text-align: center; color: #94a3b8; padding: 3rem;">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                Loading stock movements...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Laporan Stock Tab -->
                <div id="laporan-stock" class="tab-content">
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem; font-weight: 600; color: #f1f5f9; margin: 0;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: #3b82f6;">
                                <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                            </svg>
                            Laporan Stock
                        </h3>
                    </div>

                    <div class="card">
                        <div class="tips-section">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="color: #fbbf24;">
                                <path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"/>
                            </svg>
                            <span><strong>Tips:</strong> Tekan Tombol Refresh Jika Data Tidak Muncul</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr auto auto auto auto; gap: 1rem; margin-bottom: 1.5rem; align-items: center;">
                            <div class="search-container">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8;">
                                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                                <input type="text" placeholder="🔍 Cari produk..." class="search-input" id="laporan-search" style="padding: 0.6rem 1rem 0.6rem 2.5rem;">
                            </div>
                            
                            <select class="form-select" id="range-filter" style="padding: 0.6rem; font-size: 0.9rem; min-width: 120px;">
                                <option value="">All Range</option>
                                <option value="high">Stock Tinggi</option>
                                <option value="low">Stock Rendah</option>
                                <option value="empty">Habis</option>
                            </select>
                            
                            <button class="btn-icon" onclick="loadLaporanStock()" title="Refresh" style="padding: 0.6rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                </svg>
                            </button>
                            
                            <button class="btn" style="background: #3b82f6; padding: 0.6rem 1rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;" onclick="exportLaporanStock()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                                </svg>
                                Export
                            </button>
                        </div>

                        <!-- Desktop Table -->
                        <div class="table-container">
                            <table class="products-table">
                                <thead>
                                    <tr>
                                        <th>SKU</th>
                                        <th>NAMA BARANG</th>
                                        <th>UNIT</th>
                                        <th>STOK AWAL</th>
                                        <th>STOCK IN</th>
                                        <th>STOCK OUT</th>
                                        <th>CURRENT STOCK</th>
                                        <th>STATUS</th>
                                    </tr>
                                </thead>
                                <tbody id="laporan-stock-table-body">
                                    <tr>
                                        <td colspan="8" style="text-align: center; color: #94a3b8; padding: 3rem;">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                Loading laporan stock...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Mobile Cards Container for Stock Report -->
                        <div class="mobile-cards-container" id="mobile-stock-cards">
                            <!-- Mobile stock cards will be rendered here -->
                            <div style="text-align: center; color: #94a3b8; padding: 3rem 1rem;">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">Loading stock report...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Report Tab -->
                <div id="report" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Report Inventory</h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-small" onclick="loadReportData()" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                    </svg>
                                    Refresh
                                </button>
                                <button class="btn btn-small" onclick="exportReportInventory()" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                                    </svg>
                                    Export
                                </button>
                            </div>
                        </div>

                        <!-- Summary Cards -->
                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="report-total-products" style="color: #f59e0b;">0</div>
                                <div class="stat-label">Total Produk</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="report-total-stock" style="color: #22c55e;">0</div>
                                <div class="stat-label">Total Stock</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="report-stock-value" style="color: #3b82f6;">Rp 0</div>
                                <div class="stat-label">Nilai Inventory</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="report-low-stock" style="color: #ef4444;">0</div>
                                <div class="stat-label">Low Stock Alert</div>
                            </div>
                        </div>
                    </div>

                    <!-- Low Stock Alert Section -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h4 style="color: #ef4444; font-size: 1.1rem; font-weight: 600; margin: 0;">⚠️ Low Stock Alert</h4>
                            <div class="status return" style="font-size: 0.8rem;" id="low-stock-count">0 Items</div>
                        </div>
                        <div id="low-stock-list">
                            <div class="loading">
                                <div class="spinner"></div>
                                Loading low stock items...
                            </div>
                        </div>
                    </div>

                    <!-- Top Selling Products -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h4 style="color: #22c55e; font-size: 1.1rem; font-weight: 600; margin: 0;">🏆 Produk Terlaris</h4>
                            <div class="status delivered" style="font-size: 0.8rem;" id="top-products-count">0 Items</div>
                        </div>
                        <div id="top-products-list">
                            <div class="loading">
                                <div class="spinner"></div>
                                Loading top products...
                            </div>
                        </div>
                    </div>

                    <!-- Dead Stock -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h4 style="color: #64748b; font-size: 1.1rem; font-weight: 600; margin: 0;">💀 Dead Stock</h4>
                            <div class="status" style="font-size: 0.8rem; background: rgba(100, 116, 139, 0.2); color: #64748b;" id="dead-stock-count">0 Items</div>
                        </div>
                        <div id="dead-stock-list">
                            <div class="loading">
                                <div class="spinner"></div>
                                Loading dead stock...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===========================================
             MESSAGES PAGE
        =========================================== -->
        <div id="messages-page" class="page">
            <!-- Tabs Header -->
            <div class="tabs-header message-tabs">
                <button class="tab-btn active" onclick="switchMessageTab('message-templates', this)">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                    </svg>
                    <span>Templates</span>
                </button>
                
                <button class="tab-btn" onclick="switchMessageTab('message-history', this)">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/>
                    </svg>
                    <span>History</span>
                </button>
                
                <button class="tab-btn" onclick="switchMessageTab('message-settings', this)">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                    </svg>
                    <span>Settings</span>
                </button>
            </div>

            <!-- Tabs Content Container -->
            <div class="tabs-content">
                <!-- Templates Tab -->
                <div id="message-templates" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"/>
                                </svg>
                                Message Templates
                            </h3>
                            <button class="btn" style="background: #10b981;" onclick="showAddTemplateModal()">
                                + Tambah Template
                            </button>
                        </div>

                        <!-- Template List -->
                        <div class="table-container">
                            <table class="products-table">
                                <thead>
                                    <tr>
                                        <th>NAME</th>
                                        <th>TYPE</th>
                                        <th>TEMPLATE</th>
                                        <th>STATUS</th>
                                        <th>ACTION</th>
                                    </tr>
                                </thead>
                                <tbody id="templates-table-body">
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: #94a3b8; padding: 3rem;">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                Loading templates...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="message-history" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                                    <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/>
                                </svg>
                                Message History
                            </h3>
                            <button class="btn btn-small" onclick="loadMessageHistory()">Refresh</button>
                        </div>

                        <!-- Filter Section -->
                        <div class="filter-controls" style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 1rem; margin-bottom: 1.5rem; align-items: center;">
                            <!-- Search -->
                            <div class="search-container">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8;">
                                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                                <input type="text" placeholder="🔍 Cari pesan..." class="search-input" id="message-search">
                            </div>
                            
                            <!-- Status Filter -->
                            <select class="form-select" id="message-status-filter" style="padding: 0.6rem; font-size: 0.9rem; min-width: 120px;">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="sent">Sent</option>
                                <option value="failed">Failed</option>
                            </select>
                            
                            <!-- Refresh Button -->
                            <button class="btn-icon" onclick="loadMessageHistory()" title="Refresh" style="padding: 0.6rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                </svg>
                            </button>
                            
                            <!-- Export Button -->
                            <button class="btn" style="background: #3b82f6; padding: 0.6rem 1rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                                </svg>
                                Export
                            </button>
                        </div>

                        <!-- Message History Table -->
                        <div class="table-container">
                            <table class="products-table">
                                <thead>
                                    <tr>
                                        <th>DATE</th>
                                        <th>CUSTOMER</th>
                                        <th>TYPE</th>
                                        <th>MESSAGE</th>
                                        <th>STATUS</th>
                                        <th>RESI</th>
                                        <th>ACTION</th>
                                    </tr>
                                </thead>
                                <tbody id="message-history-table-body">
                                    <tr>
                                        <td colspan="7" style="text-align: center; color: #94a3b8; padding: 3rem;">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                Loading message history...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="message-settings" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                                </svg>
                                WhatsApp Integration Settings
                            </h3>
                            <button class="btn btn-small" onclick="testConnection()">Test Connection</button>
                        </div>

                        <!-- API Settings Form -->
                        <form id="api-settings-form" name="api-settings-form">
                            <div class="form-group">
                                <label class="form-label">Fonnte API Key *</label>
                                <input type="password" class="form-input" id="fonnte-api-key" placeholder="Masukkan Fonnte API key..." required>
                                <small style="color: #94a3b8; margin-top: 0.5rem; display: block;">
                                    💡 Dapatkan API key dari <a href="https://fonnte.com" target="_blank" style="color: #3b82f6;">fonnte.com</a>
                                </small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">WhatsApp Device</label>
                                <input type="text" class="form-input" id="whatsapp-device" placeholder="Device ID (opsional)">
                                <small style="color: #94a3b8; margin-top: 0.5rem; display: block;">
                                    📱 Device ID untuk multi-device (kosongkan jika hanya 1 device)
                                </small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Auto Send Notifications</label>
                                <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="radio" name="auto-send" value="true" style="accent-color: #3b82f6;" checked>
                                        <span style="color: #22c55e; font-weight: 500;">Aktif</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="radio" name="auto-send" value="false" style="accent-color: #ef4444;">
                                        <span style="color: #ef4444; font-weight: 500;">Nonaktif</span>
                                    </label>
                                </div>
                                <small style="color: #94a3b8; margin-top: 0.5rem; display: block;">
                                    🤖 Kirim otomatis saat status order berubah
                                </small>
                            </div>

                            <!-- Connection Status -->
                            <div id="connection-status" style="margin: 1.5rem 0; padding: 1rem; border-radius: 8px; display: none;">
                                <!-- Status akan muncul di sini -->
                            </div>

                            <button type="submit" class="btn" style="width: 100%;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                                </svg>
                                Simpan Settings
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ===========================================
     SETTINGS PAGE - NEW
=========================================== -->
<div id="settings-page" class="page">
    <!-- Tabs Header -->
    <div class="tabs-header" style="display: grid; grid-template-columns: 1fr 1fr 1fr; width: 100%; gap: 1rem;">
        <button class="tab-btn active" onclick="switchSettingsTab('user-settings', this)">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <span>User Settings</span>
        </button>
        
        <button class="tab-btn" onclick="switchSettingsTab('auto-check-settings', this)">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
            </svg>
            <span>Auto Check</span>
        </button>
        
        <button class="tab-btn" onclick="switchSettingsTab('api-settings', this)">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
            </svg>
            <span>Monitor</span>
        </button>
    </div>

    <!-- Tabs Content -->
    <div class="tabs-content">
        <!-- User Settings Tab -->
        <div id="user-settings" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">👤 User Settings</h3>
                    <button class="btn btn-small" onclick="loadUserSettings()">Refresh</button>
                </div>
                
                <form id="user-settings-form">
                    <div class="form-group">
                        <label class="form-label">Nama User</label>
                        <input type="text" class="form-input" id="user-name" placeholder="Nama user" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Device Name</label>
                        <input type="text" class="form-input" id="device-name" placeholder="Nama device" required>
                    </div>
                    
                    <button type="submit" class="btn">💾 Simpan User Settings</button>
                </form>
            </div>
        </div>

       <!-- Auto Check Settings Tab -->
<div id="auto-check-settings" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">🤖 Auto Check Settings</h3>
            <div class="status" id="auto-check-status">Loading...</div>
        </div>
        
        <form id="auto-check-form">
            <div class="form-group">
                <label class="form-label">Auto Check Interval (menit)</label>
                <select class="form-select" id="check-interval">
                    <option value="1">1 menit</option>
                    <option value="5">5 menit</option>
                    <option value="15">15 menit</option>
                    <option value="30">30 menit</option>
                    <option value="60">1 jam</option>
                    <option value="120">2 jam</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Auto Check Status</label>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="radio" name="auto-check-enabled" value="true" style="accent-color: #22c55e;">
                        <span style="color: #22c55e;">Aktif</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="radio" name="auto-check-enabled" value="false" style="accent-color: #ef4444;">
                        <span style="color: #ef4444;">Nonaktif</span>
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Binderbyte API Key</label>
                <input type="password" class="form-input" id="binderbyte-api" placeholder="Masukkan API key Binderbyte">
                <small style="color: #94a3b8; margin-top: 0.5rem; display: block;">
                    💡 Dapatkan API key dari <a href="https://binderbyte.com" target="_blank" style="color: #3b82f6;">binderbyte.com</a>
                </small>
            </div>
            
            <!-- Helper Buttons Section -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <button type="button" class="btn" onclick="createAutoCheckTables()" style="background: #f59e0b; color: white; font-weight: 600;">
                    🛠️ Create Tables
                </button>
                <button type="button" class="btn" onclick="testAutoCheckAPI()" style="background: #8b5cf6; color: white; font-weight: 600;">
                    🔍 Test API
                </button>
            </div>
            
            <!-- Main Submit Button -->
            <button type="submit" class="btn" style="width: 100%;">⚙️ Simpan Auto Check Settings</button>
        </form>
        
        <!-- Status Info Panel -->
        <div id="auto-check-info" style="margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; display: none;">
            <h4 style="color: #3b82f6; margin-bottom: 0.5rem;">ℹ️ Auto Check Info</h4>
            <div id="auto-check-details" style="font-size: 0.9rem; color: #f1f5f9;"></div>
        </div>
    </div>
</div>

        <!-- Monitor Tab - MODERN REDESIGN -->
        <div id="api-settings" class="tab-content">
            <!-- Statistics Grid -->
            <div class="monitor-stats-grid">
                <div class="monitor-stat-card pending">
                    <div class="monitor-stat-value" id="monitor-pending-count">--</div>
                    <div class="monitor-stat-label">📦 Pending</div>
                    <div class="monitor-stat-sublabel">Belum diproses</div>
                </div>
                
                <div class="monitor-stat-card shipped">
                    <div class="monitor-stat-value" id="monitor-shipped-count">--</div>
                    <div class="monitor-stat-label">🚚 Sedang Dikirim</div>
                    <div class="monitor-stat-sublabel">Dalam perjalanan</div>
                </div>
                
                <div class="monitor-stat-card delivered">
                    <div class="monitor-stat-value" id="monitor-delivered-count">--</div>
                    <div class="monitor-stat-label">✅ Success Rate</div>
                    <div class="monitor-stat-sublabel">Berhasil delivered</div>
                </div>
                
                <div class="monitor-stat-card return">
                    <div class="monitor-stat-value" id="monitor-return-count">--</div>
                    <div class="monitor-stat-label">↩️ Return Rate</div>
                    <div class="monitor-stat-sublabel">Paket dikembalikan</div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="monitor-control-panel">
                <div class="monitor-control-header">
                    <div class="monitor-control-title">🤖 Auto Check Status</div>
                    <div class="monitor-control-actions">
                        <button class="btn" onclick="refreshMonitorData()">🔄 Refresh</button>
                        <button class="btn" onclick="runManualCheck()">⚡ Run Check</button>
                    </div>
                </div>
                
                <div class="monitor-status-info">
                    <div class="monitor-info-item">
                        <div class="monitor-info-label">Status</div>
                        <div class="monitor-info-value" id="monitor-auto-status">🟢 Aktif</div>
                    </div>
                    <div class="monitor-info-item">
                        <div class="monitor-info-label">Last Check</div>
                        <div class="monitor-info-value" id="monitor-last-check">2 menit yang lalu</div>
                    </div>
                    <div class="monitor-info-item">
                        <div class="monitor-info-label">Check Interval</div>
                        <div class="monitor-info-value" id="monitor-interval">Setiap 5 menit</div>
                    </div>
                    <div class="monitor-info-item">
                        <div class="monitor-info-label">Total Resi</div>
                        <div class="monitor-info-value" id="monitor-total-resi">--</div>
                    </div>
                </div>
            </div>

            <!-- Activity Table + Top Expeditions -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
                <!-- Activity Table -->
                <div class="monitor-activity-section">
                    <div class="monitor-activity-header">
                        <div class="monitor-activity-title">📋 Recent Activity</div>
                        <div style="color: #94a3b8; font-size: 0.8rem;">Last 10 updates</div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="monitor-activity-table">
                            <thead>
                                <tr>
                                    <th>TIME</th>
                                    <th>RESI</th>
                                    <th>STATUS CHANGE</th>
                                    <th>EKSPEDISI</th>
                                </tr>
                            </thead>
                            <tbody id="monitor-activity-tbody">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: #94a3b8; padding: 2rem;">
                                        Loading activity data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Top Expeditions -->
                <div class="monitor-top-expeditions">
                    <div class="monitor-activity-header">
                        <div class="monitor-activity-title">🏆 Top Ekspedisi</div>
                    </div>
                    
                    <div id="monitor-top-expeditions-list">
                        <div style="text-align: center; color: #94a3b8; padding: 2rem;">
                            Loading expeditions...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- ===========================================
     TRACKING PAGE - NEW
=========================================== -->
<div id="tracking-page" class="page">
    <!-- Tab Header -->
    <div class="tabs-header" style="grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
        <button class="tab-btn active" onclick="switchTrackingTab('scan-resi', this)">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;">
                <path d="M9 12l2 2 4-4"/>
                <path d="M21 12c-1.3 0-2.4-.3-3.4-.9L15 14l-3-3 2.6-2.6c-.6-1-.9-2.1-.9-3.4A9 9 0 1 1 21 12z"/>
            </svg>
            <span>Scan Resi</span>
        </button>
        <button class="tab-btn" onclick="switchTrackingTab('resi-pending', this)">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;">
                <path d="M9 5H7c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2h-2v1c0 .6-.4 1-1 1H10c-.6 0-1-.4-1-1V5zm1-2h4c.6 0 1 .4 1 1v1H9V4c0-.6.4-1 1-1zM7 10h2v2H7v-2zm4 0h6v2h-6v-2zm-4 4h2v2H7v-2zm4 0h6v2h-6v-2z"/>
            </svg>
            <span>Resi Pending</span>
        </button>
    </div>

    <!-- Tab 1: Scan Resi -->
    <div id="scan-resi" class="tab-content active">
        <div class="card">
            <!-- Kurir Detector -->
            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: #3b82f6; margin-bottom: 1rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 0.5rem;">
                        <path d="M9 12l2 2 4-4"/>
                        <path d="M21 12c-1.3 0-2.4-.3-3.4-.9L15 14l-3-3 2.6-2.6c-.6-1-.9-2.1-.9-3.4A9 9 0 1 1 21 12z"/>
                    </svg>
                    SCAN RESI DISINI (ENTER UNTUK SIMPAN)
                </h4>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem;">
                    <input type="text" class="form-input" id="detect-resi" placeholder="Masukkan nomor resi..." style="margin: 0;">
                    <button class="btn" onclick="detectKurirFromResi()">Detect</button>
                </div>
                <div id="detect-result" style="margin-top: 1rem; display: none;"></div>
            </div>
            
            <!-- Import Bulk Button -->
            <div style="margin-bottom: 1.5rem; text-align: center;">
                <button class="btn" onclick="showBulkImportModal()" style="background: #10b981; color: white; padding: 0.75rem 1.5rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                    </svg>
                    Import Resi Bulk
                </button>
            </div>
        </div>
    </div>

    <!-- Tab 2: Resi Pending -->
    <div id="resi-pending" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">📋 Resi Pending Auto Check</h3>
                <button class="btn btn-small" onclick="loadPendingResiTable()">Refresh</button>
            </div>
            
            <div id="pending-resi-table">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading resi pending...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===========================================
             RESI MANAGEMENT PAGE - NEW
        =========================================== -->
        <div id="resi-management-page" class="page">
            <!-- Tabs Header (3 Tab Clickable) -->
            <div class="tabs-header" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                <button class="tab-btn active" onclick="switchResiTab('proses', this)" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; gap: 0.75rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        <span>Proses</span>
                    </div>
                    <div style="font-weight: 700; font-size: 1rem;" id="tab-proses-count">0</div>
                </button>
                
                <button class="tab-btn" onclick="switchResiTab('delivered', this)" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; gap: 0.75rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                            <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                        </svg>
                        <span>Delivered</span>
                    </div>
                    <div style="font-weight: 700; font-size: 1rem;" id="tab-delivered-count">0</div>
                </button>
                
                <button class="tab-btn" onclick="switchResiTab('return', this)" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; gap: 0.75rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                            <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
                        </svg>
                        <span>Return</span>
                    </div>
                    <div style="font-weight: 700; font-size: 1rem;" id="tab-return-count">0</div>
                </button>
            </div>

            <!-- Filter Section -->
            <div class="card">
                <!-- Filter Controls - Clean Layout -->
                <div style="display: grid; grid-template-columns: 1fr auto auto auto auto; gap: 1rem; margin-bottom: 1.5rem; align-items: center;">
                    <!-- Search -->
                    <div class="search-container">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8;">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <input type="text" placeholder="🔍 Cari no resi, nama, ekspedisi..." class="search-input" id="resi-search" style="padding: 0.6rem 1rem 0.6rem 2.5rem;">
                    </div>
                    
                    <!-- Cek Terpilih Button -->
                    <button class="btn" style="background: #22c55e; color: white; padding: 0.6rem 1rem; font-size: 0.9rem; white-space: nowrap; border-radius: 8px; border: none;" onclick="checkSelectedResi()">
                        ✓ Cek Terpilih
                    </button>
                    
                    <!-- Cek Semua Button -->
                    <button class="btn" style="background: #3b82f6; color: white; padding: 0.6rem 1rem; font-size: 0.9rem; white-space: nowrap; border-radius: 8px; border: none;" onclick="checkAllResi()">
                        ↻ Cek Semua
                    </button>
                    
                    <!-- Status Filter -->
                    <select class="form-select" id="resi-status-filter" style="padding: 0.6rem; font-size: 0.9rem; min-width: 130px; background: #334155; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff;">
                        <option value="">Semua Status</option>
                        <option value="pending">Pending</option>
                        <option value="on_process">Proses</option>
                        <option value="delivered">Delivered</option>
                        <option value="return">Return</option>
                    </select>
                    
                    <!-- Kurir Filter -->
                    <select class="form-select" id="resi-kurir-filter" style="padding: 0.6rem; font-size: 0.9rem; min-width: 130px; background: #334155; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff;">
                        <option value="">Semua Kurir</option>
                        <option value="JNE">JNE</option>
                        <option value="JNT Express">JNT Express</option>
                        <option value="SiCepat Express">SiCepat</option>
                        <option value="Ninja Express">Ninja</option>
                        <option value="POS Indonesia">POS</option>
                    </select>
                </div>

                <!-- TAB CONTENT: PROSES -->
                <div id="resi-tab-proses" class="resi-tab-content active" style="display: block;">
                    <div class="table-container">
                        <table class="products-table" style="font-size: 0.85rem; width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(255, 255, 255, 0.05);">
                                    <th style="width: 40px; padding: 0.75rem 0.5rem; text-align: center;"><input type="checkbox" id="select-all-proses" style="accent-color: #3b82f6;"></th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; font-weight: 700;">NO</th>
                                    <th style="padding: 0.75rem; font-size: 0.8rem; font-weight: 700;">TANGGAL</th>
                                    <th style="padding: 0.75rem; font-size: 0.8rem; font-weight: 700;">NO RESI</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; font-weight: 700;">EKSPEDISI</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; font-weight: 700;">JAM</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; font-weight: 700;">STATUS</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; font-weight: 700; width: 120px;">ACTION</th>
                                </tr>
                            </thead>
                            <tbody id="proses-table-body">
                                <tr><td colspan="8" style="text-align: center; padding: 3rem; color: #94a3b8;">Loading proses data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB CONTENT: DELIVERED -->
                <div id="resi-tab-delivered" class="resi-tab-content" style="display: none;">
                    <div class="table-container">
                        <table class="products-table" style="font-size: 0.85rem; width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(255, 255, 255, 0.05);">
                                    <th style="width: 40px; padding: 0.75rem 0.5rem; text-align: center;"><input type="checkbox" id="select-all-delivered" style="accent-color: #3b82f6;"></th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; font-weight: 700;">NO</th>
                                    <th style="padding: 0.75rem; font-size: 0.8rem; font-weight: 700;">TANGGAL</th>
                                    <th style="padding: 0.75rem; font-size: 0.8rem; font-weight: 700;">NO RESI</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; font-weight: 700;">EKSPEDISI</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; font-weight: 700;">STATUS</th>
                                    <th style="padding: 0.75rem; font-size: 0.8rem; font-weight: 700;">PENERIMA</th>
                                    <th style="padding: 0.75rem; font-size: 0.8rem; font-weight: 700;">TGL DITERIMA</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; font-weight: 700; width: 120px;">ACTION</th>
                                </tr>
                            </thead>
                            <tbody id="delivered-table-body">
                                <tr><td colspan="9" style="text-align: center; padding: 3rem; color: #94a3b8;">Loading delivered data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB CONTENT: RETURN -->
                <div id="resi-tab-return" class="resi-tab-content" style="display: none;">
                    <div class="table-container">
                        <table class="products-table" style="font-size: 0.85rem; width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(255, 255, 255, 0.05);">
                                    <th style="width: 40px; padding: 0.75rem 0.5rem; text-align: center;"><input type="checkbox" id="select-all-return" style="accent-color: #3b82f6;"></th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; font-weight: 700;">NO</th>
                                    <th style="padding: 0.75rem; font-size: 0.8rem; font-weight: 700;">TANGGAL</th>
                                    <th style="padding: 0.75rem; font-size: 0.8rem; font-weight: 700;">NO RESI</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; font-weight: 700;">EKSPEDISI</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; font-weight: 700;">STATUS</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; font-weight: 700; width: 120px;">ACTION</th>
                                </tr>
                            </thead>
                            <tbody id="return-table-body">
                                <tr><td colspan="7" style="text-align: center; padding: 3rem; color: #94a3b8;">Loading return data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    <!-- ===========================================
         BOTTOM NAVIGATION (MOBILE)
    =========================================== -->
    <nav class="bottom-nav">
        <div class="nav-container">
            <div class="nav-item active" onclick="showPageMobile('dashboard-page', this)">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                    </svg>
                </div>
                <div class="nav-label">Dashboard</div>
            </div>
            
            <div class="nav-item" onclick="showPageMobile('orders-page', this)">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 4V2c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v2h4c1.1 0 2 .9 2 2v14c0 1.1-.9 2-2 2H3c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h4zM9 4h6V2H9v2zm8 4H7v2h10V8z"/>
                    </svg>
                </div>
                <div class="nav-label">Orders</div>
            </div>
            
            <div class="nav-item" onclick="showPageMobile('customers-page', this)">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A3.98 3.98 0 0 0 16.06 6H15c-.8 0-1.54.37-2.01.99L10.99 9H6c-1.1 0-2 .9-2 2v3h2v8h8v-8h2v8h4z"/>
                    </svg>
                </div>
                <div class="nav-label">Customers</div>
            </div>
            
            <div class="nav-item" onclick="showPageMobile('products-page', this)">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 7h-3V6a4 4 0 0 0-4-4h-2a4 4 0 0 0-4 4v1H4a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM9 6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1H9V6zm6 4a1 1 0 0 1-2 0v-1a1 1 0 0 1 2 0v1zm-4 0a1 1 0 0 1-2 0v-1a1 1 0 0 1 2 0v1z"/>
                    </svg>
                </div>
                <div class="nav-label">Products</div>
            </div>
            
            <div class="nav-item" onclick="showPageMobile('messages-page', this)">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                    </svg>
                </div>
                <div class="nav-label">Messages</div>
            </div>
        </div>
    </nav>

    <!-- ===========================================
         MODALS
    =========================================== -->
    
    <!-- Modal Add Customer -->
    <div id="add-customer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="font-size: 1.5rem;">👥</span>
                    <h3>Tambah Customer Baru</h3>
                </div>
                <button class="modal-close" onclick="closeAddCustomerModal()">×</button>
            </div>
            
            <form id="add-customer-form" name="add-customer-form">
                <div class="form-group">
                    <label class="form-label">Nama Customer *</label>
                    <input type="text" class="form-input" id="new-customer-name" placeholder="Masukkan nama customer" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">No HP *</label>
                    <input type="tel" class="form-input" id="new-customer-phone" placeholder="Contoh: 081234567890" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Alamat</label>
                    <textarea class="form-input" id="new-customer-address" placeholder="Alamat lengkap (opsional)" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Platform</label>
                    <select class="form-select" id="new-customer-platform">
                        <option value="tiktok">TikTok</option>
                        <option value="shopee">Shopee</option>
                        <option value="offline">Offline</option>
                    </select>
                </div>
                
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">
                        <span>📁</span> Simpan Customer
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddCustomerModal()">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

   <!-- Modal Add Product -->
    <div id="add-product-modal" class="modal">
        <div class="modal-content" style="max-width: 500px; width: 90%;">
            <div class="modal-header" style="padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: #3b82f6;">
                        <path d="M20 7h-3V6a4 4 0 0 0-4-4h-2a4 4 0 0 0-4 4v1H4a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM9 6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1H9V6z"/>
                    </svg>
                    <h3>Tambah Produk Baru</h3>
                </div>
                <button class="modal-close" onclick="closeAddProductModal()">×</button>
            </div>
            
            <form id="add-product-form" name="add-product-form" style="padding: 1rem;">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">SKU *</label>
                    <input type="text" class="form-input" id="new-product-sku" placeholder="Contoh: 7CHA1NTP" required style="padding: 0.6rem;">
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Nama Barang *</label>
                    <input type="text" class="form-input" id="new-product-name" placeholder="Gelas 420ml Tutup Kayu" required style="padding: 0.6rem;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Unit</label>
                        <select class="form-select" id="new-product-unit" style="padding: 0.6rem;">
                            <option value="pcs">pcs</option>
                            <option value="box">box</option>
                            <option value="kg">kg</option>
                            <option value="liter">liter</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Stok Awal</label>
                        <input type="number" class="form-input" id="new-product-stock" value="0" min="0" style="padding: 0.6rem;">
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label">Harga *</label>
                    <input type="number" class="form-input" id="new-product-price" placeholder="30000" required style="padding: 0.6rem;">
                </div>
                
                <div class="modal-buttons" style="display: flex; gap: 0.75rem;">
                    <button type="submit" class="btn" style="flex: 1; background: #10b981; color: white; padding: 0.6rem 1.2rem; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                        </svg>
                        Simpan Produk
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddProductModal()" style="padding: 0.6rem 1.2rem; font-size: 0.9rem;">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Add Template -->
    <div id="add-template-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: #3b82f6;">
                        <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"/>
                    </svg>
                    <h3>Tambah Template Pesan</h3>
                </div>
                <button class="modal-close" onclick="closeAddTemplateModal()">×</button>
            </div>
            
            <form id="add-template-form" name="add-template-form">
                <div class="form-group">
                    <label class="form-label">Nama Template *</label>
                    <input type="text" class="form-input" id="template-name" placeholder="Template Pengiriman" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Type *</label>
                    <select class="form-select" id="template-type" required>
                        <option value="">Pilih type...</option>
                        <option value="shipped">Shipped (Dikirim)</option>
                        <option value="delivered">Delivered (Sampai)</option>
                        <option value="return">Return (Dikembalikan)</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                
               <div class="form-group">
    <label class="form-label">Template Pesan *</label>
    <textarea class="form-input" id="template-content" rows="4" placeholder="Halo {customer_name}, pesanan Anda sudah dikirim via {kurir} dengan resi {resi_number}. Terima kasih!" required></textarea>
    <small style="color: #94a3b8; margin-top: 0.5rem; display: block; line-height: 1.5;">
        💡 <strong>Variables Available:</strong><br>
        👤 <span style="color: #60a5fa;">Customer:</span> {customer_name}<br>
        📦 <span style="color: #34d399;">Product:</span> {product_name}, {qty}<br>
        🔢 <span style="color: #fbbf24;">Order:</span> {order_id}, {harga}, {platform}, {tanggal_order}<br>
        🚚 <span style="color: #f87171;">Shipping:</span> {resi_number}, {kurir}, {recipient_name}
    </small>
</div>
                
                <div class="form-group">
                    <label class="form-label">Deskripsi</label>
                    <input type="text" class="form-input" id="template-description" placeholder="Deskripsi template (opsional)">
                </div>
                
                <div class="modal-buttons">
                    <button type="submit" class="btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V7l-4-4z"/>
                        </svg>
                        Simpan Template
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddTemplateModal()">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Add Stock Movement -->
    <div id="add-movement-modal" class="modal">
        <div class="modal-content" style="max-width: 420px; width: 90%; margin: 2% auto; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: #f97316;">
                        <path d="M12 2l-7 7h4v6h6V9h4l-7-7zM6 20v2h12v-2H6z"/>
                    </svg>
                    <h3 style="margin: 0; font-size: 1.1rem;">Tambah Stock Movement</h3>
                </div>
                <button class="modal-close" onclick="closeAddMovementModal()">×</button>
            </div>
            
            <form id="add-movement-form" style="padding: 1rem; padding-top: 0;" name="add-movement-form">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label" style="margin-bottom: 0.4rem; font-size: 0.9rem;">Pilih Produk *</label>
                    <select class="form-select" id="movement-product-select" style="padding: 0.7rem; font-size: 0.9rem;" required>
                        <option value="">Pilih produk...</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label" style="margin-bottom: 0.4rem; font-size: 0.9rem;">Type Movement *</label>
                    <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                            <input type="radio" name="movement-type" value="in" style="accent-color: #10b981;" required>
                            <span style="color: #10b981; font-weight: 600;">IN (Masuk)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                            <input type="radio" name="movement-type" value="out" style="accent-color: #ef4444;" required>
                            <span style="color: #ef4444; font-weight: 600;">OUT (Keluar)</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label" style="margin-bottom: 0.4rem; font-size: 0.9rem;">Quantity *</label>
                    <input type="number" class="form-input" id="movement-qty" placeholder="Masukkan jumlah" min="1" style="padding: 0.7rem; font-size: 0.9rem;" required>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label" style="margin-bottom: 0.4rem; font-size: 0.9rem;">Notes/Keterangan</label>
                    <textarea class="form-input" id="movement-notes" placeholder="Catatan tambahan (opsional)" rows="2" style="padding: 0.7rem; font-size: 0.9rem; resize: vertical;"></textarea>
                </div>
                
                <div class="modal-buttons" style="display: flex; gap: 0.75rem; margin-top: 1.25rem;">
                    <button type="submit" class="btn" style="flex: 1; padding: 0.7rem 1rem; font-size: 0.9rem; background: #3b82f6; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                        </svg>
                        Simpan Movement
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddMovementModal()" style="padding: 0.7rem 1rem; font-size: 0.9rem; white-space: nowrap;">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Import Bulk Resi -->
<div id="bulk-import-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-size: 1.5rem;">📦</span>
                <h3>Import Resi Bulk</h3>
            </div>
            <button class="modal-close" onclick="closeBulkImportModal()">×</button>
        </div>
        
        <div style="padding: 1.25rem;">
            <div class="form-group">
                <label class="form-label">Paste No Resi (satu per baris):</label>
                <textarea class="form-input" id="bulk-resi-input" rows="8" placeholder="JX1234567890
002918123456
SPX7890123456
..."></textarea>
                <small style="color: #94a3b8; margin-top: 0.5rem; display: block;">
                    💡 Tips: Copy dari Excel/spreadsheet dan paste langsung. Kurir akan auto-detect.
                </small>
            </div>
            
            <div style="display: flex; gap: 0.75rem;">
                <button class="btn" onclick="processBulkImport()" style="flex: 1; background: #10b981;">
                    🛡️ Import Sekarang
                </button>
                <button class="btn btn-secondary" onclick="closeBulkImportModal()">
                    Batal
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detail Tracking -->
<div id="detail-tracking-modal" class="modal">
    <div class="modal-content" style="max-width: 900px; width: 95%;">
        <div class="modal-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: #3b82f6;">
                    <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10"/>
                </svg>
                <h3>Detail Tracking</h3>
            </div>
            <button class="modal-close" onclick="closeDetailTrackingModal()">×</button>
        </div>
        
        <div style="padding: 1.25rem;">
            <!-- Loading State -->
            <div id="detail-loading" class="loading">
                <div class="spinner"></div>
                Loading detail tracking...
            </div>
            
            <!-- Detail Content -->
            <div id="detail-content" style="display: none;">
                <!-- Info Cards Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <!-- Resi Info -->
                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); padding: 1rem; border-radius: 8px;">
                        <div style="color: #3b82f6; font-weight: 600; margin-bottom: 0.5rem;">NO RESI</div>
                        <div id="detail-resi" style="font-family: monospace; font-weight: 700; font-size: 1.1rem;"></div>
                    </div>
                    
                    <!-- Ekspedisi Info -->
                    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); padding: 1rem; border-radius: 8px;">
                        <div style="color: #22c55e; font-weight: 600; margin-bottom: 0.5rem;">EKSPEDISI</div>
                        <div id="detail-ekspedisi"></div>
                    </div>
                    
                    <!-- Status Info -->
                    <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.2); padding: 1rem; border-radius: 8px;">
                        <div style="color: #fbbf24; font-weight: 600; margin-bottom: 0.5rem;">STATUS</div>
                        <div id="detail-status"></div>
                    </div>
                </div>
                
                <!-- History Tracking -->
                <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1.5rem;">
                    <h4 style="color: #f1f5f9; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="color: #3b82f6;">
                            <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/>
                        </svg>
                        History Tracking
                    </h4>
                    <div id="tracking-history">
                        <!-- History items akan dimuat di sini -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- ===========================================
         JAVASCRIPT SECTION
    =========================================== -->
    <script>
        // ===========================================
        // API CONFIGURATION
        // ===========================================
        const API_BASE = 'https://ersetsolution.my.id/api.php';

        // Global data storage
        let customers = [];
        let products = [];
        let orders = [];

        // ===========================================
        // COURIER DETECTION FUNCTIONS (NEW)
        // ===========================================
        
        // Mapping ekspedisi ke warna background
        const courierColorMap = {
            "JNE": "#003168",              // Navy Blue
            "J&T Express": "#EE1D23",      // Merah J&T
            "SiCepat Express": "#DA1F26",  // Merah SiCepat
            "SAP Express": "#6A1B9A",      // Ungu SAP
            "Shopee Express": "#FB641B",   // Orange Shopee
            "Ninja Express": "#D71920",    // Merah Ninja
            "Lion Parcel": "#ED1C24",      // Merah Lion Parcel
            "POS Indonesia": "#FF6600",    // Orange POS
            "Anteraja": "#E71C6A",         // Pink Anteraja
            "ID Express": "#E60012",       // Merah ID Express
            "Lazada Logistics": "#321575", // Ungu Lazada
            "Wahana": "#008DD2",           // Biru Wahana
        };

        /**
         * Deteksi ekspedisi berdasarkan nomor resi
         * @param {string} resi - Nomor resi
         * @returns {string} - Nama ekspedisi
         */
        function detectEkspedisi(resi) {
            if (!resi || typeof resi !== 'string') {
                return "(Tidak Dikenal)";
            }

            const resix = resi.toUpperCase().trim();
            
            // Cek prefix 6 digit untuk JNE
            const prefix6 = resix.substring(0, 6);
            if (
                prefix6 === "012300" ||
                prefix6 === "013990" ||
                prefix6 === "019664" ||
                prefix6 === "013781" ||
                prefix6 === "012098" ||
                prefix6 === "012231" ||
                prefix6 === "013992"
            ) return "JNE";

            // Ninja Express: cek prefix string
            if (
                resix.startsWith("ORDNL") ||
                resix.startsWith("NJVT") ||
                resix.startsWith("KOMRCKOM") ||
                resix.startsWith("NVID")
            ) return "Ninja Express";

            // J&T Express
            if (
                resix.startsWith("JX") ||
                resix.startsWith("JO")
            ) return "J&T Express";

            // SiCepat: cek 4-6 digit awal
            const prefix4 = resix.substring(0, 4);
            if (
                prefix4 === "0029" ||
                prefix6 === "004441" ||
                prefix6 === "004442" ||
                prefix6 === "004443" ||
                prefix6 === "004444" ||
                prefix6 === "004445" ||
                prefix6 === "004446"
            ) return "SiCepat Express";

            // Shopee Express
            if (resix.startsWith("SPX")) return "Shopee Express";

            // SAP Express
            if (
                resix.startsWith("KOMSHIP") ||
                resix.startsWith("OO00") ||
                resix.startsWith("MGT")
            ) return "SAP Express";

            // Lazada Express
            if (
                resix.startsWith("NLIDAP") ||
                resix.startsWith("LXAD-")
            ) return "Lazada Express";

            // Lion Parcel
            if (resix.startsWith("JBB1")) return "Lion Parcel";

            // POS Indonesia
            if (resix.startsWith("PK")) return "POS Indonesia";

            // Anteraja
            if (resix.startsWith("ANT")) return "Anteraja";

            // ID Express
            if (resix.startsWith("IDE")) return "ID Express";

            // Wahana
            if (resix.startsWith("WH")) return "Wahana";

            return "(Tidak Dikenal)";
        }

        /**
         * Generate courier badge dengan color coding
         * @param {string} courierName - Nama kurir
         * @returns {string} - HTML untuk courier badge
         */
        function generateCourierBadge(courierName) {
    if (!courierName || courierName === "-" || courierName === "") {
        return '<span class="courier-badge unknown">-</span>';
    }

    // Perpendek nama kurir biar compact
   // Keep full name kurir  
const shortNames = {
    "J&T Express": "J&T EXPRESS",
    "JNE": "JNE", 
    "SiCepat Express": "SICEPAT",
    "Ninja Express": "NINJA",
    "POS Indonesia": "POS",
    "Anteraja": "ANTERAJA",
    "(Tidak Dikenal)": "-"
};
    
    const displayName = shortNames[courierName] || courierName;
    const color = courierColorMap[courierName] || "#64748b";
    return `<span class="courier-badge" style="background: ${color}; white-space: nowrap; min-width: 90px; text-align: center; padding: 0.25rem 0.6rem; font-size: 0.7rem;">${displayName}</span>`;
}

        /**
         * Auto detect courier dari resi dan update dropdown
         * @param {string} resiNumber - Nomor resi
         * @param {string} selectId - ID dropdown select
         */
        function autoDetectCourier(resiNumber, selectId) {
            const select = document.getElementById(selectId);
            if (!select || !resiNumber) return;

            const detectedCourier = detectEkspedisi(resiNumber);
            
            // Mapping nama ekspedisi ke value dropdown
            const courierMapping = {
                "JNE": "jne",
                "J&T Express": "jnt", 
                "SiCepat Express": "sicepat",
                "Ninja Express": "ninja",
                "Shopee Express": "shopee",
                "POS Indonesia": "pos",
                "Anteraja": "anteraja",
                "SAP Express": "sap",
                "Lion Parcel": "lion",
                "Lazada Logistics": "lazada"
            };

            const selectValue = courierMapping[detectedCourier];
            if (selectValue) {
                select.value = selectValue;
                
                // Show toast notification
                toastInfo('Kurir Terdeteksi', `Otomatis terdeteksi: ${detectedCourier}`);
            }
        }

        // ===========================================
        // NAVIGATION FUNCTIONS
        // ===========================================
        
      /**
 * Show page function untuk desktop sidebar
 */
function showPage(pageId, element = null) {
    // Hide all pages
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    // Show selected page
    document.getElementById(pageId).classList.add('active');
    
    // Update sidebar nav (desktop)
    document.querySelectorAll('.sidebar-item').forEach(nav => {
        nav.classList.remove('active');
    });
    if (element) {
        element.classList.add('active');
    }
    
    // Update page title based on menu selection
    updatePageTitle(pageId, element);
    
    // Update bottom nav (mobile)
    document.querySelectorAll('.nav-item').forEach(nav => {
        nav.classList.remove('active');
    });
    
    // Find corresponding bottom nav item
    const pageToNavMap = {
        'dashboard-page': 0,
        'orders-page': 1,
        'customers-page': 2,
        'products-page': 3,
        'messages-page': 4,
        'tracking-page': 5,
        'settings-page': 7,
        'resi-management-page': 6 
    };
    
    const navIndex = pageToNavMap[pageId];
    if (navIndex !== undefined) {
        const navItems = document.querySelectorAll('.nav-item');
        if (navItems[navIndex]) {
            navItems[navIndex].classList.add('active');
        }
    }
    
    // Load page data
    if (pageId === 'orders-page') loadOrders();
    if (pageId === 'customers-page') loadCustomers();
    if (pageId === 'products-page') {
        loadProducts();
        // Auto load stock movements jika tab stock movement aktif
        setTimeout(() => {
            const stockMovementTab = document.getElementById('stock-movement');
            if (stockMovementTab && stockMovementTab.classList.contains('active')) {
                loadStockMovements();
            }
        }, 100);
    }
    if (pageId === 'tracking-page') {
        // Auto load scan resi tab
        switchTrackingTab('scan-resi', document.querySelector('.tab-btn.active'));
    }
    if (pageId === 'resi-management-page') {
        // ✅ FIX: Auto-refresh Resi Management jika ada pending refresh
        if (window.resiManagementNeedsRefresh) {
            loadResiManagementData();
            window.resiManagementNeedsRefresh = false;
        } else {
            // Normal load
            loadResiManagementData();
        }
    }
}

        /**
         * Update page title dynamically
         */
        function updatePageTitle(pageId, element) {
            const pageTitle = document.getElementById('page-title');
            const titleSpan = pageTitle.querySelector('span');
            const titleIcon = pageTitle.querySelector('svg');
            
            // Get title from element data attribute or use default
            let title = 'Dashboard';
            let iconPath = 'M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z'; // dashboard icon
            
            if (element && element.dataset.title) {
                title = element.dataset.title;
            } else {
                // Fallback titles
const titleMap = {
    'dashboard-page': 'Dashboard',
    'orders-page': 'Order Management', 
    'customers-page': 'Customer Management',
    'products-page': 'Products & Inventory',
    'messages-page': 'Message Queue',
    'tracking-page': 'Tracking Integration',
    'settings-page': 'Settings',
    'resi-management-page': 'Resi Management'
};
title = titleMap[pageId] || 'Dashboard';
}

// Icon paths for each page

const iconMap = {
    'Dashboard': 'M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z',
    'Order Management': 'M7 4V2c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v2h4c1.1 0 2 .9 2 2v14c0 1.1-.9 2-2 2H3c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h4zM9 4h6V2H9v2zm8 4H7v2h10V8z',
    'Customer Management': 'M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A3.98 3.98 0 0 0 16.06 6H15c-.8 0-1.54.37-2.01.99L10.99 9H6c-1.1 0-2 .9-2 2v3h2v8h8v-8h2v8h4z',
    'Products & Inventory': 'M20 7h-3V6a4 4 0 0 0-4-4h-2a4 4 0 0 0-4 4v1H4a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM9 6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1H9V6zm6 4a1 1 0 0 1-2 0v-1a1 1 0 0 1 2 0v1zm-4 0a1 1 0 0 1-2 0v-1a1 1 0 0 1 2 0v1z',
    'Message Queue': 'M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z',
    'Tracking Integration': 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10',
    'Settings': 'M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z',
    'Resi Management': 'M9 11H7v3h2v-3zm4 0h-2v3h2v-3zm4 0h-2v3h2v-3zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z'
};
            
            iconPath = iconMap[title] || iconPath;
            
            titleSpan.textContent = title;
            titleIcon.innerHTML = `<path d="${iconPath}"/>`;
        }

        /**
         * Bottom nav click handler for mobile
         */
        function showPageMobile(pageId, navElement) {
            showPage(pageId);
            
            // Update page title for mobile (since no element.dataset.title)
            updatePageTitle(pageId);
            
            // Update only bottom nav
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            navElement.classList.add('active');
        }

        /**
         * Additional functions for sidebar menu
         */
 function showTrackingIntegration() {
    showPage('tracking-page');
    // Auto load scan resi tab saat buka tracking page
    setTimeout(() => {
        const scanTab = document.querySelector('#tracking-page .tab-btn[onclick*="scan-resi"]');
        if (scanTab) {
            switchTrackingTab('scan-resi', scanTab);
        }
    }, 100);
}
// ===========================================
// TRACKING FUNCTIONS (NEW)
// ===========================================

/**
 * Detect kurir dari nomor resi
 */
 async function detectKurirFromResi() {
    const resiInput = document.getElementById('detect-resi');
    const resiNumber = resiInput.value.trim();
    
    if (!resiNumber) {
        return;
    }
    
    try {
        // ✅ CHECK DUPLICATE ke database (bukan local array)
        const existingResi = await apiCall('tracking_resi');
        if (existingResi.success && Array.isArray(existingResi.data)) {
            const isDuplicate = existingResi.data.some(item => item.no_resi === resiNumber);
            
            if (isDuplicate) {
                toastError('Resi Duplicate!', `Resi ${resiNumber} sudah pernah di-scan!`);
                
                // Auto-clear input dan focus kembali
                setTimeout(() => {
                    resiInput.value = '';
                    resiInput.focus();
                }, 2000);
                return;
            }
        }
        
        // ✅ DETECT KURIR (tetap jalan)
        const detectedKurir = detectEkspedisi(resiNumber);
        
        // ✅ SAVE KE DATABASE (tetap jalan - masuk tab pending)
        saveResiToDatabase(resiNumber, detectedKurir);
        
        // ✅ SUCCESS TOAST (simplified)
        toastSuccess('Resi Disimpan', `${resiNumber} (${detectedKurir}) berhasil disimpan ke tracking!`);
        
        // ✅ AUTO-CLEAR (tetap jalan)
        setTimeout(() => {
            resiInput.value = '';
            resiInput.focus();
        }, 1000);
        
    } catch (error) {
        console.error('Error checking duplicate resi:', error);
        toastError('Error', 'Gagal mengecek duplicate resi');
    }
}





// Function untuk save resi ke database
async function saveResiToDatabase(resiNumber, ekspedisi) {
    try {
        const now = new Date();
        const tanggal = now.toISOString().split('T')[0]; // YYYY-MM-DD
        const jam = now.toTimeString().split(' ')[0]; // HH:MM:SS
        
        const data = {
            no_resi: resiNumber,
            ekspedisi: ekspedisi,
            tanggal: tanggal,
            jam: jam,
            status: 'pending'
        };
        
        // Langsung ke autocheck.php endpoint
const response = await fetch('https://ersetsolution.my.id/autocheck.php?action=tracking_resi', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
});
const result = await response.json();
        
        if (result.success) {
            console.log('✅ Resi saved to database:', resiNumber);
        } else {
            console.warn('⚠️ Failed to save resi:', result.error);
        }
        
    } catch (error) {
        console.error('❌ Error saving resi:', error);
    }
}


// Function untuk switch tracking tab
function switchTrackingTab(tabId, element) {
    // Hide semua tab content
    document.querySelectorAll('#tracking-page .tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active dari semua tab button
    document.querySelectorAll('#tracking-page .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    element.classList.add('active');
    
    // Load data berdasarkan tab
    if (tabId === 'resi-pending') {
        loadPendingResiTable();
    }
}

async function checkResiBinderbyte(resiId) {
    console.log('🚀 FUNCTION VERSION: 2024-07-21 UPDATED');
    try {
        toastInfo('Checking...', 'Mengecek status resi via Binderbyte API');
        
        // Get resi data dulu
        const resiData = await getResiDataById(resiId);
        if (!resiData) {
            toastError('Error', 'Data resi tidak ditemukan');
            return;
        }
        
        // Store old status untuk comparison
        const oldStatus = resiData.status;
        console.log('🔍 OLD STATUS:', oldStatus);
        
        // Call real binderbyte API
        const response = await fetch(`https://ersetsolution.my.id/autocheck.php?action=check_resi_binderbyte&resi=${resiData.no_resi}`);
        const result = await response.json();
        
        console.log('🔍 API Response:', result);
        
        if (result.success) {
            // Simple status mapping
            let dbStatus = result.final_status || 'on_process';
            console.log('🔍 NEW STATUS:', dbStatus);
            
            // Update status di database
            const updateResult = await apiCall('tracking_resi', 'PUT', {
                id: resiId,
                status: dbStatus,
                response: JSON.stringify(result)
            });
            
            if (updateResult.success) {
                const friendlyStatus = getStatusDisplayText(dbStatus);
                toastSuccess('Status Updated', `Status diupdate ke: ${friendlyStatus}`);
                
                // ✅ DEBUG AUTO WHATSAPP CONDITION - UPDATED
                console.log('🔍 WhatsApp Check:', {
                    oldStatus: oldStatus,
                    newStatus: dbStatus,
                    statusChanged: oldStatus !== dbStatus,
                    isTargetStatus: (dbStatus === 'on_process' || dbStatus === 'shipped' || dbStatus === 'delivered'),
                    willSendWA: (oldStatus !== dbStatus && (dbStatus === 'on_process' || dbStatus === 'shipped' || dbStatus === 'delivered'))
                });
                
                if (oldStatus !== dbStatus && (dbStatus === 'on_process' || dbStatus === 'shipped' || dbStatus === 'delivered')) {
                    console.log('✅ SENDING WHATSAPP...');
                    
                    // Map status ke template yang sesuai
                    let templateStatus = dbStatus;
                    if (dbStatus === 'on_process') {
                        templateStatus = 'shipped'; // on_process = pakai template shipped
                    }
                    
                    fetch('templates.php?action=auto_notify_resi', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ resi_number: resiData.no_resi, new_status: templateStatus })
                    }).then(res => res.json()).then(result => {
                        console.log('📱 WhatsApp Result:', result);
                        if (result.success) toastSuccess('📱 WhatsApp Sent!', result.message || 'Notification sent');
                    }).catch(err => console.log('Notification failed:', err));
                } else {
                    console.log('❌ WhatsApp condition NOT MET');
                }
                
                // Refresh pages...
                loadPendingResiTable();
                loadOrdersHistory();
                loadDashboardData();
                
                const currentPage = document.querySelector('.page.active')?.id;
                if (currentPage === 'resi-management-page') {
                    loadResiManagementData();
                } else {
                    window.resiManagementNeedsRefresh = true;
                }
                
            } else {
                toastError('Update Failed', updateResult.error || 'Gagal update status');
            }
        } else {
            toastError('API Error', result.error || 'Gagal check via Binderbyte');
        }
        
    } catch (error) {
        console.error('Check resi error:', error);
        toastError('Check Failed', error.message);
    }
}


// Helper function untuk get resi data by ID
async function getResiDataById(resiId) {
    try {
        const result = await apiCall('tracking_resi');
        if (result.success && result.data) {
            return result.data.find(item => item.id == resiId);
        }
        return null;
    } catch (error) {
        console.error('Error getting resi data:', error);
        return null;
    }
}


// Function untuk view resi detail dengan data real - DEBUG VERSION
async function viewResiDetail(resiId) {
    try {
        // Show modal dan loading state
        showDetailTrackingModal();
        
        // Get resi data dari database
        const resiData = await getResiDataById(resiId);
        if (!resiData) {
            toastError('Data Not Found', 'Data resi tidak ditemukan');
            closeDetailTrackingModal();
            return;
        }
        
        // ✅ STEP 1: Ambil data lama dari database dulu (PERSISTEN)
        let savedData = {
            status_raw: 'ON PROCESS',
            penerima: 'Belum diketahui',
            shipper: 'CHEMZ COLLECTION',
            origin: 'Data tidak tersedia',
            destination: 'Data tidak tersedia',
            history: []
        };
        
        // Parse saved data kalau ada
        if (resiData.binderbyte_response) {
            try {
                const parsed = JSON.parse(resiData.binderbyte_response);
                savedData = {
                    status_raw: parsed.status_raw || savedData.status_raw,
                    penerima: parsed.penerima || savedData.penerima,
                    shipper: parsed.shipper || savedData.shipper,
                    origin: parsed.origin || savedData.origin,
                    destination: parsed.destination || savedData.destination,
                    history: parsed.history || []
                };
                console.log('✅ Found saved data in database');
            } catch (parseError) {
                console.log('⚠️ Error parsing saved data, using defaults');
            }
        }
        
        // ✅ STEP 2: Coba hit API untuk data TERBARU (optional)
        let finalData = { ...savedData }; // Default: pakai data lama
        let dataSource = 'database';
        
        try {
            console.log('🔄 Trying to get fresh data from API...');
            const response = await fetch(`https://ersetsolution.my.id/autocheck.php?action=check_resi_binderbyte&resi=${resiData.no_resi}`);
            const result = await response.json();
            
            if (result.success && result.tracking) {
                // ✅ API sukses: Update dengan data terbaru
                finalData = {
                    status_raw: result.tracking.status_raw || savedData.status_raw,
                    penerima: result.tracking.penerima || savedData.penerima,
                    shipper: result.tracking.shipper || savedData.shipper,
                    origin: result.tracking.origin || savedData.origin,
                    destination: result.tracking.destination || savedData.destination,
                    history: mergeTrackingHistory(savedData.history, result.history || [])
                };
                dataSource = 'api_fresh';
                console.log('✅ Got fresh data from API, merged with saved data');
            } else {
                console.log('⚠️ API failed, using saved data only');
                dataSource = 'database_fallback';
            }
        } catch (apiError) {
            console.log('⚠️ API error:', apiError.message, '- using saved data');
            dataSource = 'database_error';
        }
        
        // ✅ STEP 3: Set final values untuk rendering
        let realStatus = finalData.status_raw;
        let realPenerima = finalData.penerima;
        let realPengirim = finalData.shipper;
        let realKurir = resiData.ekspedisi; // Dari database resi
        let realAsal = finalData.origin;
        let realTujuan = finalData.destination;
        let trackingHistory = finalData.history;

        console.log('🎯 FINAL VALUES:', {realStatus, realPenerima, realKurir, realAsal, realTujuan, dataSource});
        
        // Clean up asal/tujuan yang terlalu panjang
        if (realAsal && realAsal.length > 100) {
            realAsal = extractCityFromAddress(realAsal);
        }
        if (realTujuan && realTujuan.length > 100) {
            realTujuan = extractCityFromAddress(realTujuan);
        }
        
        // ✅ STEP 4: SELALU render modal dengan data yang ada (UI SAMA)
        const modal = document.getElementById('detail-tracking-modal');
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Detail Tracking</h3>
                    <button class="modal-close" onclick="closeDetailTrackingModal()">×</button>
                </div>
                <div style="padding: 1.25rem;">
                    <!-- Info Cards Grid 3x2 -->
                    <div class="detail-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); padding: 1rem; border-radius: 8px;">
                            <div style="color: #3b82f6; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">NO RESI</div>
                            <div style="font-family: monospace; font-weight: 700; font-size: 1.1rem; color: #f1f5f9;">${resiData.no_resi}</div>
                        </div>
                        
                        <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); padding: 1rem; border-radius: 8px;">
                            <div style="color: #22c55e; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">EKSPEDISI</div>
                            <div>${generateCourierBadge(realKurir)}</div>
                        </div>
                        
                        <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.2); padding: 1rem; border-radius: 8px;">
                            <div style="color: #fbbf24; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">STATUS</div>
                            <div><span class="status shipped" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">${realStatus}</span></div>
                        </div>
                        
                        <div style="background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.2); padding: 1rem; border-radius: 8px;">
                            <div style="color: #a855f7; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">PENERIMA</div>
                            <div style="color: #f1f5f9;">${realPenerima}</div>
                        </div>
                        
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: 1rem; border-radius: 8px;">
                            <div style="color: #ef4444; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">PENGIRIM</div>
                            <div style="color: #f1f5f9;">${realPengirim}</div>
                        </div>
                        
                        <div style="background: rgba(14, 165, 233, 0.1); border: 1px solid rgba(14, 165, 233, 0.2); padding: 1rem; border-radius: 8px;">
                            <div style="color: #0ea5e9; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">JAM SCAN</div>
                            <div style="font-family: monospace; color: #f1f5f9; font-weight: 600;">${resiData.jam}</div>
                        </div>
                    </div>
                    
                    <!-- Asal & Tujuan -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 8px;">
                            <div style="color: #f1f5f9; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">ASAL</div>
                            <div style="color: #94a3b8; font-size: 0.875rem; line-height: 1.4;">${realAsal}</div>
                        </div>
                        
                        <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 8px;">
                            <div style="color: #f1f5f9; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">TUJUAN</div>
                            <div style="color: #94a3b8; font-size: 0.875rem; line-height: 1.4;">${realTujuan}</div>
                        </div>
                    </div>
                    
                    <!-- History Tracking Section -->
                    <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1.5rem;">
                        <h4 style="color: #f1f5f9; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; font-size: 1.1rem; font-weight: 600;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: #3b82f6;">
                                <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/>
                            </svg>
                            History Tracking ${dataSource === 'api_fresh' ? '<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">TERBARU</span>' : '<span style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">TERSIMPAN</span>'}
                        </h4>
                        <div style="max-height: 400px; overflow-y: auto; padding-right: 0.5rem;">
                            ${renderTrackingHistory(trackingHistory)}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('❌ Error loading resi detail:', error);
        toastError('Load Error', 'Gagal memuat detail resi');
        closeDetailTrackingModal();
    }
}

// ✅ NEW: Function untuk merge history lama dengan baru
function mergeTrackingHistory(savedHistory, newHistory) {
    if (!newHistory || newHistory.length === 0) {
        return savedHistory || [];
    }
    
    if (!savedHistory || savedHistory.length === 0) {
        return newHistory;
    }
    
    // Gabungkan dan hapus duplikat berdasarkan date + desc
    const merged = [...newHistory];
    
    savedHistory.forEach(savedItem => {
        const isDuplicate = newHistory.some(newItem => 
            (newItem.date || newItem.datetime) === (savedItem.date || savedItem.datetime) &&
            (newItem.desc || newItem.description) === (savedItem.desc || savedItem.description)
        );
        
        if (!isDuplicate) {
            merged.push(savedItem);
        }
    });
    
    // Sort by date (terbaru di atas)
    return merged.sort((a, b) => {
        const dateA = new Date(a.date || a.datetime || '1970-01-01');
        const dateB = new Date(b.date || b.datetime || '1970-01-01');
        return dateB - dateA;
    });
}

// Helper function untuk extract kota dari alamat lengkap - ENHANCED
function extractCityFromAddress(fullAddress) {
    if (!fullAddress || fullAddress.trim() === '') {
        return 'Data tidak tersedia';
    }
    
    // ✅ FIX: Enhanced patterns untuk extract kota/kabupaten
    const cityPatterns = [
        // "Jakarta Barat", "Jakarta Selatan", etc
        /jakarta\s+(utara|selatan|timur|barat|pusat)/gi,
        // "Kab. Sumedang", "Kabupaten Sumedang"  
        /kab\.?\s+([a-zA-Z\s]+)/gi,
        /kabupaten\s+([a-zA-Z\s]+)/gi,
        // "Kota Bandung", "Kota Bekasi"
        /kota\s+([a-zA-Z\s]+)/gi,
        // "Cengkareng, Jakarta Barat"
        /([a-zA-Z\s]+),\s*jakarta\s+(utara|selatan|timur|barat|pusat)/gi,
        // "Bogor, Jawa Barat" pattern
        /([a-zA-Z\s]+),\s*([a-zA-Z\s]+)/gi,
    ];
    
    // Try patterns first
    for (const pattern of cityPatterns) {
        const match = fullAddress.match(pattern);
        if (match && match[0]) {
            return match[0].trim();
        }
    }
    
    // ✅ FIX: Better fallback strategy
    const words = fullAddress.split(/[,\s]+/).filter(w => w.length > 2); // Filter minimal 3 char
    if (words.length >= 3) {
        // Ambil 3 kata pertama yang mungkin nama kota/kecamatan
        return words.slice(0, 3).join(' ');
    } else if (words.length >= 2) {
        // Ambil 2 kata pertama
        return words.slice(0, 2).join(' ');
    }
    
    // Final fallback: return first 60 chars
    return fullAddress.length > 60 ? fullAddress.substring(0, 60) + '...' : fullAddress;
}

// Function untuk render tracking history (STANDALONE) - TIDAK BERUBAH
function renderTrackingHistory(historyArray) {
    if (!historyArray || historyArray.length === 0) {
        return `
            <div style="text-align: center; color: #94a3b8; padding: 3rem 1rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">📦</div>
                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Belum Ada History</div>
                <div style="font-size: 0.9rem;">Tracking history akan muncul setelah paket diproses</div>
            </div>
        `;
    }
    
    return historyArray.map((item, index) => {
        const isLatest = index === 0;
        const isLast = index === historyArray.length - 1;
        
        return `
            <div style="display: flex; gap: 1rem; margin-bottom: ${isLast ? '0' : '1.5rem'}; position: relative;">
                <!-- Timeline Dot -->
                <div style="flex-shrink: 0; width: 12px; height: 12px; background: ${isLatest ? '#22c55e' : '#64748b'}; border-radius: 50%; margin-top: 0.25rem; position: relative; z-index: 2; ${isLatest ? 'box-shadow: 0 0 10px rgba(34, 197, 94, 0.6);' : ''}"></div>
                
                <!-- Timeline Line -->
                ${!isLast ? '<div style="position: absolute; left: 5px; top: 16px; width: 2px; height: calc(100% + 0.5rem); background: rgba(255, 255, 255, 0.1); z-index: 1;"></div>' : ''}
                
                <!-- Content -->
                <div style="flex: 1; padding-left: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.5rem;">
                        <div style="font-weight: 600; color: ${isLatest ? '#22c55e' : '#f1f5f9'}; font-size: 0.9rem; font-family: monospace;">
                            ${item.date || item.datetime || '-'}
                        </div>
                        ${isLatest ? '<div style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 600;">TERBARU</div>' : ''}
                    </div>
                    <div style="color: ${isLatest ? '#f1f5f9' : '#94a3b8'}; line-height: 1.4; font-size: 0.9rem;">
                        ${item.desc || item.description || item.message || 'No description available'}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}



async function deleteResiTracking(resiId) {
    if (!confirm('Yakin ingin menghapus tracking resi ini?')) {
        return;
    }
    
    try {
        toastInfo('Deleting...', 'Menghapus resi dari tracking');
        
        const result = await apiCall(`tracking_resi&id=${resiId}`, 'DELETE');
        
        if (result.success) {
            toastSuccess('Resi Deleted', 'Resi berhasil dihapus dari tracking!');
            loadPendingResiTable();
        } else {
            toastError('Delete Failed', result.error || 'Gagal menghapus resi');
        }
        
    } catch (error) {
        toastError('Delete Failed', error.message);
    }
}



// Function untuk show modal detail
function showDetailTrackingModal() {
    document.getElementById('detail-tracking-modal').style.display = 'block';
}

// Function untuk close modal detail  
function closeDetailTrackingModal() {
    document.getElementById('detail-tracking-modal').style.display = 'none';
}

// FIX: loadPendingResiTable() - Hanya show yang benar-benar pending
async function loadPendingResiTable() {
    try {
        const container = document.getElementById('pending-resi-table');
        container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading resi pending...</div>';
        
        const result = await apiCall('tracking_resi');
        
        if (!result.success || !result.data || result.data.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Belum Ada Resi</div>
                    <div style="font-size: 0.9rem;">Scan resi pertama untuk melihat tracking</div>
                </div>
            `;
            return;
        }
        
        // ✅ FIX: HANYA pending yang muncul di Resi Pending
const pendingOnly = result.data.filter(item => {
    return item.status === 'pending';  // ← CUMA pending aja!
    // EXCLUDE: 'on_process', 'shipped', 'delivered', 'return', 'error'
});
        
        if (pendingOnly.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #22c55e;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Semua Resi Sudah Diproses!</div>
                    <div style="font-size: 0.9rem;">Tidak ada resi pending yang perlu dicek</div>
                </div>
            `;
            return;
        }
        
        // Render table dengan data yang sudah difilter
        container.innerHTML = `
            <div style="overflow: visible;">
                <table class="products-table" style="width: 100%; table-layout: fixed;">
                    <thead>
                        <tr>
                            <th style="width: 50px;">NO</th>
                            <th style="width: 120px;">TANGGAL</th>
                            <th style="width: 140px;">NO RESI</th>
                            <th style="width: 120px;">EKSPEDISI</th>
                            <th style="width: 80px;">JAM</th>
                            <th style="width: 90px;">STATUS</th>
                            <th style="width: 150px;">ACTION</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pendingOnly.map((item, index) => {
                            const statusValue = item.status || 'pending';
                            const statusClass = getStatusClass(statusValue);
                            const kurirBadge = generateCourierBadge(item.ekspedisi);
                            const tanggal = new Date(item.tanggal).toLocaleDateString('id-ID');
                            
                            return `
                                <tr>
                                    <td style="text-align: center; font-weight: 600;">${index + 1}</td>
                                    <td style="font-size: 0.85rem;">${tanggal}</td>
                                    <td style="font-family: monospace; font-weight: 600; font-size: 0.85rem;">${item.no_resi}</td>
                                    <td>${kurirBadge}</td>
                                    <td style="font-size: 0.85rem;">${item.jam}</td>
                                    <td><span class="status ${statusClass}">${statusValue.toUpperCase()}</span></td>
                                    <td>
                                        <button class="btn-icon" onclick="checkResiBinderbyte('${item.id}')" title="Check Status" style="margin-right: 0.25rem;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M1 4v6h6"/>
                                                <path d="M23 20v-6h-6"/>
                                                <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                                            </svg>
                                        </button>
                                        <button class="btn-icon" onclick="viewResiDetail('${item.id}')" title="View Detail" style="margin-right: 0.25rem;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                                <circle cx="12" cy="12" r="3"/>
                                            </svg>
                                        </button>
                                        <button class="btn-icon" onclick="deleteResiTracking('${item.id}')" title="Delete" style="color: #ef4444;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3,6 5,6 21,6"/>
                                                <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading resi table:', error);
        document.getElementById('pending-resi-table').innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #ef4444;">
                Error loading data: ${error.message}
            </div>
        `;
    }
}

// Helper function untuk status class - UPDATED
function getStatusClass(status) {
    if (!status) return 'pending';
    
    switch (status.toLowerCase()) {
        case 'pending': return 'pending';
        case 'on_process': return 'shipped';
        case 'delivered': return 'delivered';
        case 'return': return 'return';
        case 'error': return 'return';
        default: return 'pending';
    }
}

// ===========================================
// MONITOR TAB FUNCTIONS (NEW)
// ===========================================

/**
 * Load monitor data - main function
 */
async function loadMonitorData() {
    try {
        console.log('🔄 Loading monitor data...');
        
        // Load tracking statistics
        await loadTrackingStatistics();
        
        // Load auto check status
        await loadAutoCheckStatus();
        
        // Load recent activity
        await loadRecentActivity();
        
        // Load top expeditions
        await loadTopExpeditions();
        
        console.log('✅ Monitor data loaded successfully');
        
    } catch (error) {
        console.error('❌ Error loading monitor data:', error);
        toastError('Monitor Error', 'Gagal memuat data monitor');
    }
}

/**
 * Load tracking statistics from API
 */
async function loadTrackingStatistics() {
    try {
        const result = await apiCall('tracking_resi');
        
        if (!result.success || !Array.isArray(result.data)) {
            throw new Error('Invalid tracking data response');
        }
        
        const data = result.data;
        const total = data.length;
        
        // Count by status
        const pending = data.filter(r => r.status === 'pending').length;
        const shipped = data.filter(r => r.status === 'shipped' || r.status === 'on_process').length;
        const delivered = data.filter(r => r.status === 'delivered').length;
        const returned = data.filter(r => r.status === 'return' || r.status === 'error').length;
        
        console.log('📊 Statistics:', { total, pending, shipped, delivered, returned });
        
        // Update values
        document.getElementById('monitor-pending-count').textContent = pending;
        document.getElementById('monitor-shipped-count').textContent = shipped;
        document.getElementById('monitor-delivered-count').textContent = delivered;
        document.getElementById('monitor-return-count').textContent = returned;
        document.getElementById('monitor-total-resi').textContent = total;
        
    } catch (error) {
        console.error('Error loading tracking statistics:', error);
        
        // Set error state
        ['monitor-pending-count', 'monitor-shipped-count', 'monitor-delivered-count', 'monitor-return-count', 'monitor-total-resi'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.textContent = '--';
        });
    }
}

/**
 * Load auto check status
 */
async function loadAutoCheckStatus() {
    try {
        const result = await apiCall('user_settings');
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        // Update status
        const isEnabled = result.auto_check_enabled === true || result.auto_check_enabled === 1;
        const statusElement = document.getElementById('monitor-auto-status');
        if (statusElement) {
            statusElement.textContent = isEnabled ? '🟢 Aktif' : '🔴 Nonaktif';
        }
        
        // Update interval
        const intervalElement = document.getElementById('monitor-interval');
        if (intervalElement) {
            const interval = result.auto_check_interval || 30;
            intervalElement.textContent = `Setiap ${interval} menit`;
        }
        
        // Update last check time
        const lastCheckElement = document.getElementById('monitor-last-check');
        if (lastCheckElement && result.last_check_timestamp) {
            const lastCheck = new Date(result.last_check_timestamp);
            const now = new Date();
            const diffMinutes = Math.round((now - lastCheck) / (1000 * 60));
            
            let timeText = '';
            if (diffMinutes < 1) {
                timeText = 'Baru saja';
            } else if (diffMinutes < 60) {
                timeText = `${diffMinutes} menit yang lalu`;
            } else {
                const diffHours = Math.round(diffMinutes / 60);
                timeText = `${diffHours} jam yang lalu`;
            }
            
            lastCheckElement.textContent = timeText;
        }
        
    } catch (error) {
        console.error('Error loading auto check status:', error);
        
        // Set default values
        const statusElement = document.getElementById('monitor-auto-status');
        if (statusElement) statusElement.textContent = '🔴 Unknown';
    }
}

/**
 * Refresh monitor data manually
 */
async function refreshMonitorData() {
    toastInfo('Refreshing...', 'Memperbarui data monitor');
    await loadMonitorData();
    toastSuccess('Data Refreshed', 'Data monitor berhasil diperbarui!');
}

/**
 * Run manual auto check
 */
async function runManualCheck() {
    try {
        toastInfo('Running Check...', 'Menjalankan auto check manual');
        
        const result = await apiCall('run_auto_check_tracking');
        
        if (result.success) {
            toastSuccess('Manual Check Complete', `${result.checked_count || 0} resi berhasil dicek!`);
            
            // Refresh data after manual check
            setTimeout(() => {
                loadMonitorData();
            }, 2000);
            
        } else {
            toastError('Manual Check Failed', result.error || 'Gagal menjalankan manual check');
        }
        
    } catch (error) {
        console.error('Error running manual check:', error);
        toastError('Check Error', 'Gagal menjalankan manual check');
    }
}

/**
 * Load recent activity logs
 */
/**
 * Load recent activity logs - SMART FALLBACK
 */
/**
 * Load recent activity logs - REAL DATA ONLY
 */
async function loadRecentActivity() {
    try {
        const result = await apiCall('auto_check_logs&limit=10');
        const tbody = document.getElementById('monitor-activity-tbody');
        
        // ✅ PURE REAL API DATA ONLY
        if (result.success && Array.isArray(result.logs) && result.logs.length > 0) {
            console.log('✅ Loaded', result.logs.length, 'real activity logs');
            
            tbody.innerHTML = result.logs.map(log => {
                const time = new Date(log.check_timestamp).toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const statusChange = `${log.old_status} → ${log.new_status}`;
                const changeColor = getStatusChangeColor(log.old_status, log.new_status);
                
                return `
                    <tr>
                        <td style="font-family: monospace; color: #94a3b8; font-size: 0.8rem;">${time}</td>
                        <td style="font-family: monospace; font-weight: 600; color: #3b82f6;">${log.resi_number}</td>
                        <td style="color: ${changeColor}; font-weight: 600;">${statusChange}</td>
                        <td>${generateCourierBadge(log.kurir)}</td>
                    </tr>
                `;
            }).join('');
            return;
        }
        
        // ❌ NO REAL DATA = SHOW EMPTY STATE
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; color: #94a3b8; padding: 2rem;">
                    <div style="opacity: 0.7;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">📋</div>
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">Belum ada activity logs</div>
                        <div style="font-size: 0.8rem;">Auto check belum berjalan atau belum ada perubahan status</div>
                    </div>
                </td>
            </tr>
        `;
        
    } catch (error) {
        console.error('❌ Error loading activity logs:', error);
        document.getElementById('monitor-activity-tbody').innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; color: #ef4444; padding: 2rem;">
                    <div style="opacity: 0.7;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">⚠️</div>
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">Error loading activity</div>
                        <div style="font-size: 0.8rem;">${error.message}</div>
                    </div>
                </td>
            </tr>
        `;
    }
}

/**
 * Get color for status change
 */
function getStatusChangeColor(oldStatus, newStatus) {
    if (newStatus === 'delivered') return '#22c55e'; // Green
    if (newStatus === 'shipped' || newStatus === 'on_process') return '#3b82f6'; // Blue
    if (newStatus === 'return' || newStatus === 'error') return '#ef4444'; // Red
    return '#f59e0b'; // Orange (pending)
}

/**
 * Load top expeditions
 */
async function loadTopExpeditions() {
    try {
        const result = await apiCall('tracking_resi');
        
        if (!result.success || !Array.isArray(result.data)) {
            throw new Error('Invalid tracking data');
        }
        
        // Count by expedition
        const expeditionCounts = {};
        result.data.forEach(resi => {
            const expedition = resi.ekspedisi || 'Unknown';
            expeditionCounts[expedition] = (expeditionCounts[expedition] || 0) + 1;
        });
        
        // Sort by count and take top 5
        const topExpeditions = Object.entries(expeditionCounts)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5);
        
        const container = document.getElementById('monitor-top-expeditions-list');
        
        if (topExpeditions.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; color: #94a3b8; padding: 2rem;">
                    Belum ada data ekspedisi
                </div>
            `;
            return;
        }
        
        container.innerHTML = topExpeditions.map(([expedition, count], index) => `
            <div class="monitor-expedition-item">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="background: #3b82f6; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700;">
                        ${index + 1}
                    </div>
                    <div class="monitor-expedition-name">${expedition}</div>
                </div>
                <div class="monitor-expedition-count">${count} resi</div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading top expeditions:', error);
        document.getElementById('monitor-top-expeditions-list').innerHTML = `
            <div style="text-align: center; color: #ef4444; padding: 2rem;">
                Error loading expeditions
            </div>
        `;
    }
}


// Event listener untuk auto-detect real-time
document.addEventListener('DOMContentLoaded', function() {
    const resiInput = document.getElementById('detect-resi');
    if (resiInput) {
        // ✅ ENTER key handler (manual + scanner support)
        resiInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault();
                const resiNumber = this.value.trim();
                if (resiNumber.length >= 8) { // Minimal 8 karakter
                    detectKurirFromResi();
                } else {
                    toastWarning('Resi Terlalu Pendek', 'Masukkan minimal 8 karakter');
                }
            }
        });
        
        // ✅ Auto-focus saat halaman load
        resiInput.focus();
    }
});


/**
 * Show bulk import modal
 */
function showBulkImportModal() {
    document.getElementById('bulk-import-modal').style.display = 'block';
}

/**
 * Close bulk import modal
 */
function closeBulkImportModal() {
    document.getElementById('bulk-import-modal').style.display = 'none';
    document.getElementById('bulk-resi-input').value = '';
}

/**
 * Process bulk import resi
 */
async function processBulkImport() {
    const input = document.getElementById('bulk-resi-input').value.trim();
    
    if (!input) {
        toastWarning('Input Kosong', 'Masukkan nomor resi terlebih dahulu!');
        return;
    }
    
    // Split by line dan filter yang kosong
    const resiList = input.split('\n').map(r => r.trim()).filter(r => r.length > 0);
    
    if (resiList.length === 0) {
        toastWarning('No Valid Resi', 'Tidak ada nomor resi yang valid!');
        return;
    }
    
    // Show loading toast
    const loadingToast = toastInfo('Processing...', `Importing ${resiList.length} resi ke database...`);
    
    let successCount = 0;
    let errorCount = 0;
    let duplicateCount = 0;
    
    try {
        // ✅ CHECK EXISTING RESI untuk detect duplicate
        const existingResi = await apiCall('tracking_resi');
        const existingResiNumbers = existingResi.success && Array.isArray(existingResi.data) 
            ? existingResi.data.map(item => item.no_resi) 
            : [];
        
        // ✅ PROCESS EACH RESI
        for (const resi of resiList) {
            try {
                // Check duplicate
                if (existingResiNumbers.includes(resi)) {
                    console.log(`⚠️ Duplicate resi skipped: ${resi}`);
                    duplicateCount++;
                    continue;
                }
                
                // Detect kurir
                const kurir = detectEkspedisi(resi);
                
                // Save ke database
                await saveResiToDatabase(resi, kurir);
                
                console.log(`✅ Saved: ${resi} (${kurir})`);
                successCount++;
                
            } catch (error) {
                console.error(`❌ Error saving ${resi}:`, error);
                errorCount++;
            }
        }
        
        // ✅ REMOVE LOADING TOAST
        removeToast(loadingToast);
        
        // ✅ SHOW RESULT
        if (successCount > 0) {
            toastSuccess(
                'Bulk Import Berhasil! 🎉', 
                `✅ ${successCount} resi berhasil disimpan\n` +
                `⚠️ ${duplicateCount} resi duplicate (di-skip)\n` +
                `❌ ${errorCount} resi gagal`
            );
        } else {
            toastWarning(
                'Import Tidak Ada Yang Berhasil', 
                `⚠️ ${duplicateCount} resi duplicate\n❌ ${errorCount} resi gagal`
            );
        }
        
        // ✅ CLOSE MODAL DAN REFRESH
        closeBulkImportModal();
        
        // Refresh tracking tables jika ada
        if (typeof loadPendingResiTable === 'function') {
            loadPendingResiTable();
        }
        if (typeof loadResiManagementData === 'function') {
            loadResiManagementData();
        }
        
    } catch (error) {
        removeToast(loadingToast);
        console.error('Bulk import error:', error);
        toastError('Import Error', 'Gagal import bulk resi: ' + error.message);
    }
}

        function showSettings() {
    showPage('settings-page');
    
    // Update sidebar active state
    document.querySelectorAll('.sidebar-item').forEach(nav => {
        nav.classList.remove('active');
    });
    
    // Find and activate settings sidebar item
    const settingsItem = document.querySelector('.sidebar-item[onclick="showSettings()"]');
    if (settingsItem) {
        settingsItem.classList.add('active');
    }
    
    // Load initial settings data
    loadUserSettings();
}

        function showNotifications() {
            alert('🔔 Fitur notifikasi akan segera hadir!');
        }


// ===========================================
// SETTINGS FUNCTIONS
// ===========================================

/**
 * Switch settings tabs
 */
function switchSettingsTab(tabId, element) {
    // Hide all tab contents in settings page
    document.querySelectorAll('#settings-page .tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tab buttons in settings page
    document.querySelectorAll('#settings-page .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    element.classList.add('active');
    
    // Load data berdasarkan tab
    if (tabId === 'user-settings') {
        loadUserSettings();
    } else if (tabId === 'auto-check-settings') {
        loadAutoCheckSettings();
    }
}

/**
 * Load user settings from backend
 */
async function loadUserSettings() {
    try {
        const response = await fetch('https://ersetsolution.my.id/autocheck.php?action=user_settings');
        const data = await response.json();
        
        if (data.error) {
            toastError('Settings Error', data.error);
            return;
        }
        
        document.getElementById('user-name').value = data.user_name || 'Surya';
        document.getElementById('device-name').value = data.device_name || 'V12';
        
        toastSuccess('Settings Loaded', 'User settings berhasil dimuat');
        
    } catch (error) {
        toastError('Load Error', 'Gagal memuat user settings');
    }
}

/**
 * Load auto check settings
 */
async function loadAutoCheckSettings() {
    try {
        const response = await fetch('https://ersetsolution.my.id/autocheck.php?action=user_settings');
        const data = await response.json();
        
        if (data.error) {
            toastError('Settings Error', data.error);
            return;
        }
        
        // Update form values
        document.getElementById('check-interval').value = data.auto_check_interval || 30;
        document.querySelector(`input[name="auto-check-enabled"][value="${data.auto_check_enabled}"]`).checked = true;
        document.getElementById('binderbyte-api').value = data.binderbyte_api_key || '';
        
        // Update status indicator
        const statusEl = document.getElementById('auto-check-status');
        if (data.auto_check_enabled) {
            statusEl.textContent = '🟢 Aktif';
            statusEl.className = 'status delivered';
        } else {
            statusEl.textContent = '🔴 Nonaktif';
            statusEl.className = 'status return';
        }
        
        toastInfo('Settings Loaded', 'Auto check settings berhasil dimuat');
        
    } catch (error) {
        console.error('Error loading auto check settings:', error);
        toastError('Load Error', 'Gagal memuat auto check settings');
    }
}

/**
 * Test API connection
 */
async function testApiConnection() {
    try {
        toastInfo('Testing...', 'Mengetes koneksi API backend');
        
        const data = await apiCall('test');
        
        if (data.success) {
            toastSuccess('API Connection OK', `Backend response: ${data.message}`);
        } else {
            toastError('API Test Failed', data.error || 'API test gagal');
        }
        
    } catch (error) {
        toastError('Connection Error', 'Backend tidak bisa dihubungi');
    }
}


        // ===========================================
        // API FUNCTIONS
        // ===========================================
        
        
        
        
        
        
        
       /**
 * Generic API call function with dual endpoint routing
 */
async function apiCall(action, method = 'GET', data = null) {
    try {
        // Auto check actions → autocheck.php
        const autoCheckActions = ['user_settings', 'auto_check_logs', 'run_auto_check', 'pending_orders', 'create_tables', 'check_tables', 'test', 'tracking_resi', 'tracking_resi_stats'];
        
        // Template & messaging actions → templates.php  
        const templateActions = ['message_templates', 'message_template', 'send_whatsapp', 'system_settings', 'get_templates', 'get_settings', 'send_notification', 'test_connection'];
        
        // Extract base action (before &) untuk check routing
        const baseAction = action.split('&')[0];
        
        let url;
        if (autoCheckActions.includes(baseAction)) {
            // Auto check endpoint
            url = `https://ersetsolution.my.id/autocheck.php?action=${action}`;
        } else if (templateActions.includes(baseAction)) {
            // ✅ FIX - Tambah full URL
            url = `https://ersetsolution.my.id/templates.php?action=${action}`;
        } else {
            // Default backend endpoint
            url = `https://ersetsolution.my.id/api.php?action=${action}`;
        }
        
        console.log(`🔗 API Call: ${baseAction} → ${url}`);
        
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            }
        };
        
        if (data && method !== 'GET') {
            options.body = JSON.stringify(data);
        }
        
        const response = await fetch(url, options);
        const result = await response.json();
        
        console.log(`✅ API Response for ${baseAction}:`, result);
        return result;
        
    } catch (error) {
        console.error(`❌ API Error for ${action}:`, error);
        return { error: error.message };
    }
}
        // ===========================================
        // DASHBOARD FUNCTIONS
        // ===========================================
        
        /**
         * Load dashboard data
         */
        async function loadDashboardData() {
            try {
                const data = await apiCall('dashboard');
                
                document.getElementById('orders-today').textContent = data.orders_today || 0;
                document.getElementById('profit-today').textContent = formatCurrency(data.profit_today || 0);

                // Load additional stats
                const customersData = await apiCall('customers');
                const productsData = await apiCall('products');
                
                document.getElementById('total-customers').textContent = Array.isArray(customersData) ? customersData.length : 0;
                document.getElementById('total-products').textContent = Array.isArray(productsData) ? productsData.length : 0;

                loadRecentOrders();
            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        /**
         * Load recent orders for dashboard
         */
        async function loadRecentOrders() {
            try {
                const data = await apiCall('orders');
                const container = document.getElementById('recent-orders');
                
                if (!Array.isArray(data) || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 4V2c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v2h4c1.1 0 2 .9 2 2v14c0 1.1-.9 2-2 2H3c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h4zM9 4h6V2H9v2zm8 4H7v2h10V8z"/>
                            </svg>
                            <div>Belum ada order hari ini</div>
                        </div>
                    `;
                    return;
                }

                // Show only recent 5 orders
                const recent = data.slice(0, 5);
                container.innerHTML = recent.map(order => `
                    <div class="list-item">
                        <div class="list-item-header">
                            <div class="list-item-title">${order.customer_name}</div>
                            <div class="status ${order.status}">${order.status}</div>
                        </div>
                        <div class="list-item-meta">
                            ${order.nama_barang} × ${order.qty} • ${formatCurrency(order.subtotal)}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('recent-orders').innerHTML = '<div class="empty-state">Error loading orders</div>';
            }
        }

        // ===========================================
        // ORDERS FUNCTIONS
        // ===========================================
        
        /**
         * Load orders list
         */
        async function loadOrders() {
            try {
                const data = await apiCall('orders');
                const container = document.getElementById('recent-orders');
                
                if (!Array.isArray(data) || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 4V2c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v2h4c1.1 0 2 .9 2 2v14c0 1.1-.9 2-2 2H3c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h4zM9 4h6V2H9v2zm8 4H7v2h10V8z"/>
                            </svg>
                            <div>Belum ada order</div>
                        </div>
                    `;
                    return;
                }

                orders = data;
                container.innerHTML = data.map(order => `
                    <div class="list-item">
                        <div class="list-item-header">
                            <div>
                                <div class="list-item-title">${order.order_id}</div>
                                <div class="list-item-meta">${order.customer_name} • ${order.no_hp}</div>
                            </div>
                            <div class="status ${order.status}">${order.status}</div>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <div><strong>${order.nama_barang}</strong> × ${order.qty}</div>
                            <div style="display: flex; justify-content: between; margin-top: 0.25rem;">
                                <span>Total: ${formatCurrency(order.subtotal)}</span>
                                <span style="color: #22c55e; margin-left: auto;">Profit: ${formatCurrency(order.total_profit)}</span>
                            </div>
                            ${order.resi_number ? `<div style="margin-top: 0.25rem; color: #94a3b8;">Resi: ${order.resi_number}</div>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('recent-orders').innerHTML = '<div class="empty-state">Error loading orders</div>';
            }
        }

        /**
         * Load orders history dengan improved table (ENHANCED)
         */
        async function loadOrdersHistory() {
            try {
                const data = await apiCall('orders');
                const tableBody = document.getElementById('orders-history-table-body');
                const mobileContainer = document.getElementById('mobile-orders-cards');
                
                if (!Array.isArray(data) || data.length === 0) {
                    // Empty state untuk table
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="11" style="text-align: center; color: #94a3b8; padding: 3rem;">
                                Belum ada riwayat order
                            </td>
                        </tr>
                    `;
                    
                    // Empty state untuk mobile cards
                    mobileContainer.innerHTML = `
                        <div style="text-align: center; color: #94a3b8; padding: 3rem 1rem;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.5; margin-bottom: 1rem;">
                                <path d="M7 4V2c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v2h4c1.1 0 2 .9 2 2v14c0 1.1-.9 2-2 2H3c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h4zM9 4h6V2H9v2zm8 4H7v2h10V8z"/>
                            </svg>
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Belum Ada Order</div>
                            <div style="font-size: 0.9rem;">Mulai buat order pertama Anda!</div>
                        </div>
                    `;
                    return;
                }

                // ===== RENDER DESKTOP TABLE =====
                tableBody.innerHTML = data.map(order => {
                    const statusBadge = `<span class="status ${order.status}" style="white-space: nowrap; display: inline-block;">${
    order.status === 'pending' ? 'Menunggu' :
    order.status === 'shipped' ? 'Sedang Dikirim' :
    order.status === 'delivered' ? 'Terkirim' :
    order.status === 'return' ? 'Return' :
    order.status
}</span>`;
                    const actionButtons = getOrderActionButtons(order);
                    
                    // Generate courier badge berdasarkan resi atau manual input
                    let courierBadge = '-';
                    if (order.resi_number) {
                        const detectedCourier = detectEkspedisi(order.resi_number);
                        courierBadge = generateCourierBadge(detectedCourier);
                    } else if (order.kurir) {
                        // Jika ada manual input kurir tapi tidak ada resi
                        const courierMapping = {
                            'jne': 'JNE',
                            'jnt': 'J&T Express', 
                            'sicepat': 'SiCepat Express',
                            'ninja': 'Ninja Express',
                            'pos': 'POS Indonesia',
                            'anteraja': 'Anteraja'
                        };
                        const courierName = courierMapping[order.kurir] || order.kurir;
                        courierBadge = generateCourierBadge(courierName);
                    }

                    // Alamat dengan truncate untuk desktop
                    const alamatDisplay = order.alamat 
                        ? `<div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${order.alamat}">${order.alamat}</div>`
                        : '-';
                    
                    // Format tanggal
                    const orderDate = order.created_at 
                        ? new Date(order.created_at).toLocaleDateString('id-ID', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: '2-digit' 
                          })
                        : new Date().toLocaleDateString('id-ID', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: '2-digit' 
                          });
                    
                   return `
    <tr>
        <td><small style="color: #94a3b8;">${orderDate}</small></td>
        <td><strong>${order.order_id}</strong></td>
        <td>
            ${order.customer_name}<br>
            <small style="color: #94a3b8;">${order.no_hp}</small>
        </td>
        <td>
            ${order.nama_barang}<br>
            <small style="color: #94a3b8;">${order.sku}</small>
        </td>
        <td style="text-align: center;"><strong>${order.qty}</strong></td>
        <td><strong>${formatCurrency(order.subtotal)}</strong></td>
        <td style="text-align: center;">${statusBadge}</td>
        <td>${alamatDisplay}</td>
        <td style="text-align: center;">${courierBadge}</td>
        <td style="text-align: center;">${order.resi_number || '-'}</td>
        <td style="text-align: center;">${actionButtons}</td>
    </tr>
`;
                }).join('');

                // ===== RENDER MOBILE CARDS =====
                mobileContainer.innerHTML = data.map(order => {
                    const statusBadge = `<span class="status ${order.status}">${order.status}</span>`;
                    const actionButtons = getOrderActionButtons(order);
                    
                    // Generate courier badge untuk mobile
                    let courierBadge = `<span class="courier-badge unknown">-</span>`;
                    if (order.resi_number) {
                        const detectedCourier = detectEkspedisi(order.resi_number);
                        courierBadge = generateCourierBadge(detectedCourier);
                    } else if (order.kurir) {
                        const courierMapping = {
                            'jne': 'JNE',
                            'jnt': 'J&T Express', 
                            'sicepat': 'SiCepat Express',
                            'ninja': 'Ninja Express',
                            'pos': 'POS Indonesia',
                            'anteraja': 'Anteraja'
                        };
                        const courierName = courierMapping[order.kurir] || order.kurir;
                        courierBadge = generateCourierBadge(courierName);
                    }

                    // Format tanggal untuk mobile
                    const orderDate = order.created_at 
                        ? new Date(order.created_at).toLocaleDateString('id-ID', { 
                            day: '2-digit', 
                            month: 'short', 
                            year: 'numeric' 
                          })
                        : new Date().toLocaleDateString('id-ID', { 
                            day: '2-digit', 
                            month: 'short', 
                            year: 'numeric' 
                          });
                    
                    return `
                        <div class="mobile-order-card">
                            <!-- Card Header -->
                            <div class="mobile-card-header">
                                <div class="mobile-card-left">
                                    <div class="mobile-card-order-id">${order.order_id}</div>
                                    <div class="mobile-card-date">${orderDate}</div>
                                </div>
                                <div class="mobile-card-status">
                                    ${statusBadge}
                                </div>
                            </div>

                            <!-- Customer Section -->
                            <div class="mobile-card-customer-section">
                                <div class="mobile-card-customer-name">${order.customer_name}</div>
                                <div class="mobile-card-customer-phone">📞 ${order.no_hp}</div>
                            </div>

                            <!-- Product Section -->
                            <div class="mobile-card-product-section">
                                <div class="mobile-card-product-name">${order.nama_barang}</div>
                                <div class="mobile-card-product-sku">SKU: ${order.sku}</div>
                            </div>

                            <!-- Order Details -->
                            <div class="mobile-card-info-row">
                                <span class="mobile-card-label">Qty:</span>
                                <span class="mobile-card-value"><strong>${order.qty} pcs</strong></span>
                            </div>

                            <div class="mobile-card-info-row">
                                <span class="mobile-card-label">Total:</span>
                                <span class="mobile-card-value"><strong>${formatCurrency(order.subtotal)}</strong></span>
                            </div>

                            <div class="mobile-card-info-row">
                                <span class="mobile-card-label">Kurir:</span>
                                <span class="mobile-card-value">${courierBadge}</span>
                            </div>

                            ${order.resi_number ? `
                            <div class="mobile-card-info-row">
                                <span class="mobile-card-label">Resi:</span>
                                <span class="mobile-card-value" style="font-family: monospace; font-size: 0.8rem; word-break: break-all;">${order.resi_number}</span>
                            </div>
                            ` : ''}

                            ${order.alamat ? `
                            <div class="mobile-card-alamat">
                                <span class="mobile-card-alamat-label">📍 Alamat Pengiriman:</span>
                                ${order.alamat}
                            </div>
                            ` : ''}

                            <!-- Actions -->
                            ${actionButtons !== '<span style="color: #22c55e; font-size: 0.8rem;">✅ Complete</span>' ? `
                            <div class="mobile-card-actions">
                                ${actionButtons}
                            </div>
                            ` : `
                            <div class="mobile-card-complete">
                                ✅ Order Complete
                            </div>
                            `}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading orders history:', error);
                
                // Error state untuk table
                document.getElementById('orders-history-table-body').innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; color: #ef4444; padding: 3rem;">
                            Error loading orders history
                        </td>
                    </tr>
                `;
                
                // Error state untuk mobile cards
                document.getElementById('mobile-orders-cards').innerHTML = `
                    <div style="text-align: center; color: #ef4444; padding: 3rem 1rem;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.5; margin-bottom: 1rem;">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/>
                        </svg>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Error Loading Data</div>
                        <div style="font-size: 0.9rem;">Periksa koneksi internet Anda</div>
                        <button class="btn" onclick="loadOrdersHistory()" style="margin-top: 1rem; padding: 0.5rem 1rem; font-size: 0.9rem;">
                            🔄 Coba Lagi
                        </button>
                    </div>
                `;
            }
        }

        /**
         * Generate action buttons berdasarkan status order
         */
 function getOrderActionButtons(order) {
    return `
        <button class="btn-action delete" onclick="deleteOrder(${order.id})" title="Hapus Order" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin: 0 auto;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3,6 5,6 21,6"></polyline>
                <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            Hapus
        </button>
    `;
}



/**
 * Delete order dengan konfirmasi dan auto stock return
 */
async function deleteOrder(orderId) {
    try {
        // ✅ STEP 1: Cari order data untuk konfirmasi
        const orderData = orders.find(o => o.id == orderId);
        if (!orderData) {
            toastError('Error', 'Order tidak ditemukan!');
            return;
        }
        
        // ✅ STEP 2: Konfirmasi hapus dengan detail order
        const confirmMessage = 
            `Yakin ingin menghapus order ini?\n\n` +
            `Order ID: ${orderData.order_id}\n` +
            `Customer: ${orderData.customer_name}\n` +
            `Produk: ${orderData.nama_barang} (${orderData.qty} unit)\n` +
            `Total: ${formatCurrency(orderData.subtotal)}\n\n` +
            `⚠️ Data yang dihapus tidak bisa dikembalikan!\n` +
            `✅ Stock akan otomatis dikembalikan ke inventory.`;
        
        if (!confirm(confirmMessage)) {
            return; // User cancelled
        }
        
        console.log(`🗑️ Deleting order: ${orderData.order_id}`);
        
        // ✅ STEP 3: Delete order dari database
        const result = await apiCall(`order&id=${orderId}`, 'DELETE');
        
        if (result.success) {
            console.log(`✅ Order ${orderData.order_id} deleted successfully`);
            
            // ✅ STEP 4: Auto stock return - buat stock movement "IN"
            try {
                const stockMovementData = {
                    product_id: orderData.product_id,
                    type: 'in',
                    qty: parseInt(orderData.qty),
                    notes: `Auto Return - Cancelled Order: ${orderData.order_id}`,
                    created_by: 'System - Order Cancellation'
                };
                
                console.log(`📦 Creating stock return movement:`, stockMovementData);
                const stockResult = await apiCall('stock_movement', 'POST', stockMovementData);
                
                if (stockResult.success) {
                    console.log(`✅ Stock returned: +${orderData.qty} units`);
                    toastSuccess(
                        'Order Berhasil Dihapus! 🎉', 
                        `Order ${orderData.order_id} berhasil dihapus dan ${orderData.qty} unit stock telah dikembalikan ke inventory!`
                    );
                } else {
                    console.error('❌ Stock movement failed:', stockResult.error);
                    toastError(
                        'Warning: Stock Return Failed',
                        `Order berhasil dihapus, tapi gagal mengembalikan stock: ${stockResult.error || 'Unknown error'}`
                    );
                }
                
            } catch (stockError) {
                console.error('❌ Stock movement error:', stockError);
                toastError(
                    'Warning: Stock Return Error',
                    `Order berhasil dihapus, tapi terjadi error saat mengembalikan stock: ${stockError.message}`
                );
            }
            
            // ✅ STEP 5: Refresh semua data yang terkait
            console.log('🔄 Refreshing all related data...');
            
            // Update global orders array
            orders = orders.filter(o => o.id != orderId);
            
            // Refresh UI components
            loadOrdersHistory();     // History orders table
            loadDashboardData();     // Dashboard stats
            loadCustomers();         // Customer management page  
            loadCustomersForSelect(); // Customer dropdown di order form
            loadProductsForSelect(); // Product dropdown (update stock display)
            
            console.log('✅ All data refreshed successfully');
            
        } else {
            console.error('❌ Order deletion failed:', result.error);
            toastError(
                'Gagal Menghapus Order', 
                result.error || 'Terjadi error saat menghapus order dari database'
            );
        }
        
    } catch (error) {
        console.error('❌ Critical error in deleteOrder:', error);
        toastError(
            'Network Error', 
            `Gagal menghapus order: ${error.message}\n\nPeriksa koneksi internet Anda.`
        );
    }
}

        /**
         * Load customers for select dropdown
         */
        async function loadCustomersForSelect() {
            try {
                const data = await apiCall('customers');
                customers = Array.isArray(data) ? data : [];
                
                const select = document.getElementById('customer-select');
                select.innerHTML = '<option value="">Pilih Customer...</option>' + 
                    customers.map(customer => 
                        `<option value="${customer.id}">${customer.nama} (${customer.no_hp})</option>`
                    ).join('');
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        /**
         * Load products for select dropdown
         */
        /**
 * Load products for select dropdown
 */
async function loadProductsForSelect() {
    try {
        // Load products dan movements
        const [productsData, movementsData] = await Promise.all([
            apiCall('products'),
            apiCall('stock_movements')
        ]);
        
        const productsList = Array.isArray(productsData) ? productsData : [];
        const movementsList = Array.isArray(movementsData) ? movementsData : [];
        
        // Hitung real stock untuk setiap produk
        const productsWithRealStock = productsList.map(product => {
            // Filter movements untuk produk ini
            const productMovements = movementsList.filter(m => m.product_id == product.id);
            
            // Hitung stock in dan out
            const stockIn = productMovements
                .filter(m => m.type === 'in')
                .reduce((sum, m) => sum + parseInt(m.qty), 0);
                
            const stockOut = productMovements
                .filter(m => m.type === 'out')
                .reduce((sum, m) => sum + parseInt(m.qty), 0);
            
            // Real current stock = stock awal + in - out
            const realCurrentStock = parseInt(product.stock_awal) + stockIn - stockOut;
            
            return {
                ...product,
                realCurrentStock // ← Stock yang akurat
            };
        });
        
        // Update global products variable
        products = productsWithRealStock;
        
        const select = document.getElementById('product-select');
        select.innerHTML = '<option value="">Pilih Produk...</option>' + 
            productsWithRealStock.map(product => 
                `<option value="${product.id}" data-price="${product.harga_beli}">${product.nama_barang} (${product.sku}) - Stock: ${product.realCurrentStock}</option>`
            ).join('');
            
    } catch (error) {
        console.error('Error loading products:', error);
        const select = document.getElementById('product-select');
        select.innerHTML = '<option value="">Error loading products</option>';
    }
}

        /**
         * Calculate profit preview
         */
        function updateProfitPreview() {
            const productSelect = document.getElementById('product-select');
            const qty = parseInt(document.getElementById('order-qty').value) || 0;
            const sellPrice = parseFloat(document.getElementById('order-price').value) || 0;
            
            if (productSelect.value && qty > 0 && sellPrice > 0) {
                const buyPrice = parseFloat(productSelect.selectedOptions[0].dataset.price) || 0;
                const profit = (sellPrice - buyPrice) * qty;
                
                document.getElementById('profit-amount').textContent = formatCurrency(profit);
                document.getElementById('profit-preview').style.display = 'block';
            } else {
                document.getElementById('profit-preview').style.display = 'none';
            }
        }

        // ===========================================
        // CUSTOMERS FUNCTIONS
        // ===========================================
        
        /**
         * Load customers list
         */
        async function loadCustomers() {
    try {
        // Load customers dan orders data
        const [customersData, ordersData] = await Promise.all([
            apiCall('customers'),
            apiCall('orders')
        ]);
        
        const customers = Array.isArray(customersData) ? customersData : [];
        const orders = Array.isArray(ordersData) ? ordersData : [];
        
        const container = document.getElementById('customers-list');
        
        if (customers.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A3.98 3.98 0 0 0 16.06 6H15c-.8 0-1.54.37-2.01.99L10.99 9H6c-1.1 0-2 .9-2 2v3h2v8h8v-8h2v8h4z"/>
                    </svg>
                    <div>Belum ada customer</div>
                </div>
            `;
            return;
        }

        // ✅ RECALCULATE customer statistics berdasarkan orders yang masih ada
        const customersWithStats = customers.map(customer => {
            // Filter orders untuk customer ini
            const customerOrders = orders.filter(order => order.customer_id == customer.id);
            
            // Hitung total orders dan spent
            const totalOrders = customerOrders.length;
            const totalSpent = customerOrders.reduce((sum, order) => sum + parseFloat(order.subtotal || 0), 0);
            
            return {
                ...customer,
                total_orders: totalOrders,
                total_spent: totalSpent
            };
        });

        container.innerHTML = customersWithStats.map(customer => `
            <div class="list-item">
                <div class="list-item-header">
                    <div class="list-item-title">${customer.nama}</div>
                    <div class="status pending">${customer.platform}</div>
                </div>
                <div class="list-item-meta">
                    ${customer.no_hp} • Orders: ${customer.total_orders} • Spent: ${formatCurrency(customer.total_spent)}
                </div>
                ${customer.alamat ? `<div style="margin-top: 0.5rem; color: #94a3b8;">${customer.alamat}</div>` : ''}
            </div>
        `).join('');
        
        console.log('✅ Customer data refreshed with real-time calculations');
        
    } catch (error) {
        console.error('Error loading customers:', error);
        document.getElementById('customers-list').innerHTML = '<div class="empty-state">Error loading customers</div>';
    }
}

        // ===========================================
        // PRODUCTS FUNCTIONS  
        // ===========================================
        
        /**
         * Load products list
         */
  async function loadProducts() {
    try {
        const data = await apiCall('products');
        const tableBody = document.getElementById('products-table-body');
        
        if (!Array.isArray(data) || data.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; color: #94a3b8; padding: 2rem;">
                        Belum ada produk
                    </td>
                </tr>
            `;
            return;
        }
        // Update data products global
        products = data;
        
        tableBody.innerHTML = data.map(product => {
            // Format tanggal
            const productDate = product.created_at 
                ? new Date(product.created_at).toLocaleDateString('id-ID')
                : new Date().toLocaleDateString('id-ID');
                
            return `
                <tr>
                    <td>${productDate}</td>
                    <td>${product.sku}</td>
                    <td>${product.nama_barang}</td>
                    <td>${product.unit}</td>
                    <td>${product.stock_current || 0}</td>
                    <td>-</td>
                    <td>Admin</td>
                    <td>
                        <button class="btn-action edit" onclick="editProduct(${product.id})" title="Edit">Edit</button>
                        <button class="btn-action delete" onclick="deleteProduct(${product.id})" title="Hapus">🗑️</button>
                    </td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        document.getElementById('products-table-body').innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; color: #ef4444; padding: 2rem;">
                    Error loading products
                </td>
            </tr>
        `;
    }
}

        /**
         * Edit product - populate form dengan data existing
         */
        function editProduct(id) {
            // Cari produk berdasarkan ID
            const product = products.find(p => p.id == id);
            if (!product) {
                alert('Produk tidak ditemukan!');
                return;
            }
            
            // Populate form dengan data produk
            document.getElementById('new-product-sku').value = product.sku;
            document.getElementById('new-product-name').value = product.nama_barang;
            document.getElementById('new-product-unit').value = product.unit;
            document.getElementById('new-product-price').value = product.harga_beli;
            document.getElementById('new-product-stock').value = product.stock_current;
            
            // Tambahin hidden field untuk ID
            let hiddenId = document.getElementById('edit-product-id');
            if (!hiddenId) {
                hiddenId = document.createElement('input');
                hiddenId.type = 'hidden';
                hiddenId.id = 'edit-product-id';
                document.getElementById('add-product-form').appendChild(hiddenId);
            }
            hiddenId.value = product.id;
            
            // Ganti title modal
            document.querySelector('#add-product-modal h3').textContent = 'Edit Produk';
            
            // Show modal
            document.getElementById('add-product-modal').style.display = 'block';
        }

        /**
         * Delete product dengan konfirmasi
         */
        async function deleteProduct(id) {
            // Cari produk berdasarkan ID
            const product = products.find(p => p.id == id);
            if (!product) {
                alert('Produk tidak ditemukan!');
                return;
            }
            
            // Konfirmasi hapus
            if (confirm(`Yakin ingin menghapus produk "${product.nama_barang}"?\n\nData yang dihapus tidak bisa dikembalikan!`)) {
                try {
                    // Call API delete
                    const result = await apiCall(`product&id=${id}`, 'DELETE');
                    
                    if (result.success) {
                        toastSuccess('Produk Dihapus', 'Produk berhasil dihapus dari inventory!');
                        loadProducts(); // Refresh table
                        loadProductsForSelect(); // Refresh dropdown
                    } else {
                        toastError('Gagal Menghapus', result.error || 'Gagal menghapus produk');
                    }
                    
                } catch (error) {
                    toastError('Network Error', error.message);
                }
            }
        }


// === AUTO CHECK SETTINGS FORM ===
const autoCheckForm = document.getElementById('auto-check-form');
if (autoCheckForm) {
    autoCheckForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const apiKey = document.getElementById('binderbyte-api').value;
        const interval = parseInt(document.getElementById('check-interval').value);
        const enabled = document.querySelector('input[name="auto-check-enabled"]:checked').value === 'true';
        
        fetch('https://ersetsolution.my.id/autocheck.php?action=user_settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                binderbyte_api_key: apiKey,
                auto_check_interval: interval,        // ✅ DARI FORM
                auto_check_enabled: enabled,          // ✅ DARI FORM
                user_name: 'Surya',                  // ✅ TAMBAH
                device_name: 'V12'                   // ✅ TAMBAH
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                toastSuccess('Settings Saved!', 'Auto check settings berhasil disimpan!');
                loadAutoCheckSettings(); // ✅ REFRESH DISPLAY
            }
        });
    });
}


        // ===========================================
        // MESSAGES FUNCTIONS
        // ===========================================
        
        /**
         * Load messages list
         */
        async function loadMessages() {
            try {
                const data = await apiCall('messages');
                const container = document.getElementById('messages-list');
                
                if (!Array.isArray(data) || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                            </svg>
                            <div>Belum ada pesan</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.map(message => `
                    <div class="list-item">
                        <div class="list-item-header">
                            <div class="list-item-title">${message.customer_name}</div>
                            <div class="status ${message.status}">${message.status}</div>
                        </div>
                        <div class="list-item-meta">
                            ${message.recipient_phone} • Type: ${message.message_type}
                        </div>
                        <div style="margin-top: 0.5rem; color: #94a3b8; font-size: 0.9rem;">
                            ${message.message_final || message.message_template}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('messages-list').innerHTML = '<div class="empty-state">Error loading messages</div>';
            }
        }

        // ===========================================
        // UTILITY FUNCTIONS
        // ===========================================
        
        /**
         * Format currency to Indonesian Rupiah
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount || 0);
        }

        // ===========================================
        // MODAL FUNCTIONS
        // ===========================================
        
        // Customer Modal Functions
        function showAddCustomerModal() {
            document.getElementById('add-customer-modal').style.display = 'block';
        }

        function closeAddCustomerModal() {
            document.getElementById('add-customer-modal').style.display = 'none';
            document.getElementById('add-customer-form').reset();
        }

        // Product Modal Functions
        function showAddProductModal() {
            document.getElementById('add-product-modal').style.display = 'block';
        }

        function closeAddProductModal() {
            document.getElementById('add-product-modal').style.display = 'none';
            document.getElementById('add-product-form').reset();
            
            // Reset ke mode add
            document.querySelector('#add-product-modal h3').textContent = 'Tambah Produk Baru';
            const hiddenId = document.getElementById('edit-product-id');
            if (hiddenId) {
                hiddenId.remove();
            }
        }

        // Movement Modal Functions
        function showAddMovementModal() {
            document.getElementById('add-movement-modal').style.display = 'block';
            loadProductsForMovementSelect(); // Load products waktu modal dibuka
        }

        function closeAddMovementModal() {
            document.getElementById('add-movement-modal').style.display = 'none';
            document.getElementById('add-movement-form').reset();
        }

        // Template Modal Functions
        function showAddTemplateModal() {
            document.getElementById('add-template-modal').style.display = 'block';
        }

        function closeAddTemplateModal() {
            document.getElementById('add-template-modal').style.display = 'none';
            document.getElementById('add-template-form').reset();
        }

        // ===========================================
        // TAB SWITCHING FUNCTIONS
        // ===========================================
        
        /**
         * Tab switching untuk products page
         */
        function switchTab(tabId, element) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            element.classList.add('active');
            
            // Auto load data berdasarkan tab
            if (tabId === 'master-produk') {
                loadProducts();
            } else if (tabId === 'stock-movement') {
                loadStockMovements();
                toastInfo('Loading Data', 'Memuat history stock movement...');
            } else if (tabId === 'laporan-stock') {
                loadLaporanStock();
                toastInfo('Generating Report', 'Memuat laporan stock...');
            } else if (tabId === 'report') {
                loadReportData();
                toastInfo('Loading Report', 'Memuat inventory report...');
            }
        }

        /**
         * Switch order tabs untuk order page
         */
        function switchOrderTab(tabId, element) {
            // Hide all order tab contents
            document.querySelectorAll('#orders-page .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from order tab buttons
            document.querySelectorAll('#orders-page .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            element.classList.add('active');
            
            // Auto load data
            if (tabId === 'history-orders') {
                loadOrdersHistory();
            }
        }

        /**
         * Message tab switching untuk message page
         */
        function switchMessageTab(tabId, element) {
    // Hide all tab contents in message page
    document.querySelectorAll('#messages-page .tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tab buttons in message page
    document.querySelectorAll('#messages-page .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    element.classList.add('active');
    
    // Auto load data berdasarkan tab
    if (tabId === 'message-templates') {
        loadMessageTemplates();
    } else if (tabId === 'message-history') {
        loadMessageHistory();
    } else if (tabId === 'message-settings') {
        loadApiSettings();
    }
}

        // ===========================================
        // TOAST NOTIFICATION SYSTEM
        // ===========================================
        
        /**
         * Show toast notification
         */
        function showToast(type, title, message, duration = 4000) {
            const container = document.getElementById('toast-container');
            
            // Icon berdasarkan type
            const icons = {
                success: `<svg class="toast-icon" viewBox="0 0 24 24" fill="currentColor" style="color: #22c55e;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>`,
                error: `<svg class="toast-icon" viewBox="0 0 24 24" fill="currentColor" style="color: #ef4444;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/>
                </svg>`,
                warning: `<svg class="toast-icon" viewBox="0 0 24 24" fill="currentColor" style="color: #f59e0b;">
                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                </svg>`,
                info: `<svg class="toast-icon" viewBox="0 0 24 24" fill="currentColor" style="color: #3b82f6;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                </svg>`
            };
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                ${icons[type]}
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="removeToast(this.parentElement)">&times;</button>
            `;
            
            // Add to container
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => removeToast(toast), duration);
            
            return toast;
        }

        function removeToast(toast) {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }

        // Helper functions
        function toastSuccess(title, message) {
            return showToast('success', title, message);
        }

        function toastError(title, message) {
            return showToast('error', title, message);
        }

        function toastWarning(title, message) {
            return showToast('warning', title, message);
        }

        function toastInfo(title, message) {
            return showToast('info', title, message);
        }

        // ===========================================
        // PLACEHOLDER FUNCTIONS (TO BE IMPLEMENTED)
        // ===========================================
        
        
        
        // ===========================================
// AUTO CHECK HELPER FUNCTIONS (NEW)
// ===========================================

/**
 * Create auto check tables
 */
async function createAutoCheckTables() {
    try {
        toastInfo('Creating Tables', 'Membuat auto check tables...');
        
        const result = await apiCall('create_tables');
        console.log('🛠️ Create tables result:', result);
        
        if (result.success) {
            toastSuccess('Tables Created', `Tables berhasil dibuat: ${result.tables.join(', ')}`);
            
            // Show info panel
            showAutoCheckInfo(`
                ✅ <strong>Tables Created:</strong><br>
                ${result.tables.map(t => `• ${t}`).join('<br>')}<br><br>
                📊 <strong>Indexes:</strong><br>
                ${result.indexes.map(i => `• ${i}`).join('<br>')}
            `);
            
            // Auto load settings setelah tables dibuat
            setTimeout(() => {
                loadAutoCheckSettings();
            }, 1000);
        } else {
            toastError('Create Failed', result.error || 'Gagal membuat tables');
        }
        
    } catch (error) {
        console.error('❌ Create tables error:', error);
        toastError('Network Error', error.message);
    }
}

/**
 * Test auto check API connection
 */
async function testAutoCheckAPI() {
    try {
        toastInfo('Testing API', 'Mengetes koneksi autocheck.php...');
        
        const result = await apiCall('test');
        console.log('🔍 API test result:', result);
        
        if (result.success) {
            toastSuccess('API Test OK', `Autocheck API working: ${result.message}`);
            
            // Test check tables juga
            const tablesCheck = await apiCall('check_tables');
            console.log('📋 Tables check:', tablesCheck);
            
            if (tablesCheck.success) {
                const readyTables = Object.entries(tablesCheck.tables)
                    .filter(([table, exists]) => exists)
                    .map(([table]) => table);
                    
                const missingTables = Object.entries(tablesCheck.tables)
                    .filter(([table, exists]) => !exists)
                    .map(([table]) => table);
                
                showAutoCheckInfo(`
                    🔗 <strong>API Connection:</strong> OK<br>
                    📅 <strong>Timestamp:</strong> ${result.timestamp}<br>
                    🏗️ <strong>Version:</strong> ${result.version}<br><br>
                    
                    ✅ <strong>Ready Tables:</strong><br>
                    ${readyTables.map(t => `• ${t}`).join('<br>') || 'None'}<br><br>
                    
                    ${missingTables.length > 0 ? `
                    ❌ <strong>Missing Tables:</strong><br>
                    ${missingTables.map(t => `• ${t}`).join('<br>')}<br><br>
                    💡 <strong>Action:</strong> Klik "Create Tables" untuk membuat yang hilang.
                    ` : '🎉 <strong>Status:</strong> Semua tables sudah ready!'}
                `);
                
                if (tablesCheck.all_ready) {
                    toastInfo('Tables Status', 'Semua tables sudah ready! 🎉');
                } else {
                    toastWarning('Tables Missing', `${missingTables.length} tables belum ada. Klik Create Tables.`);
                }
            }
        } else {
            toastError('API Test Failed', result.error || 'Autocheck API tidak response');
            showAutoCheckInfo(`❌ <strong>API Error:</strong> ${result.error || 'Connection failed'}`);
        }
        
    } catch (error) {
        console.error('❌ API test error:', error);
        toastError('Connection Error', 'Tidak bisa connect ke autocheck.php');
        showAutoCheckInfo(`🚨 <strong>Network Error:</strong> ${error.message}`);
    }
}

/**
 * Show auto check info panel
 */
function showAutoCheckInfo(htmlContent) {
    const infoPanel = document.getElementById('auto-check-info');
    const detailsDiv = document.getElementById('auto-check-details');
    
    if (infoPanel && detailsDiv) {
        detailsDiv.innerHTML = htmlContent;
        infoPanel.style.display = 'block';
        
        // Auto hide after 10 seconds
        setTimeout(() => {
            infoPanel.style.display = 'none';
        }, 10000);
    }
}
        
        
        
        
        
        // ===========================================
// SETTINGS FUNCTIONS (NEW)
// ===========================================

/**
 * Switch settings tabs
 */
function switchSettingsTab(tabId, element) {
    // Hide all tab contents in settings page
    document.querySelectorAll('#settings-page .tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tab buttons in settings page
    document.querySelectorAll('#settings-page .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    element.classList.add('active');
    
    // Load data berdasarkan tab
    if (tabId === 'user-settings') {
        loadUserSettings();
    } else if (tabId === 'auto-check-settings') {
        loadAutoCheckSettings();
    } else if (tabId === 'api-settings') {
        // This is the monitor tab
        loadMonitorData();
    }
}

/**
 * Load user settings from backend
 */
async function loadUserSettings() {
    try {
        const response = await fetch('https://ersetsolution.my.id/autocheck.php?action=user_settings');
        const data = await response.json();
        
        if (data.error) {
            toastError('Settings Error', data.error);
            return;
        }
        
        // Populate form
        document.getElementById('user-name').value = data.user_name || 'Surya';
        document.getElementById('device-name').value = data.device_name || 'V12';
        
        toastSuccess('Settings Loaded', 'User settings berhasil dimuat');
        
    } catch (error) {
        console.error('Error loading user settings:', error);
        toastError('Load Error', 'Gagal memuat user settings');
    }
}

/**
 * Load auto check settings from autocheck.php endpoint
 */
async function loadAutoCheckSettings() {
    try {
        console.log('🔄 Loading auto check settings...');
        
        // Langsung ke endpoint autocheck.php
        const data = await apiCall('user_settings');
        
        console.log('📊 Auto check data received:', data);
        
        if (data.error) {
            console.error('❌ Settings error:', data.error);
            
            // Kalau table belum ada, kasih hint
            if (data.error.includes('not found') || data.error.includes('create_tables')) {
                toastWarning('Tables Missing', 'Auto check tables belum dibuat. Klik "Create Tables" dulu.');
                return;
            }
            
            toastError('Settings Error', data.error);
            return;
        }
        
        // Populate form dengan safety checks
        const intervalSelect = document.getElementById('check-interval');
        if (intervalSelect) {
            intervalSelect.value = data.auto_check_interval || 30;
        }
        
        // Set radio button auto check enabled
        const enabledValue = data.auto_check_enabled === true || data.auto_check_enabled === 1 || data.auto_check_enabled === '1';
        const enabledRadio = document.querySelector(`input[name="auto-check-enabled"][value="${enabledValue}"]`);
        if (enabledRadio) {
            enabledRadio.checked = true;
        }
        
        // Set API key
        const apiKeyInput = document.getElementById('binderbyte-api');
        if (apiKeyInput) {
            apiKeyInput.value = data.binderbyte_api_key || '';
        }
        
        // Update status indicator
        const statusEl = document.getElementById('auto-check-status');
        if (statusEl) {
            if (enabledValue) {
                statusEl.textContent = '🟢 Aktif';
                statusEl.className = 'status delivered';
            } else {
                statusEl.textContent = '🔴 Nonaktif';
                statusEl.className = 'status return';
            }
        }
        
        toastSuccess('Settings Loaded', 'Auto check settings berhasil dimuat');
        
    } catch (error) {
        console.error('❌ Error loading auto check settings:', error);
        toastError('Load Error', 'Gagal memuat auto check settings: ' + error.message);
    }
}

/**
 * Test API connection
 */
async function testApiConnection() {
    try {
        toastInfo('Testing...', 'Mengetes koneksi API backend');
        
        const data = await apiCall('test');
        
        if (data.success) {
            toastSuccess('API Connection OK', `Backend response: ${data.message}`);
        } else {
            toastError('API Test Failed', data.error || 'API test gagal');
        }
        
    } catch (error) {
        toastError('Connection Error', 'Backend tidak bisa dihubungi');
    }
}
        
        
        // Stock Movement Functions
       async function loadProductsForMovementSelect() {
    try {
        // ✅ SIMPLE: langsung pakai stock_current dari database (sama kayak laporan stock)
        const data = await apiCall('products');
        const products = Array.isArray(data) ? data : [];
        
        const select = document.getElementById('movement-product-select');
        select.innerHTML = '<option value="">Pilih produk...</option>' + 
            products.map(product => 
                `<option value="${product.id}">${product.nama_barang} (${product.sku}) - Stock: ${product.stock_current}</option>`
            ).join('');
            
    } catch (error) {
        console.error('Error loading products for movement:', error);
        const select = document.getElementById('movement-product-select');
        select.innerHTML = '<option value="">Error loading products</option>';
    }
}

        async function loadStockMovements() {
    try {
        const data = await apiCall('stock_movements');
        const tableBody = document.getElementById('stock-movements-table-body');
        
        if (!Array.isArray(data) || data.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; color: #94a3b8; padding: 3rem;">
                        <div class="empty-state">
                            <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2l-7 7h4v6h6V9h4l-7-7zM6 20v2h12v-2H6z"/>
                            </svg>
                            <div>Belum ada stock movement</div>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tableBody.innerHTML = data.map(movement => {
    const movementDate = movement.created_at 
        ? new Date(movement.created_at).toLocaleDateString('id-ID', { 
            day: '2-digit', 
            month: '2-digit', 
            year: '2-digit' 
          })
        : '-';
    
    return `
        <tr>
            <td style="font-weight: 600;">${movementDate}</td>
            <td style="font-weight: 600;">${movement.sku}</td>
            <td>${movement.nama_barang}</td>
            <td><span class="status ${movement.type === 'in' ? 'delivered' : 'return'}">${movement.type.toUpperCase()}</span></td>
            <td style="text-align: center;"><strong>${movement.qty}</strong></td>
            <td>${movement.notes || '-'}</td>
            <td style="text-align: center;">${movement.created_by}</td>
            <td style="text-align: center;">
                <button class="btn-action delete" onclick="deleteStockMovement(${movement.id})" title="Hapus">🗑️</button>
            </td>
        </tr>
    `;
}).join('');
        
    } catch (error) {
        console.error('Error loading stock movements:', error);
        document.getElementById('stock-movements-table-body').innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; color: #ef4444; padding: 3rem;">
                    Error loading stock movements
                </td>
            </tr>
        `;
    }
}

        // Function load laporan stock dengan perhitungan
        async function loadLaporanStock() {
    try {
        // Load products dan stock movements
        const [productsData, movementsData] = await Promise.all([
            apiCall('products'),
            apiCall('stock_movements')
        ]);

        const productsList = Array.isArray(productsData) ? productsData : [];
        const movementsList = Array.isArray(movementsData) ? movementsData : [];
        
        const tableBody = document.getElementById('laporan-stock-table-body');
        const mobileContainer = document.getElementById('mobile-stock-cards');
        
        if (productsList.length === 0) {  // ← FIX: productsList bukan products
            // Empty state untuk table
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; color: #94a3b8; padding: 3rem;">
                        Belum ada produk untuk laporan
                    </td>
                </tr>
            `;
            
            // Empty state untuk mobile (prioritas design)
            mobileContainer.innerHTML = `
                <div style="text-align: center; color: #94a3b8; padding: 2rem 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📦</div>
                    <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: #f1f5f9;">Belum Ada Produk</div>
                    <div style="font-size: 0.9rem; line-height: 1.4;">Tambahkan produk untuk melihat laporan stock</div>
                    <button class="btn" onclick="showPage('products-page')" style="margin-top: 1.5rem; padding: 0.75rem 1.5rem; font-size: 0.9rem;">
                        + Tambah Produk
                    </button>
                </div>
            `;
            return;
        }

        // Hitung stock per produk
        const stockReport = productsList.map(product => {
            // Filter movements untuk produk ini
            const productMovements = movementsList.filter(m => m.product_id == product.id);
            
            // Hitung stock in dan out
            const stockIn = productMovements
                .filter(m => m.type === 'in')
                .reduce((sum, m) => sum + parseInt(m.qty), 0);
                
            const stockOut = productMovements
                .filter(m => m.type === 'out')
                .reduce((sum, m) => sum + parseInt(m.qty), 0);
            
            // Current stock = stock awal + in - out
            const currentStock = parseInt(product.stock_awal) + stockIn - stockOut;
            
            // Status berdasarkan minimum stock
            const isLowStock = currentStock <= (product.stock_minimum || 5);
            const status = isLowStock ? 'bahaya' : 'aman';
            
            return {
                ...product,
                stockIn,
                stockOut,
                currentStock,
                status,
                isLowStock
            };
        });

        // Store global untuk filtering
        window.stockReportData = stockReport;

        // ===== RENDER DESKTOP TABLE =====
        renderStockTable(stockReport);
        
        // ===== RENDER MOBILE CARDS (PRIORITAS DESIGN) =====
        mobileContainer.innerHTML = stockReport.map(item => {
            // Status badge dengan design mobile-friendly
            const statusBadge = item.status === 'aman' 
                ? `<div class="status delivered" style="background: rgba(34, 197, 94, 0.15); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-align: center;">✅ AMAN</div>`
                : `<div class="status return" style="background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-align: center;">⚠️ BAHAYA</div>`;
            
            return `
                <div style="background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 1.25rem; margin-bottom: 1rem;">
                    <!-- Header Section -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="flex: 1;">
                            <div style="font-size: 0.8rem; font-weight: 700; color: #3b82f6; margin-bottom: 0.25rem; letter-spacing: 0.5px;">${item.sku}</div>
                            <div style="font-size: 1rem; font-weight: 600; color: #f1f5f9; line-height: 1.3;">${item.nama_barang}</div>
                            <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;">Unit: ${item.unit}</div>
                        </div>
                        <div style="margin-left: 1rem;">
                            ${statusBadge}
                        </div>
                    </div>

                    <!-- Stock Grid (Mobile Optimized) -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                        <div style="background: rgba(255, 255, 255, 0.03); padding: 0.75rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem;">Stock Awal</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #f1f5f9;">${item.stock_awal}</div>
                        </div>
                        <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); padding: 0.75rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.7rem; color: #22c55e; text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem;">Stock In</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #22c55e;">+${item.stockIn}</div>
                        </div>
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: 0.75rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.7rem; color: #ef4444; text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem;">Stock Out</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #ef4444;">-${item.stockOut}</div>
                        </div>
                        <div style="background: ${item.isLowStock ? 'rgba(239, 68, 68, 0.15)' : 'rgba(59, 130, 246, 0.15)'}; border: 1px solid ${item.isLowStock ? 'rgba(239, 68, 68, 0.3)' : 'rgba(59, 130, 246, 0.3)'}; padding: 0.75rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.7rem; color: ${item.isLowStock ? '#ef4444' : '#3b82f6'}; text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem;">Current Stock</div>
                            <div style="font-size: 1.3rem; font-weight: 800; color: ${item.isLowStock ? '#ef4444' : '#f1f5f9'};">${item.currentStock}</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Update filter options
        updateFilterOptions(stockReport);
        
    } catch (error) {
        console.error('Error loading laporan stock:', error);
        
        // Error state table
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; color: #ef4444; padding: 3rem;">
                    Error loading laporan stock
                </td>
            </tr>
        `;
        
        // Error state mobile (mobile-first)
        mobileContainer.innerHTML = `
            <div style="text-align: center; color: #ef4444; padding: 2rem 1rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🚨</div>
                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Error Loading Data</div>
                <div style="font-size: 0.9rem; margin-bottom: 1.5rem; line-height: 1.4;">Periksa koneksi internet Anda</div>
                <button class="btn" onclick="loadLaporanStock()" style="padding: 0.75rem 1.5rem; font-size: 0.9rem;">
                    🔄 Coba Lagi
                </button>
            </div>
        `;
    }
}

        // Function render table
        function renderStockTable(stockReport) {
            const tableBody = document.getElementById('laporan-stock-table-body');
            
            tableBody.innerHTML = stockReport.map(item => {
                // Status badge
                const statusBadge = item.status === 'aman' 
                    ? `<span class="status delivered" style="background: rgba(34, 197, 94, 0.2); color: #22c55e;">AMAN</span>`
                    : `<span class="status return" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">BAHAYA</span>`;
                
                // Color coding untuk stock numbers
                const stockInStyle = item.stockIn > 0 ? 'color: #22c55e; font-weight: 600;' : '';
                const stockOutStyle = item.stockOut > 0 ? 'color: #ef4444; font-weight: 600;' : '';
                const currentStockStyle = item.isLowStock ? 'color: #ef4444; font-weight: 600;' : 'color: #f1f5f9; font-weight: 600;';
                
                return `
                    <tr>
                        <td style="font-weight: 600;">${item.sku}</td>
                        <td>${item.nama_barang}</td>
                        <td>${item.unit}</td>
                        <td>${item.stock_awal}</td>
                        <td style="${stockInStyle}">${item.stockIn}</td>
                        <td style="${stockOutStyle}">${item.stockOut}</td>
                        <td style="${currentStockStyle}">${item.currentStock}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        // Function update filter options
        function updateFilterOptions(stockReport) {
            const amanCount = stockReport.filter(item => item.status === 'aman').length;
            const bahayaCount = stockReport.filter(item => item.status === 'bahaya').length;
            const highStockCount = stockReport.filter(item => item.currentStock > 50).length;
            const lowStockCount = stockReport.filter(item => item.currentStock <= 10 && item.currentStock > 0).length;
            const emptyStockCount = stockReport.filter(item => item.currentStock <= 0).length;
            
            // Update status filter
            const statusFilter = document.getElementById('status-filter');
            if (statusFilter) {
                statusFilter.innerHTML = `
                    <option value="">All Status (${stockReport.length})</option>
                    <option value="aman">Aman (${amanCount})</option>
                    <option value="bahaya">Bahaya (${bahayaCount})</option>
                `;
            }
            
            // Update range filter
            const rangeFilter = document.getElementById('range-filter');
            if (rangeFilter) {
                rangeFilter.innerHTML = `
                    <option value="">All Range (${stockReport.length})</option>
                    <option value="high">Stock Tinggi (${highStockCount})</option>
                    <option value="low">Stock Rendah (${lowStockCount})</option>
                    <option value="empty">Habis (${emptyStockCount})</option>
                `;
            }
        }

        // Function filter laporan stock
       function filterLaporanStock() {
    console.log('=== FILTER FUNCTION CALLED ===');
    
    if (!window.stockReportData) {
        console.log('No stock data available');
        return;
    }
    
    const searchInput = document.getElementById('laporan-search');
    const statusFilter = document.getElementById('status-filter');
    const rangeFilter = document.getElementById('range-filter');
    
    if (!searchInput || !statusFilter || !rangeFilter) {
        console.log('Filter elements not found');
        return;
    }
    
    const searchValue = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;
    const rangeValue = rangeFilter.value;
    
    console.log('Filter values:', { searchValue, statusValue, rangeValue });
    
    let filteredData = window.stockReportData.filter(item => {
        // Search filter
        const matchSearch = searchValue === '' || 
            item.sku.toLowerCase().includes(searchValue) ||
            item.nama_barang.toLowerCase().includes(searchValue);
        
        // Status filter  
        const matchStatus = statusValue === '' || item.status === statusValue;
        
        // Range filter
        let matchRange = true;
        if (rangeValue === 'high') matchRange = item.currentStock > 50;
        else if (rangeValue === 'low') matchRange = item.currentStock <= 10 && item.currentStock > 0;
        else if (rangeValue === 'empty') matchRange = item.currentStock <= 0;
        
        return matchSearch && matchStatus && matchRange;
    });
    
    console.log('Filtered results:', filteredData.length, 'items');
    
    // === RENDER TABLE (DESKTOP) ===
    const tableBody = document.getElementById('laporan-stock-table-body');
    if (tableBody) {
        if (filteredData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; color: #94a3b8; padding: 3rem; font-size: 1rem;">
                        <div style="margin-bottom: 0.5rem;">🔍</div>
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">Tidak Ada Data</div>
                        <div style="font-size: 0.9rem;">Coba ubah filter atau pencarian</div>
                    </td>
                </tr>
            `;
        } else {
            tableBody.innerHTML = filteredData.map(item => {
                const statusBadge = item.status === 'aman' 
                    ? `<span class="status delivered" style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">AMAN</span>`
                    : `<span class="status return" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">BAHAYA</span>`;
                
                return `
                    <tr>
                        <td style="font-weight: 600;">${item.sku}</td>
                        <td>${item.nama_barang}</td>
                        <td>${item.unit}</td>
                        <td>${item.stock_awal}</td>
                        <td style="color: #22c55e; font-weight: 600;">${item.stockIn}</td>
                        <td style="color: #ef4444; font-weight: 600;">${item.stockOut}</td>
                        <td style="color: ${item.isLowStock ? '#ef4444' : '#f1f5f9'}; font-weight: 600;">${item.currentStock}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }
        console.log('Table updated successfully');
    }
    
    // === RENDER MOBILE CARDS ===
    const mobileContainer = document.getElementById('mobile-stock-cards');
    if (mobileContainer) {
        if (filteredData.length === 0) {
            mobileContainer.innerHTML = `
                <div style="text-align: center; color: #94a3b8; padding: 2rem 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🔍</div>
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Tidak Ada Data</div>
                    <div style="font-size: 0.9rem;">Coba ubah filter atau pencarian</div>
                </div>
            `;
        } else {
            // Render mobile cards with full data
            mobileContainer.innerHTML = filteredData.map(item => {
                const statusBadge = item.status === 'aman' 
                    ? `<div style="background: rgba(34, 197, 94, 0.15); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-align: center;">✅ AMAN</div>`
                    : `<div style="background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-align: center;">⚠️ BAHAYA</div>`;
                
                return `
                    <div style="background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 1.25rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="flex: 1;">
                                <div style="font-size: 0.8rem; font-weight: 700; color: #3b82f6; margin-bottom: 0.25rem; letter-spacing: 0.5px;">${item.sku}</div>
                                <div style="font-size: 1rem; font-weight: 600; color: #f1f5f9; line-height: 1.3;">${item.nama_barang}</div>
                                <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;">Unit: ${item.unit}</div>
                            </div>
                            <div style="margin-left: 1rem;">
                                ${statusBadge}
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div style="background: rgba(255, 255, 255, 0.03); padding: 0.75rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem;">Stock Awal</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #f1f5f9;">${item.stock_awal}</div>
                            </div>
                            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); padding: 0.75rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #22c55e; text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem;">Stock In</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #22c55e;">+${item.stockIn}</div>
                            </div>
                            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: 0.75rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #ef4444; text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem;">Stock Out</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #ef4444;">-${item.stockOut}</div>
                            </div>
                            <div style="background: ${item.isLowStock ? 'rgba(239, 68, 68, 0.15)' : 'rgba(59, 130, 246, 0.15)'}; border: 1px solid ${item.isLowStock ? 'rgba(239, 68, 68, 0.3)' : 'rgba(59, 130, 246, 0.3)'}; padding: 0.75rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.7rem; color: ${item.isLowStock ? '#ef4444' : '#3b82f6'}; text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem;">Current Stock</div>
                                <div style="font-size: 1.3rem; font-weight: 800; color: ${item.isLowStock ? '#ef4444' : '#f1f5f9'};">${item.currentStock}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        console.log('Mobile cards updated successfully');
    }
    
    console.log('=== FILTER COMPLETE ===');
}

        // Function export laporan stock
        function exportLaporanStock() {
            if (!window.stockReportData) {
                toastWarning('No Data', 'Tidak ada data untuk diexport');
                return;
            }
            
            // Simple CSV export
            const headers = ['SKU', 'NAMA BARANG', 'UNIT', 'STOK AWAL', 'STOCK IN', 'STOCK OUT', 'CURRENT STOCK', 'STATUS'];
            const csvContent = [
                headers.join(','),
                ...window.stockReportData.map(item => [
                    item.sku,
                    `"${item.nama_barang}"`,
                    item.unit,
                    item.stock_awal,
                    item.stockIn,
                    item.stockOut,
                    item.currentStock,
                    item.status.toUpperCase()
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `laporan-stock-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            toastSuccess('Export Berhasil', 'Laporan stock berhasil didownload!');
        }

  async function loadReportData() {
    try {
        // Load products data
        const data = await apiCall('products');
        const products = Array.isArray(data) ? data : [];
        
        if (products.length === 0) {
            // Set semua ke 0 kalau ga ada data
            document.getElementById('report-total-products').textContent = '0';
            document.getElementById('report-total-stock').textContent = '0';
            document.getElementById('report-stock-value').textContent = 'Rp 0';
            document.getElementById('report-low-stock').textContent = '0';
            
            // Empty state untuk 3 section
            document.getElementById('low-stock-count').textContent = '0 Items';
            document.getElementById('low-stock-list').innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">Belum ada data produk</div>';
            document.getElementById('top-products-count').textContent = '0 Items';
            document.getElementById('top-products-list').innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">Belum ada data produk</div>';
            document.getElementById('dead-stock-count').textContent = '0 Items';
            document.getElementById('dead-stock-list').innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">Belum ada data produk</div>';
            return;
        }
        
        // Hitung metrics
        const totalProducts = products.length;
        const totalStock = products.reduce((sum, p) => sum + parseInt(p.stock_current || 0), 0);
        const stockValue = products.reduce((sum, p) => sum + (parseInt(p.stock_current || 0) * parseFloat(p.harga_beli || 0)), 0);
        const lowStockCount = products.filter(p => parseInt(p.stock_current || 0) <= 5).length;
        
        // Update UI Cards
        document.getElementById('report-total-products').textContent = totalProducts;
        document.getElementById('report-total-stock').textContent = totalStock;
        document.getElementById('report-stock-value').textContent = formatCurrency(stockValue);
        document.getElementById('report-low-stock').textContent = lowStockCount;
        
        // === LOW STOCK ALERT (ENHANCED) ===
        document.getElementById('low-stock-count').textContent = lowStockCount + ' Items';
        const lowStockList = document.getElementById('low-stock-list');
        const lowStockProducts = products.filter(p => parseInt(p.stock_current || 0) <= 5 && parseInt(p.stock_current || 0) > 0);

        if (lowStockProducts.length === 0) {
            lowStockList.innerHTML = `
                <div style="text-align: center; color: #22c55e; padding: 2rem;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">✅</div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Semua produk stock aman!</div>
                    <div style="font-size: 0.9rem; color: #94a3b8;">Stock level > 5 untuk semua produk</div>
                </div>
            `;
        } else {
            // Hitung total nilai stock yang hampir habis
            const lowStockValue = lowStockProducts.reduce((sum, p) => sum + (parseInt(p.stock_current || 0) * parseFloat(p.harga_beli || 0)), 0);
            
            lowStockList.innerHTML = `
                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="color: #ef4444; font-weight: 600; margin-bottom: 0.5rem;">⚠️ URGENT: ${lowStockProducts.length} produk perlu segera direstock!</div>
                    <div style="font-size: 0.9rem; color: #f1f5f9;">Total nilai stock tersisa: <strong>${formatCurrency(lowStockValue)}</strong></div>
                </div>
                ${lowStockProducts.map(product => {
                    const currentStock = parseInt(product.stock_current || 0);
                    const stockValue = currentStock * parseFloat(product.harga_beli || 0);
                    const stockLevel = currentStock <= 2 ? 'KRITIS' : currentStock <= 5 ? 'RENDAH' : 'AMAN';
                    const stockColor = currentStock <= 2 ? '#ef4444' : '#f59e0b';
                    
                    return `
                        <div class="list-item" style="border-left: 3px solid ${stockColor};">
                            <div class="list-item-header">
                                <div>
                                    <div class="list-item-title">${product.nama_barang}</div>
                                    <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;">
                                        SKU: ${product.sku} • ${product.unit} • ${formatCurrency(product.harga_beli)}/unit
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div class="status return" style="background: rgba(239, 68, 68, 0.2); color: ${stockColor}; font-weight: 700;">
                                        ${stockLevel}: ${currentStock}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;">
                                        Nilai: ${formatCurrency(stockValue)}
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(239, 68, 68, 0.05); border-radius: 6px;">
                                <div style="font-size: 0.85rem; color: #ef4444;">
                                    📈 <strong>Rekomendasi:</strong> Restock minimal ${Math.max(20, currentStock * 4)} unit
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        // === TOP SELLING PRODUCTS ===
    // === TOP SELLING PRODUCTS (REAL SALES DATA) ===
const ordersData = await apiCall('orders');
const orders = Array.isArray(ordersData) ? ordersData : [];

// Group orders by product dan hitung sales metrics
const salesByProduct = {};
orders.forEach(order => {
    const productId = order.product_id;
    if (!salesByProduct[productId]) {
        salesByProduct[productId] = {
            totalSold: 0,
            totalRevenue: 0,
            totalProfit: 0,
            orderCount: 0
        };
    }
    salesByProduct[productId].totalSold += parseInt(order.qty || 0);
    salesByProduct[productId].totalRevenue += parseFloat(order.subtotal || 0);
    salesByProduct[productId].totalProfit += parseFloat(order.total_profit || 0);
    salesByProduct[productId].orderCount += 1;
});

// Match dengan product info dan sort by total sold
const topSellingProducts = Object.entries(salesByProduct)
    .map(([productId, sales]) => {
        const product = products.find(p => p.id == productId);
        return product ? { ...sales, productInfo: product } : null;
    })
    .filter(item => item !== null)
    .sort((a, b) => b.totalSold - a.totalSold)
    .slice(0, 5);

document.getElementById('top-products-count').textContent = topSellingProducts.length + ' Items';
const topProductsList = document.getElementById('top-products-list');

if (topSellingProducts.length === 0) {
    topProductsList.innerHTML = `
        <div style="text-align: center; color: #94a3b8; padding: 2rem;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">📈</div>
            <div style="font-weight: 600; margin-bottom: 0.25rem;">Belum ada data penjualan</div>
            <div style="font-size: 0.9rem;">Buat order pertama untuk melihat produk terlaris</div>
        </div>
    `;
} else {
    const totalAllSales = topSellingProducts.reduce((sum, item) => sum + item.totalSold, 0);
    const totalAllRevenue = topSellingProducts.reduce((sum, item) => sum + item.totalRevenue, 0);
    
    topProductsList.innerHTML = `
        <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <div style="color: #22c55e; font-weight: 600; margin-bottom: 0.5rem;">🏆 TOP 5: Total ${totalAllSales} unit terjual</div>
            <div style="font-size: 0.9rem; color: #f1f5f9;">Total revenue: <strong>${formatCurrency(totalAllRevenue)}</strong></div>
        </div>
        ${topSellingProducts.map((item, index) => {
            const avgOrderValue = item.totalRevenue / item.orderCount;
            const marketShare = ((item.totalSold / totalAllSales) * 100).toFixed(1);
            
            return `
                <div class="list-item" style="border-left: 3px solid #22c55e;">
                    <div class="list-item-header">
                        <div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <div style="background: #22c55e; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700;">${index + 1}</div>
                                <div class="list-item-title" style="margin: 0;">${item.productInfo.nama_barang}</div>
                            </div>
                            <div style="font-size: 0.8rem; color: #94a3b8;">
                                SKU: ${item.productInfo.sku} • Stock tersisa: ${item.productInfo.stock_current}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="status delivered" style="background: rgba(34, 197, 94, 0.2); color: #22c55e; font-weight: 700;">
                                ${item.totalSold} SOLD
                            </div>
                            <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;">
                                ${marketShare}% share
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 0.75rem; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                        <div style="background: rgba(34, 197, 94, 0.05); padding: 0.5rem; border-radius: 6px; text-align: center;">
                            <div style="font-size: 0.7rem; color: #22c55e; font-weight: 600;">REVENUE</div>
                            <div style="font-size: 0.85rem; color: #f1f5f9; font-weight: 600;">${formatCurrency(item.totalRevenue)}</div>
                        </div>
                        <div style="background: rgba(34, 197, 94, 0.05); padding: 0.5rem; border-radius: 6px; text-align: center;">
                            <div style="font-size: 0.7rem; color: #22c55e; font-weight: 600;">ORDERS</div>
                            <div style="font-size: 0.85rem; color: #f1f5f9; font-weight: 600;">${item.orderCount}x</div>
                        </div>
                        <div style="background: rgba(34, 197, 94, 0.05); padding: 0.5rem; border-radius: 6px; text-align: center;">
                            <div style="font-size: 0.7rem; color: #22c55e; font-weight: 600;">AVG ORDER</div>
                            <div style="font-size: 0.85rem; color: #f1f5f9; font-weight: 600;">${formatCurrency(avgOrderValue)}</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('')}
    `;
}

        // === DEAD STOCK (ENHANCED) ===
        const deadStockProducts = products.filter(p => parseInt(p.stock_current || 0) === 0);
        document.getElementById('dead-stock-count').textContent = deadStockProducts.length + ' Items';
        const deadStockList = document.getElementById('dead-stock-list');

        if (deadStockProducts.length === 0) {
            deadStockList.innerHTML = `
                <div style="text-align: center; color: #22c55e; padding: 2rem;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">🎉</div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Tidak ada dead stock!</div>
                    <div style="font-size: 0.9rem; color: #94a3b8;">Semua produk masih memiliki stock tersedia</div>
                </div>
            `;
        } else {
            // Hitung potential lost sales dan info detail
            const totalDeadStockItems = deadStockProducts.length;
            const avgPrice = products.reduce((sum, p) => sum + parseFloat(p.harga_beli || 0), 0) / products.length;
            const potentialLostSales = totalDeadStockItems * avgPrice * 10; // Estimasi 10 unit per produk
            
            deadStockList.innerHTML = `
                <div style="background: rgba(100, 116, 139, 0.1); border: 1px solid rgba(100, 116, 139, 0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="color: #64748b; font-weight: 600; margin-bottom: 0.5rem;">💀 IMPACT: ${totalDeadStockItems} produk tidak available untuk dijual</div>
                    <div style="font-size: 0.9rem; color: #f1f5f9;">Estimasi potensi kehilangan penjualan: <strong>${formatCurrency(potentialLostSales)}</strong></div>
                </div>
                ${deadStockProducts.map(product => {
                    const estimatedLoss = parseFloat(product.harga_beli || 0) * 10; // Estimasi 10 unit bisa terjual
                    const lastStockValue = parseFloat(product.harga_beli || 0) * parseInt(product.stock_awal || 0);
                    
                    return `
                        <div class="list-item" style="border-left: 3px solid #64748b;">
                            <div class="list-item-header">
                                <div>
                                    <div class="list-item-title">${product.nama_barang}</div>
                                    <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;">
                                        SKU: ${product.sku} • ${product.unit} • ${formatCurrency(product.harga_beli)}/unit
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div class="status" style="background: rgba(100, 116, 139, 0.2); color: #64748b; font-weight: 700;">
                                        HABIS: 0
                                    </div>
                                    <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;">
                                        Stock awal: ${product.stock_awal || 0}
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(100, 116, 139, 0.05); border-radius: 6px;">
                                <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">
                                    📊 <strong>Nilai investasi awal:</strong> ${formatCurrency(lastStockValue)}
                                </div>
                                <div style="font-size: 0.85rem; color: #f59e0b;">
                                    💸 <strong>Potensi lost sales:</strong> ${formatCurrency(estimatedLoss)} per bulan
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }
        
    } catch (error) {
        console.error('Error loading report:', error);
        toastError('Error', 'Gagal memuat report data');
    }
}

        // Message Functions
       async function loadMessageTemplates() {
    try {
        const data = await apiCall('message_templates');
        const tableBody = document.getElementById('templates-table-body');
        
        if (!Array.isArray(data) || data.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; color: #94a3b8; padding: 3rem;">
                        Belum ada template message
                    </td>
                </tr>
            `;
            return;
        }

        tableBody.innerHTML = data.map(template => `
            <tr>
                <td style="font-weight: 600;">${template.name}</td>
                <td><span class="status ${template.type === 'custom' ? 'pending' : 'delivered'}">${template.type.toUpperCase()}</span></td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${template.template}">${template.template}</td>
                <td><span class="status ${template.is_active ? 'delivered' : 'return'}">${template.is_active ? 'ACTIVE' : 'INACTIVE'}</span></td>
                <td>
                    <button class="btn-action edit" onclick="editTemplate(${template.id})" title="Edit">Edit</button>
                    <button class="btn-action delete" onclick="deleteTemplate(${template.id})" title="Hapus">🗑️</button>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading templates:', error);
        document.getElementById('templates-table-body').innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; color: #ef4444; padding: 3rem;">
                    Error loading templates
                </td>
            </tr>
        `;
    }
}

       async function loadMessageHistory() {
    try {
        // ✅ FIX: Call langsung ke templates.php
        const response = await fetch('templates.php?action=get_message_history');
        const data = await response.json();
        
        console.log('📋 Message History Data:', data);
        
        const tableBody = document.getElementById('message-history-table-body');
        
        if (!Array.isArray(data) || data.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; color: #94a3b8; padding: 3rem;">
                        <div class="empty-state">
                            <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                            </svg>
                            <div>Belum ada riwayat pesan</div>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        tableBody.innerHTML = data.map(message => {
            const statusBadge = getMessageStatusBadge(message.status);
            const messageDate = message.created_at 
                ? new Date(message.created_at).toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                  })
                : '-';
            
            const messagePreview = message.message_final 
                ? (message.message_final.length > 50 ? message.message_final.substring(0, 50) + '...' : message.message_final)
                : '-';
            
            return `
                <tr>
                    <td style="font-size: 0.85rem; color: #94a3b8;">${messageDate}</td>
                    <td>
                        <div style="font-weight: 600;">${message.customer_name || message.recipient_name}</div>
                        <div style="font-size: 0.8rem; color: #94a3b8;">${message.recipient_phone}</div>
                    </td>
                    <td><span class="status ${message.template_name === 'shipped' ? 'shipped' : message.template_name === 'delivered' ? 'delivered' : 'pending'}">${(message.template_name || 'auto').toUpperCase()}</span></td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${message.message_final || ''}">${messagePreview}</td>
                    <td>${statusBadge}</td>
                    <td style="font-family: monospace; font-size: 0.8rem;">${message.resi_number || '-'}</td>
                    <td>
                        <button class="btn-action" onclick="viewMessage(${message.id})" title="View">👁️</button>
                        ${message.status === 'pending' ? `<button class="btn-action" onclick="resendMessage(${message.id})" title="Resend">🔄</button>` : ''}
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading message history:', error);
        document.getElementById('message-history-table-body').innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #ef4444; padding: 3rem;">
                    Error loading message history
                </td>
            </tr>
        `;
    }
}

function getMessageStatusBadge(status) {
    switch (status) {
        case 'sent':
            return '<span class="message-status sent">SENT</span>';
        case 'pending':
            return '<span class="message-status pending">PENDING</span>';
        case 'failed':
            return '<span class="message-status failed">FAILED</span>';
        default:
            return '<span class="message-status pending">UNKNOWN</span>';
    }
}

function viewMessage(id) {
    toastInfo('View Message', `View message ID: ${id}. Modal akan segera ditambahkan!`);
}

function resendMessage(id) {
    if (confirm('Kirim ulang pesan ini?')) {
        toastInfo('Resend Message', `Resend message ID: ${id}. Feature akan segera ditambahkan!`);
    }
}

      async function loadApiSettings() {
    try {
        const data = await apiCall('system_settings');
        
        // Populate form fields
        if (data.fonnte_api_key) {
            document.getElementById('fonnte-api-key').value = data.fonnte_api_key;
        }
        if (data.whatsapp_device) {
            document.getElementById('whatsapp-device').value = data.whatsapp_device;
        }
        
        // Set auto send radio
        const autoSend = data.auto_send_notifications === true || data.auto_send_notifications === 'true';
        document.querySelector(`input[name="auto-send"][value="${autoSend}"]`).checked = true;
        
    } catch (error) {
        console.error('Error loading API settings:', error);
        toastError('Error', 'Gagal memuat settings');
    }
}

  async function testConnection() {
    const connectionStatus = document.getElementById('connection-status');
    
    if (!connectionStatus) {
        console.error('Element connection-status not found!');
        toastError('Error', 'Element connection-status tidak ditemukan!');
        return;
    }
    
    console.log('Element found, starting test...');
    
    connectionStatus.style.display = 'block';
    connectionStatus.innerHTML = 'Testing...';
    
    try {
        const result = await fetch('templates.php?action=test_connection');
        const data = await result.json();
        
        console.log('API result:', data);
        
        if (data.success) {
            connectionStatus.innerHTML = '✅ Connection successful!';
            toastSuccess('Success', 'Koneksi berhasil!');
        } else {
            connectionStatus.innerHTML = '❌ Connection failed: ' + (data.error || 'Unknown error');
            toastError('Failed', data.error || 'Koneksi gagal');
        }
        
    } catch (error) {
        console.error('Test error:', error);
        connectionStatus.innerHTML = '❌ Error: ' + error.message;
        toastError('Error', error.message);
    }
}

        async function sendAutoNotification(orderId, status) {
    try {
        // Cari order data
        const orderData = orders.find(o => o.id == orderId);
        if (!orderData) {
            console.log('Order not found for notification');
            return;
        }
        
        // Check if order has resi number for shipping notifications
        if ((status === 'shipped' || status === 'delivered') && !orderData.resi_number) {
            toastWarning('No Tracking Number', 'Order belum ada resi number, notifikasi di-skip');
            return;
        }
        
        // Prepare notification data
        const notificationData = {
            order_id: orderData.order_id,
            customer_id: orderData.customer_id,
            customer_name: orderData.customer_name,
            phone: orderData.no_hp,
            status: status,
            resi_number: orderData.resi_number,
            kurir: orderData.kurir,
            product_name: orderData.nama_barang
        };
        
        // Send via templates.php
        const result = await apiCall('send_notification', 'POST', notificationData);
        
        if (result.success) {
            toastSuccess('Notification Sent', `WhatsApp notification sent to ${orderData.customer_name}!`);
        } else {
            toastWarning('Notification Failed', result.error || 'Gagal kirim notifikasi WhatsApp');
        }
        
    } catch (error) {
        console.error('Auto notification error:', error);
        toastError('Notification Error', 'Gagal kirim auto notification');
    }
}
        
        // === TEMPLATE HELPER FUNCTIONS ===
function extractVariables(template) {
    const regex = /{([^}]+)}/g;
    const variables = {};
    let match;
    
    while ((match = regex.exec(template)) !== null) {
        variables[match[1]] = 'string';
    }
    
    return variables;
}

async function deleteTemplate(id) {
    if (confirm('Yakin ingin menghapus template ini?')) {
        try {
            const result = await fetch(`templates.php?action=message_template&id=${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await result.json();
            
            if (data.success) {
                toastSuccess('Template Deleted', 'Template berhasil dihapus!');
                loadMessageTemplates();
            } else {
                toastError('Delete Failed', data.error || 'Gagal menghapus template');
            }
        } catch (error) {
            toastError('Network Error', error.message);
        }
    }
}

async function editTemplate(id) {
    try {
        // Load template data
        const templates = await apiCall('message_templates');
        const template = templates.find(t => t.id == id);
        
        if (!template) {
            toastError('Error', 'Template tidak ditemukan!');
            return;
        }
        
        // Populate form dengan data existing
        document.getElementById('template-name').value = template.name;
        document.getElementById('template-type').value = template.type;
        document.getElementById('template-content').value = template.template;
        document.getElementById('template-description').value = template.description || '';
        
        // Add hidden field untuk ID
        let hiddenId = document.getElementById('edit-template-id');
        if (!hiddenId) {
            hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.id = 'edit-template-id';
            document.getElementById('add-template-form').appendChild(hiddenId);
        }
        hiddenId.value = template.id;
        
        // Change modal title
        document.querySelector('#add-template-modal h3').textContent = 'Edit Template Pesan';
        
        // Show modal
        document.getElementById('add-template-modal').style.display = 'block';
        
    } catch (error) {
        toastError('Error', 'Gagal memuat data template');
    }
}
        

        // ===========================================
        // EVENT LISTENERS & INITIALIZATION
        // ===========================================
        
       document.addEventListener('DOMContentLoaded', function() {
    // === WELCOME TOAST DYNAMIC GREETING ===
    setTimeout(() => {
        const currentTime = new Date().getHours();
        let greeting = 'Selamat Datang!';
        let icon = '👋';
        
        if (currentTime < 10) {
            greeting = 'Selamat Pagi!';
            icon = '☀️';
        } else if (currentTime < 15) {
            greeting = 'Selamat Siang!';
            icon = '🌤️';
        } else if (currentTime < 18) {
            greeting = 'Selamat Sore!';
            icon = '🌅';
        } else {
            greeting = 'Selamat Malam!';
            icon = '🌙';
        }
        
        toastInfo(`${greeting} ${icon}`, 'CHEMZ Shop siap membantu manajemen bisnis Anda');
    }, 1200);

    // === LOAD INITIAL DATA ===
    loadDashboardData();
    loadCustomersForSelect();
    loadProductsForSelect();
    loadProductsForMovementSelect();

    // === RESI AUTO DETECTION EVENT LISTENER ===
    const resiInput = document.getElementById('order-resi');
    if (resiInput) {
        resiInput.addEventListener('blur', function() {
            const resiNumber = this.value.trim();
            if (resiNumber) {
                autoDetectCourier(resiNumber, 'order-kurir');
            }
        });
    }

    // === ADD PRODUCT FORM ===
    const addProductForm = document.getElementById('add-product-form');
    if (addProductForm) {
        addProductForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const isEdit = document.getElementById('edit-product-id');
            
            // Ambil data dari form
            const data = {
                sku: document.getElementById('new-product-sku').value,
                nama_barang: document.getElementById('new-product-name').value,
                unit: document.getElementById('new-product-unit').value,
                harga_beli: parseFloat(document.getElementById('new-product-price').value),
                stock_current: parseInt(document.getElementById('new-product-stock').value) || 0
            };
            
            // Validasi
            if (!data.sku || !data.nama_barang || !data.harga_beli) {
                toastError('Validasi Error', 'SKU, Nama Barang, dan Harga harus diisi!');
                return;
            }
            
            try {
                let result;
                if (isEdit && isEdit.value) {
                    // Mode EDIT
                    data.id = parseInt(isEdit.value);
                    result = await apiCall('product', 'PUT', data);
                    if (result.success) {
                        toastSuccess('Update Berhasil', 'Produk berhasil diupdate!');
                    }
                } else {
                    // Mode ADD
                    data.stock_awal = data.stock_current; // Untuk mode add
                    result = await apiCall('product', 'POST', data);
                    if (result.success) {
                        toastSuccess('Berhasil Ditambahkan', 'Produk berhasil ditambahkan ke inventory!');
                    }
                }
                
                if (result.success) {
                    closeAddProductModal();
                    loadProducts();
                    loadProductsForSelect();
                    loadProductsForMovementSelect(); // Update movement dropdown juga
                } else {
                    toastError('Gagal Menyimpan', result.error || 'Gagal menyimpan produk');
                }
            } catch (error) {
                toastError('Network Error', error.message);
            }
        });
    }
    
    // === API SETTINGS FORM ===
const apiSettingsForm = document.getElementById('api-settings-form');
if (apiSettingsForm) {
    apiSettingsForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const data = {
            fonnte_api_key: document.getElementById('fonnte-api-key').value,
            whatsapp_device: document.getElementById('whatsapp-device').value,
            auto_send_notifications: document.querySelector('input[name="auto-send"]:checked').value === 'true'
        };
        
        try {
            const result = await apiCall('system_settings', 'PUT', data);
            if (result.success) {
                toastSuccess('Settings Saved', 'API settings berhasil disimpan!');
            } else {
                toastError('Save Failed', result.error || 'Gagal menyimpan settings');
            }
        } catch (error) {
            toastError('Network Error', error.message);
        }
    });
}

// === ADD TEMPLATE FORM ===
const addTemplateForm = document.getElementById('add-template-form');
if (addTemplateForm) {
    addTemplateForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const isEdit = document.getElementById('edit-template-id');
        
        const data = {
            name: document.getElementById('template-name').value,
            type: document.getElementById('template-type').value,
            template: document.getElementById('template-content').value,
            description: document.getElementById('template-description').value,
            variables: extractVariables(document.getElementById('template-content').value),
            is_active: true
        };
        
        try {
            let result;
            if (isEdit && isEdit.value) {
                // Edit mode
                data.id = parseInt(isEdit.value);
                result = await fetch(`templates.php?action=message_template`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                result = await result.json();
                
                if (result.success) {
                    toastSuccess('Template Updated', 'Template berhasil diupdate!');
                }
            } else {
                // Create mode
                result = await apiCall('message_template', 'POST', data);
                if (result.success) {
                    toastSuccess('Template Created', 'Template berhasil dibuat!');
                }
            }
            
            if (result.success) {
                closeAddTemplateModal();
                loadMessageTemplates();
            } else {
                toastError('Save Failed', result.error || 'Gagal menyimpan template');
            }
        } catch (error) {
            toastError('Network Error', error.message);
        }
    });
}

    
// === ADD CUSTOMER FORM ===
    const addCustomerForm = document.getElementById('add-customer-form');
    if (addCustomerForm) {
        addCustomerForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                nama: document.getElementById('new-customer-name').value,
                no_hp: document.getElementById('new-customer-phone').value,
                alamat: document.getElementById('new-customer-address').value,
                platform: document.getElementById('new-customer-platform').value
            };
            
            try {
                const result = await apiCall('customer', 'POST', data);
                if (result.success) {
                    toastSuccess('Customer Ditambahkan', 'Customer berhasil ditambahkan ke database!');
                    closeAddCustomerModal();
                    loadCustomersForSelect();
                    loadCustomers();
                } else {
                    toastError('Gagal Menambah Customer', result.error || 'Gagal menambah customer');
                }
            } catch (error) {
                toastError('Network Error', error.message);
            }
        });
    }

    
   
// === ORDER FORM EVENT LISTENER ===
// === ORDER FORM EVENT LISTENER ===
const orderForm = document.getElementById('order-form');
if (orderForm) {
    orderForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            customer_id: document.getElementById('customer-select').value,
            product_id: document.getElementById('product-select').value,
            qty: parseInt(document.getElementById('order-qty').value),
            harga_jual: parseFloat(document.getElementById('order-price').value),
            resi_number: document.getElementById('order-resi').value || null,
            kurir: document.getElementById('order-kurir').value || null,
            platform: document.getElementById('order-platform').value
        };
        
        try {
            const result = await apiCall('order', 'POST', formData);
            
            if (result.success) {
                // ✅ AUTO RESI TRACKING
                // Jika ada resi_number, otomatis add ke tracking system
                if (formData.resi_number && formData.resi_number.trim() !== '') {
                    try {
                        // 1. Detect kurir dari resi number
                        const detectedKurir = detectEkspedisi(formData.resi_number);
                        
                        // 2. Prepare resi data untuk tracking system
                        const now = new Date();
                        const resiData = {
                            no_resi: formData.resi_number.trim(),
                            ekspedisi: detectedKurir,
                            tanggal: now.toISOString().split('T')[0],
                            jam: now.toTimeString().split(' ')[0],
                            status: 'pending'
                        };
                        
                        // 3. Save ke tracking system
                        await saveResiToDatabase(formData.resi_number.trim(), detectedKurir);
                        
                        // 4. Success notification untuk order + resi
                        toastSuccess('Order Berhasil', 
                            `Order berhasil dibuat! Order ID: ${result.order_id}`);
                        toastInfo('Resi Added', 
                            `Resi ${formData.resi_number} (${detectedKurir}) ditambahkan ke tracking system!`);
                        
                    } catch (resiError) {
                        // Order sudah berhasil dibuat, tapi resi tracking gagal
                        console.error('Auto resi tracking error:', resiError);
                        
                        // Show success untuk order, warning untuk resi
                        toastSuccess('Order Berhasil', 
                            `Order berhasil dibuat! Order ID: ${result.order_id}`);
                        toastError('Resi Warning', 
                            `Gagal menambahkan resi ke tracking system: ${resiError.message}`);
                    }
                } else {
                    // Order berhasil tanpa resi
                    toastSuccess('Order Berhasil', 
                        `Order berhasil dibuat! Order ID: ${result.order_id}`);
                }
                
                // Reset form dan refresh data (tetap jalan meskipun resi tracking gagal)
                document.getElementById('order-form').reset();
                document.getElementById('profit-preview').style.display = 'none';
                loadOrders();
                loadDashboardData();
                loadOrdersHistory();
                loadProductsForSelect();
                
            } else {
                toastError('Gagal Membuat Order', result.error || 'Gagal membuat order');
            }
        } catch (error) {
            toastError('Network Error', error.message);
        }
    });
}

    // === PROFIT PREVIEW EVENT LISTENERS ===
    const productSelect = document.getElementById('product-select');
    const orderQty = document.getElementById('order-qty');
    const orderPrice = document.getElementById('order-price');
    
    if (productSelect) productSelect.addEventListener('change', updateProfitPreview);
    if (orderQty) orderQty.addEventListener('input', updateProfitPreview);
    if (orderPrice) orderPrice.addEventListener('input', updateProfitPreview);

    // === FILTER LAPORAN STOCK EVENT LISTENERS ===
    setTimeout(() => {
        const laporanSearch = document.getElementById('laporan-search');
        const statusFilter = document.getElementById('status-filter');
        const rangeFilter = document.getElementById('range-filter');

        console.log('Attaching filter events...');
        
        if (laporanSearch) {
            laporanSearch.addEventListener('input', function() {
                console.log('Search changed:', this.value);
                filterLaporanStock();
            });
        }
        
        if (statusFilter) {
            statusFilter.addEventListener('change', function() {
                console.log('Status filter changed:', this.value);
                filterLaporanStock();
            });
        }
        
        if (rangeFilter) {
            rangeFilter.addEventListener('change', function() {
                console.log('Range filter changed:', this.value);
                filterLaporanStock();
            });
        }
        
        console.log('Filter events attached successfully!');
    }, 1000);
    
    // === USER SETTINGS FORM === 
    const userSettingsForm = document.getElementById('user-settings-form');
    if (userSettingsForm) {
        userSettingsForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                user_name: document.getElementById('user-name').value,
                device_name: document.getElementById('device-name').value
            };
            
            try {
                const response = await fetch('https://ersetsolution.my.id/autocheck.php?action=user_settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    toastSuccess('Settings Saved', 'User settings berhasil disimpan!');
                } else {
                    toastError('Save Failed', result.error || 'Gagal menyimpan settings');
                }
            } catch (error) {
                toastError('Network Error', error.message);
            }
        });
    }

    // === ADD MOVEMENT FORM ===
    const addMovementForm = document.getElementById('add-movement-form');
    if (addMovementForm) {
        addMovementForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const productId = document.getElementById('movement-product-select').value;
            const movementType = document.querySelector('input[name="movement-type"]:checked')?.value;
            const qty = parseInt(document.getElementById('movement-qty').value);
            const notes = document.getElementById('movement-notes').value;
            
            if (!productId || !movementType || !qty) {
                toastError('Validasi Error', 'Product, Type, dan Qty harus diisi!');
                return;
            }
            
            const data = {
                product_id: productId,
                type: movementType,
                qty: qty,
                notes: notes,
                created_by: 'Admin'
            };
            
            try {
                const result = await apiCall('stock_movement', 'POST', data);
                if (result.success) {
                    toastSuccess('Movement Added', 'Stock movement berhasil ditambahkan!');
                    closeAddMovementModal();
                    loadStockMovements();
                    loadProducts();
                    loadProductsForSelect();
                    loadProductsForMovementSelect();
                } else {
                    toastError('Gagal Menambah Movement', result.error || 'Gagal menambah stock movement');
                }
            } catch (error) {
                toastError('Network Error', error.message);
            }
        });
    }
    
    // === RESI MANAGEMENT EVENT LISTENERS (NEW) ===
    const resiSearch = document.getElementById('resi-search');
    const resiStatusFilter = document.getElementById('resi-status-filter');
    const resiKurirFilter = document.getElementById('resi-kurir-filter');
    
    if (resiSearch) {
        resiSearch.addEventListener('input', filterResiTable);
    }
    if (resiStatusFilter) {
        resiStatusFilter.addEventListener('change', filterResiTable);
    }
    if (resiKurirFilter) {
        resiKurirFilter.addEventListener('change', filterResiTable);
    }
    
    // Checkbox change listener for bulk actions
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('resi-checkbox')) {
            updateBulkActionButtons();
        }
        
    });
    

}); // ← PENUTUP DOMContentLoaded


/**
 * Update product stock_current di database berdasarkan movements
 */
async function updateProductStockInDatabase(productId) {
    try {
        console.log(`🔄 Updating stock for product ID: ${productId}`);
        
        // Get movements dan product data
        const [movementsData, productsData] = await Promise.all([
            apiCall('stock_movements'),
            apiCall('products')
        ]);
        
        const movements = Array.isArray(movementsData) ? movementsData : [];
        const products = Array.isArray(productsData) ? productsData : [];
        
        const product = products.find(p => p.id == productId);
        if (!product) {
            console.error('Product not found:', productId);
            return;
        }
        
        // Filter movements untuk produk ini
        const productMovements = movements.filter(m => m.product_id == productId);
        
        // Hitung stock real-time
        const stockIn = productMovements
            .filter(m => m.type === 'in')
            .reduce((sum, m) => sum + parseInt(m.qty), 0);
        const stockOut = productMovements
            .filter(m => m.type === 'out')
            .reduce((sum, m) => sum + parseInt(m.qty), 0);
        
        const newStock = parseInt(product.stock_awal) + stockIn - stockOut;
        
        console.log(`📊 Stock calculation: ${product.stock_awal} + ${stockIn} - ${stockOut} = ${newStock}`);
        
        // ✅ UPDATE pakai API yang udah ada
        const result = await apiCall('product', 'PUT', {
            id: productId,
            sku: product.sku,
            nama_barang: product.nama_barang,
            unit: product.unit,
            harga_beli: product.harga_beli,
            stock_current: newStock // ← INI yang di-update
        });
        
        if (result.success) {
            console.log(`✅ Database updated: ${product.nama_barang} stock = ${newStock}`);
            return newStock;
        } else {
            console.error('Failed to update stock:', result.error);
        }
        
    } catch (error) {
        console.error('Error updating product stock:', error);
    }
}

// === DELETE STOCK MOVEMENT FUNCTION ===
async function deleteStockMovement(id) {
    if (confirm('Yakin ingin menghapus stock movement ini?')) {
        try {
            const result = await apiCall(`stock_movement&id=${id}`, 'DELETE');
            if (result.success) {
                toastSuccess('Movement Deleted', 'Stock Out berhasil dihapus!');
                loadStockMovements();
                loadProducts();
            } else {
                toastError('Gagal Menghapus', result.error || 'Gagal menghapus movement');
            }
        } catch (error) {
            toastError('Network Error', error.message);
        }
    }
}

// ===========================================
// RESI MANAGEMENT FUNCTIONS (NEW)
// ===========================================

/**
 * Switch resi tabs
 */
function switchResiTab(tabId, element) {
    // Hide all resi tab contents
    document.querySelectorAll('.resi-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all resi tab buttons
    document.querySelectorAll('#resi-management-page .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`resi-tab-${tabId}`).classList.add('active');
    element.classList.add('active');
    
    // Load data berdasarkan tab
    loadResiTabData(tabId);
}

/**
 * Load resi management data
 */
/**
 * Load resi management data - FIXED API Response Structure
 */
async function loadResiManagementData() {
    try {
        console.log('🔄 Loading resi management data...');
        const result = await apiCall('tracking_resi');
        
        console.log('📡 Raw API response:', result);
        
        // ✅ FIX: Handle API response structure properly
        let data = [];
        if (result && result.success && Array.isArray(result.data)) {
            // API returns: {success: true, data: [...]}
            data = result.data;
        } else if (Array.isArray(result)) {
            // API returns: [...]
            data = result;
        } else {
            console.log('⚠️ Unexpected API response structure:', result);
            updateResiCounts(0, 0, 0);
            return;
        }
        
        console.log('📊 Processed data:', data.length, 'items');
        
        if (data.length === 0) {
            console.log('📭 No resi data found');
            updateResiCounts(0, 0, 0);
            return;
        }
        
        console.log('📋 All resi statuses:', data.map(r => `${r.no_resi}: ${r.status}`));
        
        // ✅ FIX: Count by status - include 'shipped' di proses
        const prosesCount = data.filter(r => 
            r.status === 'pending' || 
            r.status === 'on_process' || 
            r.status === 'shipped'
        ).length;
        
        const deliveredCount = data.filter(r => r.status === 'delivered').length;
        const returnCount = data.filter(r => r.status === 'return' || r.status === 'error').length;
        
        console.log('📈 Calculated counts:', { prosesCount, deliveredCount, returnCount });
        
        // Update tab counters
        updateResiCounts(prosesCount, deliveredCount, returnCount);
        
        // Store global data
        window.resiData = data;
        console.log('💾 Stored to window.resiData:', window.resiData.length, 'items');
        
        // Load current tab data
        const activeTab = document.querySelector('#resi-management-page .tab-btn.active');
        if (activeTab) {
            let tabId = 'proses'; // default
            try {
                const match = activeTab.onclick.toString().match(/switchResiTab\('([^']+)'/);
                if (match && match[1]) {
                    tabId = match[1];
                }
            } catch (e) {
                console.log('⚠️ Using default tabId:', tabId);
            }
            
            console.log('🎯 Loading tab data for:', tabId);
            loadResiTabData(tabId);
        } else {
            console.log('⚠️ No active tab found, loading default proses tab');
            loadResiTabData('proses');
        }
        
    } catch (error) {
        console.error('❌ Error loading resi data:', error);
        updateResiCounts(0, 0, 0);
    }
}

/**
 * Update tab counters
 */
function updateResiCounts(proses, delivered, returnVal) {
    document.getElementById('tab-proses-count').textContent = proses;
    document.getElementById('tab-delivered-count').textContent = delivered;
    document.getElementById('tab-return-count').textContent = returnVal;
}

/**
 * Load specific tab data
 */
/**
 * Load specific tab data
 */
function loadResiTabData(tabId) {
    if (!window.resiData) {
        loadResiManagementData();
        return;
    }
    
    let filteredData = [];
    
    switch (tabId) {
        case 'proses':
            // ✅ FIX: Include 'shipped' status di tab proses
            filteredData = window.resiData.filter(r => 
                r.status === 'pending' || 
                r.status === 'on_process' || 
                r.status === 'shipped'
            );
            console.log('Proses tab data:', filteredData); // Debug log
            renderProsesTable(filteredData);
            break;
        case 'delivered':
            filteredData = window.resiData.filter(r => r.status === 'delivered');
            renderDeliveredTable(filteredData);
            break;
        case 'return':
            filteredData = window.resiData.filter(r => r.status === 'return' || r.status === 'error');
            renderReturnTable(filteredData);
            break;
    }
}

/**
 * Convert technical status ke user-friendly display
 */
function getStatusDisplayText(technicalStatus) {
    const statusMapping = {
        // Technical → User Friendly
        'pending': 'Menunggu Proses',
        'on_process': 'Sedang Dikirim', // ← INI YANG DIMAU
        'shipped': 'Sedang Dikirim',
        'delivered': 'Sudah Sampai',
        'return': 'Dikembalikan',
        'error': 'Error Tracking'
    };
    
    return statusMapping[technicalStatus] || technicalStatus.toUpperCase();
}

/**
 * Generate status badge dengan display text yang friendly
 */
function generateStatusBadge(technicalStatus) {
    const displayText = getStatusDisplayText(technicalStatus);
    let statusClass = 'pending'; // default
    
    // Map ke CSS class
    switch (technicalStatus) {
        case 'pending':
            statusClass = 'pending';
            break;
        case 'on_process':
        case 'shipped':
            statusClass = 'shipped'; // Biru
            break;
        case 'delivered':
            statusClass = 'delivered'; // Hijau
            break;
        case 'return':
        case 'error':
            statusClass = 'return'; // Merah
            break;
    }
    
    return `<span class="status ${statusClass}">${displayText}</span>`;
}

/**
 * Render proses table
 */
function renderProsesTable(data) {
    const tableBody = document.getElementById('proses-table-body');
    
    if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 3rem; color: #94a3b8;">Tidak ada resi dalam proses</td></tr>';
        return;
    }
    
    tableBody.innerHTML = data.map((item, index) => {
        const tanggal = new Date(item.tanggal).toLocaleDateString('id-ID');
        const kurirBadge = generateCourierBadge(item.ekspedisi);
        
        // ✅ FIX: Gunakan display text yang friendly
        const statusBadge = generateStatusBadge(item.status);
        
        return `
            <tr>
                <td><input type="checkbox" class="resi-checkbox" value="${item.id}" style="accent-color: #3b82f6;"></td>
                <td>${index + 1}</td>
                <td>${tanggal}</td>
                <td style="font-family: monospace; font-weight: 600;">${item.no_resi}</td>
                <td>${kurirBadge}</td>
                <td>${item.jam}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn-icon" onclick="checkResiBinderbyte('${item.id}')" title="Check Status">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 4v6h6"/>
                            <path d="M23 20v-6h-6"/>
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                        </svg>
                    </button>
                    <button class="btn-icon" onclick="viewResiDetail('${item.id}')" title="View Detail">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

/**
 * Render delivered table
 */
function renderDeliveredTable(data) {
    const tableBody = document.getElementById('delivered-table-body');
    
    if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 3rem; color: #94a3b8;">Tidak ada resi delivered</td></tr>';
        return;
    }
    
    tableBody.innerHTML = data.map((item, index) => {
        const tanggal = new Date(item.tanggal).toLocaleDateString('id-ID');
        const kurirBadge = generateCourierBadge(item.ekspedisi);
        const statusBadge = `<span class="status delivered">DELIVERED</span>`;
        
        // Parse response untuk dapat penerima & tgl diterima
        let penerima = '-';
        let tglDiterima = '-';
        
        if (item.binderbyte_response) {
            try {
                const responseData = JSON.parse(item.binderbyte_response);
                penerima = responseData.penerima || '-';
                tglDiterima = responseData.tgl_diterima || '-';
            } catch (e) {
                console.log('Error parsing response:', e);
            }
        }
        
        return `
            <tr>
                <td><input type="checkbox" class="resi-checkbox" value="${item.id}" style="accent-color: #3b82f6;"></td>
                <td>${index + 1}</td>
                <td>${tanggal}</td>
                <td style="font-family: monospace; font-weight: 600;">${item.no_resi}</td>
                <td>${kurirBadge}</td>
                <td>${statusBadge}</td>
                <td>${penerima}</td>
                <td style="font-family: monospace;">${tglDiterima}</td>
                <td>
                    <button class="btn-icon" onclick="viewResiDetail('${item.id}')" title="View Detail">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

/**
 * Render return table
 */
function renderReturnTable(data) {
    const tableBody = document.getElementById('return-table-body');
    
    if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 3rem; color: #94a3b8;">Tidak ada resi return</td></tr>';
        return;
    }
    
    tableBody.innerHTML = data.map((item, index) => {
        const tanggal = new Date(item.tanggal).toLocaleDateString('id-ID');
        const kurirBadge = generateCourierBadge(item.ekspedisi);
        const statusBadge = `<span class="status return">${item.status.toUpperCase()}</span>`;
        
        return `
            <tr>
                <td><input type="checkbox" class="resi-checkbox" value="${item.id}" style="accent-color: #3b82f6;"></td>
                <td>${index + 1}</td>
                <td>${tanggal}</td>
                <td style="font-family: monospace; font-weight: 600;">${item.no_resi}</td>
                <td>${kurirBadge}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn-icon" onclick="viewResiDetail('${item.id}')" title="View Detail">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// ===========================================
// BULK ACTIONS FUNCTIONS (NEW)
// ===========================================

/**
 * Toggle select all checkboxes
 */
function toggleSelectAllResi() {
    const activeTab = document.querySelector('#resi-management-page .tab-btn.active');
    if (!activeTab) return;
    
    const tabId = activeTab.onclick.toString().match(/switchResiTab\('([^']+)'/)[1];
    const selectAllCheckbox = document.getElementById(`select-all-${tabId}`);
    const resiCheckboxes = document.querySelectorAll(`#resi-tab-${tabId} .resi-checkbox`);
    
    resiCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateBulkActionButtons();
}

/**
 * Check selected resi via Binderbyte API
/**
 * Check selected resi with progress indicator
 */
async function checkSelectedResi() {
    const selectedCheckboxes = document.querySelectorAll('.resi-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        toastWarning('No Selection', 'Pilih resi yang ingin dicek terlebih dahulu!');
        return;
    }
    
    if (!confirm(`Yakin ingin check ${selectedCheckboxes.length} resi terpilih via Binderbyte API?\n\nProses ini akan memakan waktu ~${selectedCheckboxes.length} menit.`)) {
        return;
    }
    
    const startTime = Date.now();
    let successCount = 0;
    let errorCount = 0;
    let currentToast = null;
    
    // ✅ DISABLE BUTTONS selama proses
    const bulkButtons = document.querySelectorAll('button[onclick*="checkSelectedResi"], button[onclick*="checkAllResi"]');
    bulkButtons.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
    });
    
    try {
        for (let i = 0; i < selectedCheckboxes.length; i++) {
            const checkbox = selectedCheckboxes[i];
            const resiId = checkbox.value;
            const progress = i + 1;
            const total = selectedCheckboxes.length;
            const percentage = Math.round((progress / total) * 100);
            
            // ✅ SHOW PROGRESS dengan estimated time
            const elapsed = Math.round((Date.now() - startTime) / 1000);
            const avgTimePerResi = elapsed / Math.max(progress - 1, 1);
            const remaining = (total - progress) * avgTimePerResi;
            const eta = remaining > 0 ? `~${Math.round(remaining)}s remaining` : 'Almost done';
            
            // Remove previous toast dan show new progress
            if (currentToast) {
                removeToast(currentToast);
            }
            currentToast = toastInfo(
                `Processing ${progress}/${total} (${percentage}%)`, 
                `Checking resi... ${eta}`,
                10000 // Longer duration
            );
            
            try {
                await checkResiBinderbyte(resiId);
                successCount++;
                console.log(`✅ [${progress}/${total}] Resi ${resiId} checked successfully`);
                
            } catch (error) {
                console.error(`❌ [${progress}/${total}] Error checking resi ${resiId}:`, error);
                errorCount++;
            }
            
            // ✅ RATE LIMIT: 1 second delay (Binderbyte recommended)
            if (i < selectedCheckboxes.length - 1) { // Skip delay untuk item terakhir
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
        
        // ✅ FINAL RESULT dengan detailed stats
        const totalTime = Math.round((Date.now() - startTime) / 1000);
        
        if (currentToast) {
            removeToast(currentToast);
        }
        
        if (successCount > 0) {
            toastSuccess(
                'Bulk Check Complete! 🎉', 
                `✅ ${successCount} berhasil, ❌ ${errorCount} gagal\n⏱️ Selesai dalam ${totalTime} detik`
            );
        } else {
            toastError(
                'Bulk Check Failed! 😞', 
                `Semua ${errorCount} resi gagal dicek\n⏱️ Total waktu: ${totalTime} detik`
            );
        }
        
    } catch (error) {
        console.error('❌ Critical error in bulk check:', error);
        toastError('System Error', 'Terjadi error sistem saat bulk check');
        
    } finally {
        // ✅ RE-ENABLE BUTTONS
        bulkButtons.forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
        });
        
        // ✅ CLEANUP and REFRESH
        if (currentToast) {
            removeToast(currentToast);
        }
        
        // Refresh data dan uncheck all
        setTimeout(() => {
            loadResiManagementData();
            uncheckAllResi();
        }, 1500); // Sedikit delay biar user baca result toast
    }
}

/**
 * Check all resi in current tab
 */
/**
 * Check all resi in current tab with progress indicator
 */
async function checkAllResi() {
    const activeTab = document.querySelector('#resi-management-page .tab-btn.active');
    if (!activeTab) return;
    
    const tabId = activeTab.onclick.toString().match(/switchResiTab\('([^']+)'/)[1];
    const allCheckboxes = document.querySelectorAll(`#resi-tab-${tabId} .resi-checkbox`);
    
    if (allCheckboxes.length === 0) {
        toastWarning('No Data', 'Tidak ada resi untuk dicek di tab ini!');
        return;
    }
    
    // ✅ ENHANCED CONFIRMATION dengan estimasi waktu
    const estimatedMinutes = Math.ceil(allCheckboxes.length / 60); // 1 resi per detik
    if (!confirm(`Yakin ingin check SEMUA ${allCheckboxes.length} resi di tab ${tabId.toUpperCase()}?\n\n⏱️ Estimasi waktu: ~${estimatedMinutes} menit\n💡 Proses ini akan berjalan di background.`)) {
        return;
    }
    
    const startTime = Date.now();
    let successCount = 0;
    let errorCount = 0;
    let currentToast = null;
    
    // ✅ DISABLE ALL BULK BUTTONS
    const bulkButtons = document.querySelectorAll('button[onclick*="checkSelectedResi"], button[onclick*="checkAllResi"]');
    bulkButtons.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.textContent = btn.textContent.includes('Cek Semua') ? '⏳ Processing...' : btn.textContent;
    });
    
    try {
        for (let i = 0; i < allCheckboxes.length; i++) {
            const checkbox = allCheckboxes[i];
            const resiId = checkbox.value;
            const progress = i + 1;
            const total = allCheckboxes.length;
            const percentage = Math.round((progress / total) * 100);
            
            // ✅ CALCULATE ETA
            const elapsed = Math.round((Date.now() - startTime) / 1000);
            const avgTimePerResi = elapsed / Math.max(progress - 1, 1);
            const remainingItems = total - progress;
            const remainingTime = remainingItems * avgTimePerResi;
            const eta = remainingTime > 60 
                ? `~${Math.round(remainingTime / 60)}m ${Math.round(remainingTime % 60)}s remaining`
                : `~${Math.round(remainingTime)}s remaining`;
            
            // ✅ UPDATE PROGRESS TOAST
            if (currentToast) {
                removeToast(currentToast);
            }
            currentToast = toastInfo(
                `Bulk Check All: ${progress}/${total} (${percentage}%)`,
                `Tab ${tabId.toUpperCase()} • ${eta}\n✅ ${successCount} success • ❌ ${errorCount} failed`,
                15000 // Longer duration untuk bulk operation
            );
            
            try {
                await checkResiBinderbyte(resiId);
                successCount++;
                console.log(`✅ [${progress}/${total}] Tab ${tabId} - Resi ${resiId} checked successfully`);
                
            } catch (error) {
                console.error(`❌ [${progress}/${total}] Tab ${tabId} - Error checking resi ${resiId}:`, error);
                errorCount++;
            }
            
            // ✅ RATE LIMIT: 1 second delay
            if (i < allCheckboxes.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // ✅ PERIODIC REFRESH every 10 items untuk show intermediate results
            if (progress % 10 === 0 || progress === total) {
                loadResiManagementData();
            }
        }
        
        // ✅ FINAL RESULT dengan comprehensive stats
        const totalTime = Math.round((Date.now() - startTime) / 1000);
        const minutes = Math.floor(totalTime / 60);
        const seconds = totalTime % 60;
        const timeFormatted = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
        
        if (currentToast) {
            removeToast(currentToast);
        }
        
        if (successCount > 0) {
            toastSuccess(
                `Bulk Check All Complete! 🎉`,
                `Tab ${tabId.toUpperCase()}: ✅ ${successCount} berhasil, ❌ ${errorCount} gagal\n⏱️ Completed in ${timeFormatted}\n📊 Success rate: ${Math.round((successCount / allCheckboxes.length) * 100)}%`
            );
        } else {
            toastError(
                `Bulk Check All Failed! 😞`,
                `Tab ${tabId.toUpperCase()}: Semua ${errorCount} resi gagal dicek\n⏱️ Total time: ${timeFormatted}\n🔍 Periksa koneksi internet dan API key`
            );
        }
        
    } catch (error) {
        console.error('❌ Critical error in bulk check all:', error);
        toastError('System Error', `Error sistem saat bulk check tab ${tabId.toUpperCase()}`);
        
    } finally {
        // ✅ RE-ENABLE BUTTONS dan restore text
        bulkButtons.forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
            if (btn.textContent.includes('Processing')) {
                btn.textContent = '↻ Cek Semua';
            }
        });
        
        // ✅ CLEANUP
        if (currentToast) {
            removeToast(currentToast);
        }
        
        // ✅ FINAL REFRESH
        setTimeout(() => {
            loadResiManagementData();
        }, 2000); // Longer delay for user to read results
    }
}

/**
 * Uncheck all resi checkboxes
 */
function uncheckAllResi() {
    document.querySelectorAll('.resi-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    document.querySelectorAll('#resi-management-page input[id^="select-all-"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    updateBulkActionButtons();
}

/**
 * Update bulk action button states
 */
function updateBulkActionButtons() {
    const selectedCount = document.querySelectorAll('.resi-checkbox:checked').length;
    const cekTerpilihBtn = document.querySelector('button[onclick="checkSelectedResi()"]');
    
    if (cekTerpilihBtn) {
        if (selectedCount > 0) {
            cekTerpilihBtn.textContent = `✓ Cek Terpilih (${selectedCount})`;
            cekTerpilihBtn.style.background = '#22c55e';
        } else {
            cekTerpilihBtn.textContent = '✓ Cek Terpilih';
            cekTerpilihBtn.style.background = '#6b7280';
        }
    }
}
/**
 * Search and filter resi
 */
function filterResiTable() {
    // ✅ FIX: Check if user is on Resi Management page
    const currentPage = document.querySelector('.page.active')?.id;
    if (currentPage !== 'resi-management-page') {
        return; // Skip jika user di page lain
    }
    
    const searchInput = document.getElementById('resi-search');
    const statusFilter = document.getElementById('resi-status-filter');
    const kurirFilter = document.getElementById('resi-kurir-filter');
    
    if (!searchInput || !window.resiData) return;
    
    const searchValue = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;
    const kurirValue = kurirFilter.value;
    
    // ✅ FIX: Safe active tab detection with null check
    const activeTab = document.querySelector('#resi-management-page .tab-btn.active');
    if (!activeTab) return;
    
    // ✅ FIX: Safe regex extraction with fallback
    let tabId = 'proses'; // default fallback
    try {
        const match = activeTab.onclick.toString().match(/switchResiTab\('([^']+)'/);
        if (match && match[1]) {
            tabId = match[1];
        }
    } catch (error) {
        console.error('Error extracting tabId:', error);
        // Use fallback tabId = 'proses'
    }
    
    // Filter data
    let filteredData = window.resiData.filter(item => {
        // Tab filter
        let tabMatch = false;
        switch (tabId) {
            case 'proses':
                // ✅ FIX: Include 'shipped' status di tab proses
                tabMatch = item.status === 'pending' || item.status === 'on_process' || item.status === 'shipped';
                break;
            case 'delivered':
                tabMatch = item.status === 'delivered';
                break;
            case 'return':
                tabMatch = item.status === 'return' || item.status === 'error';
                break;
        }
        
        // Search filter
        const searchMatch = searchValue === '' || 
            item.no_resi.toLowerCase().includes(searchValue) ||
            item.ekspedisi.toLowerCase().includes(searchValue);
        
        // Status filter
        const statusMatch = statusValue === '' || item.status === statusValue;
        
        // Kurir filter
        const kurirMatch = kurirValue === '' || item.ekspedisi === kurirValue;
        
        return tabMatch && searchMatch && statusMatch && kurirMatch;
    });
    
    // Render filtered data
    switch (tabId) {
        case 'proses':
            renderProsesTable(filteredData);
            break;
        case 'delivered':
            renderDeliveredTable(filteredData);
            break;
        case 'return':
            renderReturnTable(filteredData);
            break;
    }
}

/**
 * Send auto WhatsApp notification when resi status changes
 * @param {string} resiId - ID dari tracking_resi
 * @param {string} newStatus - Status baru (shipped/delivered)
 */
async function sendAutoWhatsAppNotification(resiId, newStatus) {
    try {
        console.log(`🔄 [DEBUG] Starting auto notification...`);
        console.log(`📋 [DEBUG] Resi ID: ${resiId}, Status: ${newStatus}`);
        
        // ✅ FIX: Tambah on_process ke notification
        const notificationStatuses = ['shipped', 'delivered', 'on_process'];
        
        if (!notificationStatuses.includes(newStatus)) {
            console.log(`📱 [DEBUG] Skip notification for status: ${newStatus}`);
            return;
        }
        
        // ✅ Map status untuk template
        let templateStatus = newStatus;
        if (newStatus === 'on_process') {
            templateStatus = 'shipped'; // Gunakan template shipped untuk on_process
            console.log(`📝 [DEBUG] Mapping on_process → shipped template`);
        }
        
        console.log(`📝 [DEBUG] Using template status: ${templateStatus}`);
        
        // ✅ STEP 2: Get resi data
        console.log(`🔍 [DEBUG] Getting resi data...`);
        const resiData = await getResiDataById(resiId);
        console.log(`📦 [DEBUG] Resi data:`, resiData);
        
        if (!resiData) {
            console.error('❌ [DEBUG] Resi data not found');
            return;
        }
        
        // ✅ STEP 3: Find related order
        console.log(`🔍 [DEBUG] Finding order by resi: ${resiData.no_resi}`);
        const orderData = await findOrderByResi(resiData.no_resi);
        console.log(`📋 [DEBUG] Order data:`, orderData);
        
        if (!orderData) {
            console.warn(`⚠️ [DEBUG] No order found for resi: ${resiData.no_resi}`);
            toastWarning('No Order Found', `Resi ${resiData.no_resi} tidak terhubung dengan order`);
            return;
        }
        
        // ✅ STEP 4: Get customer data
        console.log(`🔍 [DEBUG] Getting customer: ${orderData.customer_id}`);
        const customerData = await getCustomerById(orderData.customer_id);
        console.log(`👤 [DEBUG] Customer data:`, customerData);
        
        if (!customerData || !customerData.no_hp) {
            console.warn('⚠️ [DEBUG] Customer phone not found');
            toastWarning('No Phone Number', 'Customer tidak memiliki nomor telepon');
            return;
        }
        
        // ✅ STEP 5: Prepare notification data
        const notificationData = {
            order_id: orderData.order_id,
            customer_id: orderData.customer_id,
            customer_name: customerData.nama,
            phone: customerData.no_hp,
            status: templateStatus, // ← Gunakan mapped status
            resi_number: resiData.no_resi,
            kurir: resiData.ekspedisi,
            product_name: orderData.nama_barang || 'Product'
        };
        
        console.log(`📱 [DEBUG] Sending notification data:`, notificationData);
        
        // ✅ STEP 6: Send notification
        const result = await apiCall('send_notification', 'POST', notificationData);
        console.log(`📱 [DEBUG] Send result:`, result);
        
        if (result.success) {
            toastSuccess('📱 WhatsApp Sent!', `Notification sent to ${customerData.nama}`);
            console.log('✅ [DEBUG] WhatsApp notification sent successfully');
        } else {
            toastWarning('📱 Send Failed', result.error || 'Gagal kirim WhatsApp');
            console.error('❌ [DEBUG] WhatsApp send failed:', result.error);
        }
        
    } catch (error) {
        console.error('❌ [DEBUG] Auto notification error:', error);
        toastError('Notification Error', 'Gagal kirim auto WhatsApp');
    }
}

/**
 * Find order by resi number
 */
async function findOrderByResi(resiNumber) {
    try {
        const ordersData = await apiCall('orders');
        if (Array.isArray(ordersData)) {
            return ordersData.find(order => order.resi_number === resiNumber);
        }
        return null;
    } catch (error) {
        console.error('Error finding order by resi:', error);
        return null;
    }
}

/**
 * Get customer by ID
 */
async function getCustomerById(customerId) {
    try {
        const customersData = await apiCall('customers');
        if (Array.isArray(customersData)) {
            return customersData.find(customer => customer.id == customerId);
        }
        return null;
    } catch (error) {
        console.error('Error getting customer:', error);
        return null;
    }
}

    </script>
</body>
</html>
   
